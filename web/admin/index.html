<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Admin Panel</title>
  <link rel="stylesheet" href="/css/global.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/admin.css">
  <script src="/js/theme.js"></script>
</head>
<body>
  <div class="admin-layout">
    <aside class="admin-sidebar" id="admin-sidebar"></aside>

    <main class="admin-main">
      <header class="admin-header" id="admin-header"></header>

      <div class="admin-content">
        <div class="admin-page-header">
          <h1 class="admin-page-title">Dashboard</h1>
          <p class="admin-page-subtitle">Welcome back! Here's what's happening with your platform.</p>
        </div>

        <!-- Stats Grid -->
        <div class="admin-stats-grid">
          <div class="admin-stat-card">
            <div class="admin-stat-header">
              <div class="admin-stat-icon primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="9" cy="7" r="4"></circle>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
              </div>
              <span class="admin-stat-change positive" id="stat-users-change">+0%</span>
            </div>
            <div class="admin-stat-value" id="stat-total-users">0</div>
            <div class="admin-stat-label">Total Users</div>
          </div>

          <div class="admin-stat-card">
            <div class="admin-stat-header">
              <div class="admin-stat-icon secondary">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                </svg>
              </div>
              <span class="admin-stat-change positive" id="stat-active-change">+0%</span>
            </div>
            <div class="admin-stat-value" id="stat-active-users">0</div>
            <div class="admin-stat-label">Active Today</div>
          </div>

          <div class="admin-stat-card">
            <div class="admin-stat-header">
              <div class="admin-stat-icon accent">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                  <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
              </div>
            </div>
            <div class="admin-stat-value" id="stat-total-stores">0</div>
            <div class="admin-stat-label">Total Stores</div>
          </div>

          <div class="admin-stat-card">
            <div class="admin-stat-header">
              <div class="admin-stat-icon gray">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="1" x2="12" y2="23"></line>
                  <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                </svg>
              </div>
              <span class="admin-stat-change positive" id="stat-prices-change">+0</span>
            </div>
            <div class="admin-stat-value" id="stat-prices-today">0</div>
            <div class="admin-stat-label">Prices Today</div>
          </div>
        </div>

        <!-- Quick Actions -->
        <h2 style="font-size: var(--text-lg); font-weight: var(--font-semibold); margin-bottom: var(--space-4); color: var(--color-gray-900);">Quick Actions</h2>
        <div class="admin-actions-grid">
          <a href="/admin/users/" class="admin-action-card">
            <div class="admin-action-icon" style="background: var(--color-primary-100); color: var(--color-primary-600);">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="8.5" cy="7" r="4"></circle>
                <line x1="20" y1="8" x2="20" y2="14"></line>
                <line x1="23" y1="11" x2="17" y2="11"></line>
              </svg>
            </div>
            <div class="admin-action-content">
              <div class="admin-action-title">Create User</div>
              <div class="admin-action-desc">Add a new user account</div>
            </div>
          </a>

          <a href="/admin/stores/" class="admin-action-card">
            <div class="admin-action-icon" style="background: var(--color-secondary-100); color: var(--color-secondary-600);">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
              </svg>
            </div>
            <div class="admin-action-content">
              <div class="admin-action-title">Manage Stores</div>
              <div class="admin-action-desc">View and edit stores</div>
            </div>
          </a>

          <a href="/admin/reports/" class="admin-action-card">
            <div class="admin-action-icon" style="background: var(--color-accent-100); color: var(--color-accent-600);">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
              </svg>
            </div>
            <div class="admin-action-content">
              <div class="admin-action-title">View Reports</div>
              <div class="admin-action-desc">Review user reports</div>
            </div>
          </a>

          <a href="/admin/settings/" class="admin-action-card">
            <div class="admin-action-icon" style="background: var(--color-gray-100); color: var(--color-gray-600);">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
              </svg>
            </div>
            <div class="admin-action-content">
              <div class="admin-action-title">Settings</div>
              <div class="admin-action-desc">Configure system options</div>
            </div>
          </a>
        </div>

        <!-- Two Column Layout -->
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--space-6); margin-top: var(--space-6);">
          <!-- Recent Users -->
          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">Recent Users</h3>
              <a href="/admin/users/" class="btn btn-secondary btn-sm">View All</a>
            </div>
            <div class="admin-table-wrapper">
              <table class="admin-table">
                <thead>
                  <tr>
                    <th>User</th>
                    <th>Role</th>
                    <th>Joined</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="recent-users-tbody">
                  <tr>
                    <td colspan="4" style="text-align: center; padding: var(--space-8); color: var(--color-gray-500);">Loading...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- System Health -->
          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">System Health</h3>
            </div>
            <div class="admin-card-body">
              <div style="display: flex; flex-direction: column; gap: var(--space-4);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="font-size: var(--text-sm); color: var(--color-gray-600);">Database</span>
                  <span class="badge badge-success">Healthy</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="font-size: var(--text-sm); color: var(--color-gray-600);">API Server</span>
                  <span class="badge badge-success">Online</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="font-size: var(--text-sm); color: var(--color-gray-600);">Total Items</span>
                  <span style="font-size: var(--text-sm); font-weight: var(--font-semibold);" id="stat-total-items">0</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="font-size: var(--text-sm); color: var(--color-gray-600);">Total Prices</span>
                  <span style="font-size: var(--text-sm); font-weight: var(--font-semibold);" id="stat-total-prices">0</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="font-size: var(--text-sm); color: var(--color-gray-600);">Verified Stores</span>
                  <span style="font-size: var(--text-sm); font-weight: var(--font-semibold);" id="stat-verified-stores">0</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="/js/api.js"></script>
  <script src="/js/auth.js"></script>
  <script src="/js/admin-common.js"></script>
  <script src="/js/admin-sidebar.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      if (!await admin.init()) return;

      initAdminSidebar('dashboard');
      document.getElementById('admin-header').innerHTML = renderAdminHeader([
        { label: 'Admin', href: '/admin/' },
        { label: 'Dashboard', href: '/admin/' }
      ]);

      await Promise.all([
        loadStats(),
        loadRecentUsers()
      ]);
    });

    async function loadStats() {
      try {
        const response = await adminApi.getStats();
        const stats = response?.data || response;

        document.getElementById('stat-total-users').textContent = admin.formatNumber(stats.total_users || 0);
        document.getElementById('stat-active-users').textContent = admin.formatNumber(stats.active_users_24h || 0);
        document.getElementById('stat-total-stores').textContent = admin.formatNumber(stats.total_stores || 0);
        document.getElementById('stat-prices-today').textContent = admin.formatNumber(stats.prices_today || 0);
        document.getElementById('stat-total-items').textContent = admin.formatNumber(stats.total_items || 0);
        document.getElementById('stat-total-prices').textContent = admin.formatNumber(stats.total_prices || 0);
        document.getElementById('stat-verified-stores').textContent = admin.formatNumber(stats.verified_stores || 0);

        if (stats.active_users_24h > 0) {
          document.getElementById('stat-active-change').textContent = '+' + stats.active_users_24h;
        }
        if (stats.prices_today > 0) {
          document.getElementById('stat-prices-change').textContent = '+' + stats.prices_today;
        }
      } catch (err) {
        console.error('Failed to load stats:', err);
      }
    }

    async function loadRecentUsers() {
      const tbody = document.getElementById('recent-users-tbody');
      try {
        const response = await adminApi.listUsers(5, 0);
        const users = response?.data || response || [];

        if (users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: var(--space-8); color: var(--color-gray-500);">No users found</td></tr>';
          return;
        }

        tbody.innerHTML = users.map(user => `
          <tr>
            <td>
              <div class="admin-user-cell">
                <div class="admin-user-cell-avatar">${(user.username || user.email)[0].toUpperCase()}</div>
                <div class="admin-user-cell-info">
                  <div class="admin-user-cell-name">${admin.escapeHtml(user.username || 'No username')}</div>
                  <div class="admin-user-cell-email">${admin.escapeHtml(user.email)}</div>
                </div>
              </div>
            </td>
            <td><span class="badge badge-${user.role === 'admin' ? 'error' : user.role === 'moderator' ? 'warning' : 'secondary'}">${user.role}</span></td>
            <td>${admin.formatDate(user.created_at)}</td>
            <td>${user.email_verified ? '<span class="badge badge-success">Verified</span>' : '<span class="badge badge-secondary">Pending</span>'}</td>
          </tr>
        `).join('');
      } catch (err) {
        console.error('Failed to load recent users:', err);
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: var(--space-8); color: var(--color-error);">Failed to load users</td></tr>';
      }
    }
  </script>
</body>
</html>
