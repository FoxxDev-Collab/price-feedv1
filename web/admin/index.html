<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Admin Panel</title>
  <link rel="stylesheet" href="/css/global.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/admin.css">
  <script src="/js/theme.js"></script>
</head>
<body>
  <div class="admin-layout">
    <aside class="admin-sidebar" id="admin-sidebar"></aside>

    <main class="admin-main">
      <header class="admin-header" id="admin-header"></header>

      <div class="admin-content">
        <div class="admin-page-header">
          <h1 class="admin-page-title">Dashboard</h1>
          <p class="admin-page-subtitle">Platform overview and key metrics</p>
        </div>

        <!-- Primary Stats Grid -->
        <div class="admin-stats-grid">
          <div class="admin-stat-card">
            <div class="admin-stat-header">
              <div class="admin-stat-icon primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="9" cy="7" r="4"></circle>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
              </div>
            </div>
            <div class="admin-stat-value" id="stat-total-users">0</div>
            <div class="admin-stat-label">Total Users</div>
          </div>

          <div class="admin-stat-card">
            <div class="admin-stat-header">
              <div class="admin-stat-icon secondary">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                  <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
              </div>
            </div>
            <div class="admin-stat-value" id="stat-total-stores">0</div>
            <div class="admin-stat-label">Total Stores</div>
          </div>

          <div class="admin-stat-card">
            <div class="admin-stat-header">
              <div class="admin-stat-icon accent">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
                </svg>
              </div>
            </div>
            <div class="admin-stat-value" id="stat-total-items">0</div>
            <div class="admin-stat-label">Total Items</div>
          </div>

          <div class="admin-stat-card">
            <div class="admin-stat-header">
              <div class="admin-stat-icon gray">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="1" x2="12" y2="23"></line>
                  <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                </svg>
              </div>
            </div>
            <div class="admin-stat-value" id="stat-total-prices">0</div>
            <div class="admin-stat-label">Total Prices</div>
          </div>
        </div>

        <!-- Activity Stats -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-4); margin-bottom: var(--space-6);">
          <div class="admin-card" style="padding: var(--space-4);">
            <div style="font-size: var(--text-xs); color: var(--color-gray-500); margin-bottom: var(--space-1);">Active Users (24h)</div>
            <div style="font-size: var(--text-2xl); font-weight: var(--font-bold); color: var(--color-primary-600);" id="stat-active-24h">0</div>
          </div>
          <div class="admin-card" style="padding: var(--space-4);">
            <div style="font-size: var(--text-xs); color: var(--color-gray-500); margin-bottom: var(--space-1);">Prices Today</div>
            <div style="font-size: var(--text-2xl); font-weight: var(--font-bold); color: var(--color-secondary-600);" id="stat-prices-today">0</div>
          </div>
          <div class="admin-card" style="padding: var(--space-4);">
            <div style="font-size: var(--text-xs); color: var(--color-gray-500); margin-bottom: var(--space-1);">Verified Stores</div>
            <div style="font-size: var(--text-2xl); font-weight: var(--font-bold); color: var(--color-accent-600);" id="stat-verified-stores">0</div>
          </div>
          <div class="admin-card" style="padding: var(--space-4);">
            <div style="font-size: var(--text-xs); color: var(--color-gray-500); margin-bottom: var(--space-1);">Avg Prices/Item</div>
            <div style="font-size: var(--text-2xl); font-weight: var(--font-bold); color: var(--color-gray-700);" id="stat-avg-prices">0</div>
          </div>
        </div>

        <!-- Three Column Layout -->
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--space-6);">

          <!-- Activity by Region -->
          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">Top Regions</h3>
            </div>
            <div class="admin-card-body" id="regions-list" style="padding: 0;">
              <div style="padding: var(--space-6); text-align: center; color: var(--color-gray-500);">Loading...</div>
            </div>
          </div>

          <!-- Data Quality -->
          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">Data Quality</h3>
            </div>
            <div class="admin-card-body">
              <div style="display: flex; flex-direction: column; gap: var(--space-4);">
                <div>
                  <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-1);">
                    <span style="font-size: var(--text-sm); color: var(--color-gray-600);">Store Verification</span>
                    <span style="font-size: var(--text-sm); font-weight: var(--font-semibold);" id="quality-stores">0%</span>
                  </div>
                  <div style="height: 6px; background: var(--color-gray-100); border-radius: 3px; overflow: hidden;">
                    <div id="quality-stores-bar" style="height: 100%; background: var(--color-primary-500); width: 0%; transition: width 0.3s;"></div>
                  </div>
                </div>
                <div>
                  <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-1);">
                    <span style="font-size: var(--text-sm); color: var(--color-gray-600);">Price Verification</span>
                    <span style="font-size: var(--text-sm); font-weight: var(--font-semibold);" id="quality-prices">0%</span>
                  </div>
                  <div style="height: 6px; background: var(--color-gray-100); border-radius: 3px; overflow: hidden;">
                    <div id="quality-prices-bar" style="height: 100%; background: var(--color-secondary-500); width: 0%; transition: width 0.3s;"></div>
                  </div>
                </div>
                <div>
                  <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-1);">
                    <span style="font-size: var(--text-sm); color: var(--color-gray-600);">Items with Prices</span>
                    <span style="font-size: var(--text-sm); font-weight: var(--font-semibold);" id="quality-items">0%</span>
                  </div>
                  <div style="height: 6px; background: var(--color-gray-100); border-radius: 3px; overflow: hidden;">
                    <div id="quality-items-bar" style="height: 100%; background: var(--color-accent-500); width: 0%; transition: width 0.3s;"></div>
                  </div>
                </div>
                <div style="border-top: 1px solid var(--color-gray-100); padding-top: var(--space-4); margin-top: var(--space-2);">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: var(--text-sm); color: var(--color-gray-600);">Email Verified Users</span>
                    <span style="font-size: var(--text-sm); font-weight: var(--font-semibold);" id="quality-users">0%</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- System Status -->
          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">System Status</h3>
            </div>
            <div class="admin-card-body">
              <div style="display: flex; flex-direction: column; gap: var(--space-3);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="font-size: var(--text-sm); color: var(--color-gray-600);">API Server</span>
                  <span class="badge badge-success">Online</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="font-size: var(--text-sm); color: var(--color-gray-600);">Database</span>
                  <span class="badge badge-success">Connected</span>
                </div>
                <div style="border-top: 1px solid var(--color-gray-100); padding-top: var(--space-3); margin-top: var(--space-1);">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-2);">
                    <span style="font-size: var(--text-sm); color: var(--color-gray-600);">Total Regions</span>
                    <span style="font-size: var(--text-sm); font-weight: var(--font-semibold);" id="stat-regions">0</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-2);">
                    <span style="font-size: var(--text-sm); color: var(--color-gray-600);">Admins</span>
                    <span style="font-size: var(--text-sm); font-weight: var(--font-semibold);" id="stat-admins">0</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: var(--text-sm); color: var(--color-gray-600);">Moderators</span>
                    <span style="font-size: var(--text-sm); font-weight: var(--font-semibold);" id="stat-mods">0</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Links -->
        <h2 style="font-size: var(--text-lg); font-weight: var(--font-semibold); margin: var(--space-6) 0 var(--space-4); color: var(--color-gray-900);">Quick Links</h2>
        <div class="admin-actions-grid" style="grid-template-columns: repeat(4, 1fr);">
          <a href="/admin/users/" class="admin-action-card">
            <div class="admin-action-icon" style="background: var(--color-primary-100); color: var(--color-primary-600);">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
              </svg>
            </div>
            <div class="admin-action-content">
              <div class="admin-action-title">Users</div>
              <div class="admin-action-desc">Manage accounts</div>
            </div>
          </a>

          <a href="/admin/stores/" class="admin-action-card">
            <div class="admin-action-icon" style="background: var(--color-secondary-100); color: var(--color-secondary-600);">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              </svg>
            </div>
            <div class="admin-action-content">
              <div class="admin-action-title">Stores</div>
              <div class="admin-action-desc">View directory</div>
            </div>
          </a>

          <a href="/admin/prices/" class="admin-action-card">
            <div class="admin-action-icon" style="background: var(--color-accent-100); color: var(--color-accent-600);">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="1" x2="12" y2="23"></line>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
              </svg>
            </div>
            <div class="admin-action-content">
              <div class="admin-action-title">Prices</div>
              <div class="admin-action-desc">Monitor activity</div>
            </div>
          </a>

          <a href="/admin/regions/" class="admin-action-card">
            <div class="admin-action-icon" style="background: var(--color-gray-100); color: var(--color-gray-600);">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="10" r="3"></circle>
                <path d="M12 21.7C17.3 17 20 13 20 10a8 8 0 1 0-16 0c0 3 2.7 7 8 11.7z"></path>
              </svg>
            </div>
            <div class="admin-action-content">
              <div class="admin-action-title">Regions</div>
              <div class="admin-action-desc">Manage areas</div>
            </div>
          </a>
        </div>
      </div>
    </main>
  </div>

  <script src="/js/api.js"></script>
  <script src="/js/auth.js"></script>
  <script src="/js/admin-common.js"></script>
  <script src="/js/admin-sidebar.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      if (!await admin.init()) return;

      initAdminSidebar('dashboard');
      document.getElementById('admin-header').innerHTML = renderAdminHeader([
        { label: 'Admin', href: '/admin/' },
        { label: 'Dashboard', href: '/admin/' }
      ]);

      await Promise.all([
        loadStats(),
        loadRegions(),
        loadQualityMetrics()
      ]);
    });

    async function loadStats() {
      try {
        const response = await adminApi.getStats();
        const stats = response?.data || response;

        // Primary stats
        document.getElementById('stat-total-users').textContent = admin.formatNumber(stats.total_users || 0);
        document.getElementById('stat-total-stores').textContent = admin.formatNumber(stats.total_stores || 0);
        document.getElementById('stat-total-items').textContent = admin.formatNumber(stats.total_items || 0);
        document.getElementById('stat-total-prices').textContent = admin.formatNumber(stats.total_prices || 0);

        // Activity stats
        document.getElementById('stat-active-24h').textContent = admin.formatNumber(stats.active_users_24h || 0);
        document.getElementById('stat-prices-today').textContent = admin.formatNumber(stats.prices_today || 0);
        document.getElementById('stat-verified-stores').textContent = admin.formatNumber(stats.verified_stores || 0);

        // Calculate avg prices per item
        const avgPrices = stats.total_items > 0 ? (stats.total_prices / stats.total_items).toFixed(1) : '0';
        document.getElementById('stat-avg-prices').textContent = avgPrices;

      } catch (err) {
        console.error('Failed to load stats:', err);
      }
    }

    async function loadRegions() {
      const container = document.getElementById('regions-list');
      try {
        const response = await regionsApi.list({ limit: 5 });
        const regions = response?.data || [];

        if (regions.length === 0) {
          container.innerHTML = '<div style="padding: var(--space-6); text-align: center; color: var(--color-gray-500);">No regions configured</div>';
          document.getElementById('stat-regions').textContent = '0';
          return;
        }

        // Get total count
        document.getElementById('stat-regions').textContent = response?.meta?.total || regions.length;

        container.innerHTML = regions.map((region, i) => `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-3) var(--space-4); ${i > 0 ? 'border-top: 1px solid var(--color-gray-100);' : ''}">
            <div>
              <div style="font-weight: var(--font-medium);">${admin.escapeHtml(region.name)}</div>
              <div style="font-size: var(--text-xs); color: var(--color-gray-500);">${region.state}</div>
            </div>
            <span class="badge badge-secondary">${region.zip_codes?.length || 0} ZIPs</span>
          </div>
        `).join('');

      } catch (err) {
        console.error('Failed to load regions:', err);
        container.innerHTML = '<div style="padding: var(--space-6); text-align: center; color: var(--color-error);">Failed to load</div>';
      }
    }

    async function loadQualityMetrics() {
      try {
        // Get various stats
        const [storesRes, pricesRes, itemsRes, usersRes] = await Promise.all([
          storesApi.getStats().catch(() => ({})),
          pricesApi.getStats().catch(() => ({})),
          itemsApi.getStats().catch(() => ({})),
          adminApi.getStats().catch(() => ({}))
        ]);

        const storeStats = storesRes?.data || storesRes || {};
        const priceStats = pricesRes?.data || pricesRes || {};
        const itemStats = itemsRes?.data || itemsRes || {};
        const userStats = usersRes?.data || usersRes || {};

        // Store verification rate
        const storeVerifyRate = storeStats.total_stores > 0
          ? Math.round((storeStats.verified_count / storeStats.total_stores) * 100)
          : 0;
        document.getElementById('quality-stores').textContent = storeVerifyRate + '%';
        document.getElementById('quality-stores-bar').style.width = storeVerifyRate + '%';

        // Price verification rate
        const priceVerifyRate = priceStats.total_prices > 0
          ? Math.round((priceStats.verified_count / priceStats.total_prices) * 100)
          : 0;
        document.getElementById('quality-prices').textContent = priceVerifyRate + '%';
        document.getElementById('quality-prices-bar').style.width = priceVerifyRate + '%';

        // Items with prices rate
        const itemsPricedRate = itemStats.total_items > 0
          ? Math.round((itemStats.items_with_prices / itemStats.total_items) * 100)
          : 0;
        document.getElementById('quality-items').textContent = itemsPricedRate + '%';
        document.getElementById('quality-items-bar').style.width = itemsPricedRate + '%';

        // User email verification (estimate based on total)
        document.getElementById('quality-users').textContent = '-';

        // Count admins/mods from user list
        try {
          const usersListRes = await adminApi.listUsers(100, 0);
          const users = usersListRes?.data || [];
          const admins = users.filter(u => u.role === 'admin').length;
          const mods = users.filter(u => u.role === 'moderator').length;
          document.getElementById('stat-admins').textContent = admins;
          document.getElementById('stat-mods').textContent = mods;
        } catch (e) {
          document.getElementById('stat-admins').textContent = '-';
          document.getElementById('stat-mods').textContent = '-';
        }

      } catch (err) {
        console.error('Failed to load quality metrics:', err);
      }
    }
  </script>
</body>
</html>
