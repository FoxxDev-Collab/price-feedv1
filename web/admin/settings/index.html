<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings - Admin Panel</title>
  <link rel="stylesheet" href="/css/global.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/admin.css">
  <script src="/js/theme.js"></script>
</head>
<body>
  <div class="admin-layout">
    <aside class="admin-sidebar" id="admin-sidebar"></aside>

    <main class="admin-main">
      <header class="admin-header" id="admin-header"></header>

      <div class="admin-content">
        <div class="admin-page-header">
          <h1 class="admin-page-title">System Settings</h1>
          <p class="admin-page-subtitle">Configure application settings and preferences</p>
        </div>

        <!-- Settings Tabs -->
        <div class="admin-card" style="margin-bottom: var(--space-6);">
          <div style="display: flex; border-bottom: 1px solid var(--color-gray-200); overflow-x: auto;">
            <button class="settings-tab active" data-tab="general" onclick="switchTab('general')">General</button>
            <button class="settings-tab" data-tab="users" onclick="switchTab('users')">Users & Auth</button>
            <button class="settings-tab" data-tab="prices" onclick="switchTab('prices')">Prices</button>
            <button class="settings-tab" data-tab="reputation" onclick="switchTab('reputation')">Reputation</button>
            <button class="settings-tab" data-tab="email" onclick="switchTab('email')">Email</button>
            <button class="settings-tab" data-tab="storage" onclick="switchTab('storage')">Storage</button>
            <button class="settings-tab" data-tab="api" onclick="switchTab('api')">API & Security</button>
          </div>
        </div>

        <!-- General Settings -->
        <div id="tab-general" class="settings-content">
          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">General Settings</h3>
            </div>
            <div class="admin-card-body">
              <div class="admin-form-group">
                <label class="admin-form-label">Site Name</label>
                <input type="text" class="admin-form-input" id="site-name" placeholder="Loading...">
              </div>
              <div class="admin-form-group">
                <label class="admin-form-label">Site Description</label>
                <textarea class="admin-form-input" rows="2" id="site-description" placeholder="Loading..."></textarea>
              </div>
              <div class="admin-form-group">
                <label class="admin-form-label">Contact Email</label>
                <input type="email" class="admin-form-input" id="contact-email" placeholder="Loading...">
              </div>
              <div class="admin-form-group">
                <label class="admin-form-checkbox">
                  <input type="checkbox" id="maintenance-mode">
                  Maintenance Mode (show maintenance page to non-admins)
                </label>
              </div>
            </div>
            <div class="admin-card-footer" style="display: flex; justify-content: flex-end;">
              <button class="btn btn-primary" onclick="saveSettings('general')">Save Changes</button>
            </div>
          </div>
        </div>

        <!-- Users & Auth Settings -->
        <div id="tab-users" class="settings-content hidden">
          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">User & Authentication Settings</h3>
            </div>
            <div class="admin-card-body">
              <div class="admin-form-group">
                <label class="admin-form-checkbox">
                  <input type="checkbox" id="allow-registration">
                  Allow new user registrations
                </label>
              </div>
              <div class="admin-form-group">
                <label class="admin-form-checkbox">
                  <input type="checkbox" id="require-email-verify">
                  Require email verification
                </label>
              </div>
              <div class="admin-form-group">
                <label class="admin-form-label">Minimum Password Length</label>
                <input type="number" class="admin-form-input" min="6" max="32" id="min-password" style="max-width: 100px;">
              </div>
              <div class="admin-form-group">
                <label class="admin-form-label">Session Timeout (hours)</label>
                <input type="number" class="admin-form-input" min="1" max="720" id="session-timeout" style="max-width: 100px;">
              </div>
              <div class="admin-form-group">
                <label class="admin-form-label">Max Login Attempts</label>
                <input type="number" class="admin-form-input" min="3" max="10" id="max-login-attempts" style="max-width: 100px;">
              </div>
              <div class="admin-form-group">
                <label class="admin-form-label">Account Lockout Duration (minutes)</label>
                <input type="number" class="admin-form-input" min="5" max="60" id="lockout-duration" style="max-width: 100px;">
              </div>
            </div>
            <div class="admin-card-footer" style="display: flex; justify-content: flex-end;">
              <button class="btn btn-primary" onclick="saveSettings('users')">Save Changes</button>
            </div>
          </div>
        </div>

        <!-- Prices Settings -->
        <div id="tab-prices" class="settings-content hidden">
          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">Price Settings</h3>
            </div>
            <div class="admin-card-body">
              <div class="admin-form-group">
                <label class="admin-form-label">Price Expiry (days)</label>
                <p style="font-size: var(--text-sm); color: var(--color-gray-500); margin-bottom: var(--space-2);">Prices older than this will be considered stale</p>
                <input type="number" class="admin-form-input" min="1" max="30" id="price-expiry" style="max-width: 100px;">
              </div>
              <div class="admin-form-group">
                <label class="admin-form-label">Verification Threshold</label>
                <p style="font-size: var(--text-sm); color: var(--color-gray-500); margin-bottom: var(--space-2);">Number of verifications needed to mark price as verified</p>
                <input type="number" class="admin-form-input" min="1" max="10" id="verify-threshold" style="max-width: 100px;">
              </div>
              <div class="admin-form-group">
                <label class="admin-form-checkbox">
                  <input type="checkbox" id="allow-anonymous-prices">
                  Allow price viewing without login
                </label>
              </div>
              <div class="admin-form-group">
                <label class="admin-form-checkbox">
                  <input type="checkbox" id="require-receipt">
                  Require receipt photo for price submissions
                </label>
              </div>
              <div class="admin-form-group">
                <label class="admin-form-label">Maximum Price Deviation (%)</label>
                <p style="font-size: var(--text-sm); color: var(--color-gray-500); margin-bottom: var(--space-2);">Flag prices that deviate more than this from average</p>
                <input type="number" class="admin-form-input" min="10" max="200" id="price-deviation" style="max-width: 100px;">
              </div>
            </div>
            <div class="admin-card-footer" style="display: flex; justify-content: flex-end;">
              <button class="btn btn-primary" onclick="saveSettings('prices')">Save Changes</button>
            </div>
          </div>
        </div>

        <!-- Reputation Settings -->
        <div id="tab-reputation" class="settings-content hidden">
          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">Reputation System Settings</h3>
            </div>
            <div class="admin-card-body">
              <h4 style="font-weight: var(--font-semibold); margin-bottom: var(--space-3);">Points Awarded</h4>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4);">
                <div class="admin-form-group">
                  <label class="admin-form-label">Price Submission</label>
                  <input type="number" class="admin-form-input" min="0" id="points-price">
                </div>
                <div class="admin-form-group">
                  <label class="admin-form-label">Price Verification</label>
                  <input type="number" class="admin-form-input" min="0" id="points-verify">
                </div>
                <div class="admin-form-group">
                  <label class="admin-form-label">Store Added</label>
                  <input type="number" class="admin-form-input" min="0" id="points-store">
                </div>
                <div class="admin-form-group">
                  <label class="admin-form-label">Item Added</label>
                  <input type="number" class="admin-form-input" min="0" id="points-item">
                </div>
              </div>
              <h4 style="font-weight: var(--font-semibold); margin: var(--space-6) 0 var(--space-3);">Reputation Levels</h4>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4);">
                <div class="admin-form-group">
                  <label class="admin-form-label">Bronze Threshold</label>
                  <input type="number" class="admin-form-input" min="0" id="level-bronze">
                </div>
                <div class="admin-form-group">
                  <label class="admin-form-label">Silver Threshold</label>
                  <input type="number" class="admin-form-input" min="0" id="level-silver">
                </div>
                <div class="admin-form-group">
                  <label class="admin-form-label">Gold Threshold</label>
                  <input type="number" class="admin-form-input" min="0" id="level-gold">
                </div>
                <div class="admin-form-group">
                  <label class="admin-form-label">Platinum Threshold</label>
                  <input type="number" class="admin-form-input" min="0" id="level-platinum">
                </div>
              </div>
            </div>
            <div class="admin-card-footer" style="display: flex; justify-content: flex-end;">
              <button class="btn btn-primary" onclick="saveSettings('reputation')">Save Changes</button>
            </div>
          </div>
        </div>

        <!-- Email Settings -->
        <div id="tab-email" class="settings-content hidden">
          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">Email Configuration</h3>
              <span id="email-status" class="status-badge"></span>
            </div>
            <div class="admin-card-body">
              <div class="admin-form-group">
                <label class="admin-form-checkbox">
                  <input type="checkbox" id="smtp-enabled">
                  Enable SMTP Email
                </label>
                <p style="font-size: var(--text-sm); color: var(--color-gray-500); margin-top: var(--space-1);">When enabled, the system can send emails for password resets, welcome messages, etc.</p>
              </div>
              <div class="admin-form-group">
                <label class="admin-form-label">SMTP Host</label>
                <input type="text" class="admin-form-input" placeholder="smtp.sendgrid.net" id="smtp-host">
              </div>
              <div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--space-4);">
                <div class="admin-form-group">
                  <label class="admin-form-label">SMTP Username</label>
                  <input type="text" class="admin-form-input" placeholder="apikey" id="smtp-user">
                </div>
                <div class="admin-form-group">
                  <label class="admin-form-label">SMTP Port</label>
                  <input type="number" class="admin-form-input" value="587" id="smtp-port">
                  <p style="font-size: var(--text-xs); color: var(--color-gray-500); margin-top: var(--space-1);">587 (TLS) or 465 (SSL)</p>
                </div>
              </div>
              <div class="admin-form-group">
                <label class="admin-form-label">SMTP Password</label>
                <input type="password" class="admin-form-input" placeholder="Enter password or API key" id="smtp-password">
                <p style="font-size: var(--text-xs); color: var(--color-gray-500); margin-top: var(--space-1);">Leave blank to keep existing password</p>
              </div>
              <div class="admin-form-group">
                <label class="admin-form-label">From Address</label>
                <input type="email" class="admin-form-input" placeholder="noreply@pricefeed.app" id="smtp-from-addr">
              </div>
              <div class="admin-form-group">
                <label class="admin-form-label">From Name</label>
                <input type="text" class="admin-form-input" placeholder="PriceFeed" id="smtp-from-name">
              </div>
              <div style="margin-top: var(--space-4); padding-top: var(--space-4); border-top: 1px solid var(--color-gray-200);">
                <label class="admin-form-label">Test Email Configuration</label>
                <div style="display: flex; gap: var(--space-2); margin-top: var(--space-2);">
                  <input type="email" class="admin-form-input" placeholder="test@example.com" id="test-email-address" style="flex: 1;">
                  <button class="btn btn-secondary" onclick="testEmail()" id="test-email-btn">Send Test Email</button>
                </div>
                <p style="font-size: var(--text-xs); color: var(--color-gray-500); margin-top: var(--space-1);">Send a test email to verify your SMTP configuration</p>
              </div>
            </div>
            <div class="admin-card-footer" style="display: flex; justify-content: flex-end;">
              <button class="btn btn-primary" onclick="saveEmailSettings()" id="save-email-btn">Save Email Settings</button>
            </div>
          </div>
        </div>

        <!-- Storage Settings (S3/Garage) -->
        <div id="tab-storage" class="settings-content hidden">
          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">Receipt Storage Configuration</h3>
              <span id="storage-status" class="status-badge"></span>
            </div>
            <div class="admin-card-body">
              <p style="font-size: var(--text-sm); color: var(--color-gray-600); margin-bottom: var(--space-4);">
                Configure S3-compatible storage for receipt images. This is required for the receipt scanning feature.
                Supports Garage, MinIO, AWS S3, or any S3-compatible service.
              </p>
              <div class="admin-form-group">
                <label class="admin-form-checkbox">
                  <input type="checkbox" id="s3-enabled">
                  Enable Receipt Storage
                </label>
                <p style="font-size: var(--text-sm); color: var(--color-gray-500); margin-top: var(--space-1);">When enabled, users can upload and scan receipt images.</p>
              </div>
              <div class="admin-form-group">
                <label class="admin-form-label">S3 Endpoint</label>
                <input type="text" class="admin-form-input" placeholder="garage:3900 or s3.amazonaws.com" id="s3-endpoint">
                <p style="font-size: var(--text-xs); color: var(--color-gray-500); margin-top: var(--space-1);">For Garage/MinIO, use hostname:port. For AWS S3, use s3.amazonaws.com or regional endpoint.</p>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4);">
                <div class="admin-form-group">
                  <label class="admin-form-label">Access Key ID</label>
                  <input type="text" class="admin-form-input" placeholder="GK..." id="s3-access-key">
                </div>
                <div class="admin-form-group">
                  <label class="admin-form-label">Secret Access Key</label>
                  <input type="password" class="admin-form-input" placeholder="Enter secret key" id="s3-secret-key">
                  <p style="font-size: var(--text-xs); color: var(--color-gray-500); margin-top: var(--space-1);">Leave blank to keep existing</p>
                </div>
              </div>
              <div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--space-4);">
                <div class="admin-form-group">
                  <label class="admin-form-label">Bucket Name</label>
                  <input type="text" class="admin-form-input" placeholder="receipts" id="s3-bucket">
                </div>
                <div class="admin-form-group">
                  <label class="admin-form-label">Region</label>
                  <input type="text" class="admin-form-input" placeholder="garage" id="s3-region">
                  <p style="font-size: var(--text-xs); color: var(--color-gray-500); margin-top: var(--space-1);">Use "garage" for Garage</p>
                </div>
              </div>
              <div class="admin-form-group">
                <label class="admin-form-checkbox">
                  <input type="checkbox" id="s3-use-ssl">
                  Use SSL/TLS (HTTPS)
                </label>
                <p style="font-size: var(--text-sm); color: var(--color-gray-500); margin-top: var(--space-1);">Enable for production. Disable for local Garage/MinIO without SSL.</p>
              </div>

              <div style="margin-top: var(--space-4); padding-top: var(--space-4); border-top: 1px solid var(--color-gray-200);">
                <label class="admin-form-label">Test Connection</label>
                <div style="display: flex; gap: var(--space-2); margin-top: var(--space-2);">
                  <button class="btn btn-secondary" onclick="testStorageConnection()" id="test-storage-btn">Test Connection</button>
                </div>
                <p style="font-size: var(--text-xs); color: var(--color-gray-500); margin-top: var(--space-1);">Test the S3 connection and verify bucket access</p>
              </div>
            </div>
            <div class="admin-card-footer" style="display: flex; justify-content: flex-end;">
              <button class="btn btn-primary" onclick="saveStorageSettings()" id="save-storage-btn">Save Storage Settings</button>
            </div>
          </div>
        </div>

        <!-- API & Security Settings -->
        <div id="tab-api" class="settings-content hidden">
          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">API & Security Settings</h3>
            </div>
            <div class="admin-card-body">
              <div class="admin-form-group">
                <label class="admin-form-label">API Rate Limit (requests/minute)</label>
                <input type="number" class="admin-form-input" min="10" max="1000" id="rate-limit" style="max-width: 150px;">
              </div>
              <div class="admin-form-group">
                <label class="admin-form-label">CORS Allowed Origins</label>
                <textarea class="admin-form-input" rows="2" id="cors-origins" placeholder="https://example.com, https://api.example.com"></textarea>
                <p style="font-size: var(--text-xs); color: var(--color-gray-500); margin-top: var(--space-1);">Use * for all origins, or comma-separated list of domains</p>
              </div>
              <div class="admin-form-group">
                <label class="admin-form-checkbox">
                  <input type="checkbox" id="enable-api">
                  Enable Public API
                </label>
              </div>
              <div class="admin-form-group">
                <label class="admin-form-checkbox">
                  <input type="checkbox" id="require-api-key">
                  Require API Key for external access
                </label>
              </div>

              <h4 style="font-weight: var(--font-semibold); margin: var(--space-6) 0 var(--space-3);">Cloudflare Turnstile (CAPTCHA)</h4>
              <div class="admin-form-group">
                <label class="admin-form-checkbox">
                  <input type="checkbox" id="captcha-enabled">
                  Enable CAPTCHA on registration and login
                </label>
                <p style="font-size: var(--text-sm); color: var(--color-gray-500); margin-top: var(--space-1);">Protect forms with Cloudflare Turnstile. <a href="https://dash.cloudflare.com/?to=/:account/turnstile" target="_blank">Get your keys here</a></p>
              </div>
              <div class="admin-form-group">
                <label class="admin-form-label">Site Key</label>
                <input type="text" class="admin-form-input" placeholder="0x4AAAAAAA..." id="captcha-site-key">
                <p style="font-size: var(--text-xs); color: var(--color-gray-500); margin-top: var(--space-1);">Public key used in the browser widget</p>
              </div>
              <div class="admin-form-group">
                <label class="admin-form-label">Secret Key</label>
                <input type="password" class="admin-form-input" placeholder="0x4AAAAAAA..." id="captcha-secret-key">
                <p style="font-size: var(--text-xs); color: var(--color-gray-500); margin-top: var(--space-1);">Private key for server-side verification. Leave blank to keep existing.</p>
              </div>

              <h4 style="font-weight: var(--font-semibold); margin: var(--space-6) 0 var(--space-3);">Email Verification</h4>
              <div class="admin-form-group">
                <label class="admin-form-checkbox">
                  <input type="checkbox" id="require-email-verify">
                  Require email verification for new users
                </label>
                <p style="font-size: var(--text-sm); color: var(--color-gray-500); margin-top: var(--space-1);">New users must verify their email before accessing most features. Admin accounts are exempt. Requires SMTP to be configured.</p>
              </div>

              <h4 style="font-weight: var(--font-semibold); margin: var(--space-6) 0 var(--space-3);">JWT Settings</h4>
              <div class="admin-form-group">
                <label class="admin-form-label">JWT Secret</label>
                <div style="display: flex; gap: var(--space-2);">
                  <input type="password" class="admin-form-input" value="••••••••••••••••" id="jwt-secret" readonly>
                  <button class="btn btn-secondary" onclick="regenerateSecret()">Regenerate</button>
                </div>
                <p style="font-size: var(--text-xs); color: var(--color-gray-500); margin-top: var(--space-1);">Regenerating will invalidate all existing sessions</p>
              </div>
              <div class="admin-form-group">
                <label class="admin-form-label">JWT Expiry (hours)</label>
                <input type="number" class="admin-form-input" min="1" max="168" id="jwt-expiry" style="max-width: 100px;">
              </div>
            </div>
            <div class="admin-card-footer" style="display: flex; justify-content: flex-end;">
              <button class="btn btn-primary" onclick="saveSettings('api')">Save Changes</button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <style>
    .settings-tab {
      padding: var(--space-3) var(--space-5);
      background: none;
      border: none;
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
      color: var(--color-gray-500);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all var(--transition-fast);
      white-space: nowrap;
    }
    .settings-tab:hover {
      color: var(--color-gray-700);
    }
    .settings-tab.active {
      color: var(--color-primary-600);
      border-bottom-color: var(--color-primary-600);
    }
    .settings-content.hidden {
      display: none;
    }
    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
    }
    .status-badge.configured {
      background: var(--color-green-100);
      color: var(--color-green-700);
    }
    .status-badge.not-configured {
      background: var(--color-yellow-100);
      color: var(--color-yellow-700);
    }
    .status-badge.disabled {
      background: var(--color-gray-100);
      color: var(--color-gray-600);
    }
  </style>

  <script src="/js/api.js"></script>
  <script src="/js/auth.js"></script>
  <script src="/js/admin-common.js"></script>
  <script src="/js/admin-sidebar.js"></script>
  <script>
    let emailConfig = {};

    // Field mappings: HTML element ID -> database key
    const fieldMappings = {
      general: {
        'site-name': 'site_name',
        'site-description': 'site_description',
        'contact-email': 'contact_email',
        'maintenance-mode': 'maintenance_mode'
      },
      users: {
        'allow-registration': 'allow_registration',
        'require-email-verify': 'require_email_verify',
        'min-password': 'min_password_length',
        'session-timeout': 'session_timeout_hours',
        'max-login-attempts': 'max_login_attempts',
        'lockout-duration': 'lockout_duration_minutes'
      },
      prices: {
        'price-expiry': 'price_expiry_days',
        'verify-threshold': 'verification_threshold',
        'allow-anonymous-prices': 'allow_anonymous_prices',
        'require-receipt': 'require_receipt',
        'price-deviation': 'max_price_deviation'
      },
      reputation: {
        'points-price': 'points_price_submission',
        'points-verify': 'points_verification',
        'points-store': 'points_store_added',
        'points-item': 'points_item_added',
        'level-bronze': 'level_bronze',
        'level-silver': 'level_silver',
        'level-gold': 'level_gold',
        'level-platinum': 'level_platinum'
      },
      api: {
        'rate-limit': 'api_rate_limit',
        'cors-origins': 'cors_origins',
        'enable-api': 'enable_public_api',
        'require-api-key': 'require_api_key',
        'captcha-enabled': 'captcha_enabled',
        'captcha-site-key': 'captcha_site_key',
        'captcha-secret-key': 'captcha_secret_key',
        'require-email-verify': 'require_email_verify',
        'jwt-expiry': 'jwt_expiry_hours'
      }
    };

    // Map frontend tab names to backend category names
    const categoryMap = {
      users: 'auth'  // UI says "users" but backend stores under "auth"
    };

    document.addEventListener('DOMContentLoaded', async () => {
      if (!await admin.init()) return;

      initAdminSidebar('settings');
      document.getElementById('admin-header').innerHTML = renderAdminHeader([
        { label: 'Admin', href: '/admin/' },
        { label: 'Settings', href: '/admin/settings/' }
      ]);

      // Load all settings
      await loadAllSettings();
    });

    // Get the backend category name for a frontend section
    function getBackendCategory(section) {
      return categoryMap[section] || section;
    }

    async function loadAllSettings() {
      // Load all settings in parallel
      await Promise.all([
        loadSettingsCategory('general'),
        loadSettingsCategory('users'),  // loads from 'auth' category
        loadSettingsCategory('prices'),
        loadSettingsCategory('reputation'),
        loadSettingsCategory('api'),
        loadEmailSettings(),
        loadStorageSettings()
      ]);
    }

    async function loadSettingsCategory(section) {
      const backendCategory = getBackendCategory(section);
      try {
        const response = await api.get(`/admin/settings/${backendCategory}`);
        if (response.success && response.data) {
          populateSettingsForm(section, response.data);
        }
      } catch (err) {
        console.error(`Failed to load ${section} settings:`, err);
      }
    }

    function populateSettingsForm(category, data) {
      const mapping = fieldMappings[category];
      if (!mapping) return;

      for (const [elementId, dbKey] of Object.entries(mapping)) {
        const element = document.getElementById(elementId);
        if (!element) continue;

        const value = data[dbKey];

        // Handle password fields specially - show placeholder if value exists
        if (element.type === 'password') {
          if (value && value !== '' && value !== '••••••••') {
            element.placeholder = '••••••••';
          }
          continue; // Don't set the actual value for password fields
        }

        if (value === undefined || value === null) continue;

        if (element.type === 'checkbox') {
          element.checked = value === true || value === 'true';
        } else if (element.type === 'number') {
          element.value = parseInt(value) || 0;
        } else {
          element.value = value;
        }
      }
    }

    async function loadEmailSettings() {
      try {
        const response = await api.get('/admin/email/config');
        if (response.success) {
          emailConfig = response.data;
          populateEmailForm(emailConfig);
          updateEmailStatus(emailConfig);
        }
      } catch (err) {
        console.error('Failed to load email settings:', err);
        admin.toast('Failed to load email settings', 'error');
      }
    }

    function populateEmailForm(config) {
      document.getElementById('smtp-enabled').checked = config.enabled || false;
      document.getElementById('smtp-host').value = config.host || '';
      document.getElementById('smtp-port').value = config.port || 587;
      document.getElementById('smtp-user').value = config.user || '';
      document.getElementById('smtp-from-addr').value = config.fromAddr || '';
      document.getElementById('smtp-from-name').value = config.fromName || '';
      // Password field shows placeholder if password exists
      document.getElementById('smtp-password').placeholder = config.password ? '••••••••' : 'Enter password or API key';
    }

    function updateEmailStatus(config) {
      const statusEl = document.getElementById('email-status');
      if (!config.enabled) {
        statusEl.className = 'status-badge disabled';
        statusEl.textContent = 'Disabled';
      } else if (config.configured) {
        statusEl.className = 'status-badge configured';
        statusEl.textContent = 'Configured';
      } else {
        statusEl.className = 'status-badge not-configured';
        statusEl.textContent = 'Not Configured';
      }
    }

    async function saveEmailSettings() {
      const btn = document.getElementById('save-email-btn');
      btn.disabled = true;
      btn.textContent = 'Saving...';

      try {
        const data = {
          smtp_enabled: document.getElementById('smtp-enabled').checked,
          smtp_host: document.getElementById('smtp-host').value.trim(),
          smtp_port: parseInt(document.getElementById('smtp-port').value) || 587,
          smtp_user: document.getElementById('smtp-user').value.trim(),
          smtp_password: document.getElementById('smtp-password').value,
          smtp_from_addr: document.getElementById('smtp-from-addr').value.trim(),
          smtp_from_name: document.getElementById('smtp-from-name').value.trim()
        };

        const response = await api.put('/admin/email/config', data);
        if (response.success) {
          admin.toast('Email settings saved successfully', 'success');
          // Reload to get updated status
          await loadEmailSettings();
        } else {
          admin.toast(response.error || 'Failed to save email settings', 'error');
        }
      } catch (err) {
        console.error('Failed to save email settings:', err);
        admin.toast('Failed to save email settings: ' + err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Save Email Settings';
      }
    }

    async function testEmail() {
      const btn = document.getElementById('test-email-btn');
      const emailInput = document.getElementById('test-email-address');
      const toEmail = emailInput.value.trim();

      if (!toEmail) {
        admin.toast('Please enter an email address for the test', 'warning');
        emailInput.focus();
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Sending...';

      try {
        const response = await api.post('/admin/email/test', { to_email: toEmail });
        if (response.success) {
          admin.toast(response.message || 'Test email sent successfully!', 'success');
        } else {
          admin.toast(response.error || 'Failed to send test email', 'error');
        }
      } catch (err) {
        console.error('Failed to send test email:', err);
        admin.toast('Failed to send test email: ' + err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Send Test Email';
      }
    }

    // Storage Settings Functions
    let storageConfig = {};

    async function loadStorageSettings() {
      try {
        const response = await api.get('/admin/storage/config');
        if (response.success) {
          storageConfig = response.data;
          populateStorageForm(storageConfig);
          updateStorageStatus(storageConfig);
        }
      } catch (err) {
        console.error('Failed to load storage settings:', err);
      }
    }

    function populateStorageForm(config) {
      document.getElementById('s3-enabled').checked = config.enabled || false;
      document.getElementById('s3-endpoint').value = config.endpoint || '';
      document.getElementById('s3-access-key').value = config.accessKey || '';
      document.getElementById('s3-bucket').value = config.bucket || 'receipts';
      document.getElementById('s3-region').value = config.region || 'garage';
      document.getElementById('s3-use-ssl').checked = config.useSSL || false;
      // Password field shows placeholder if key exists
      document.getElementById('s3-secret-key').placeholder = config.hasSecretKey ? '••••••••' : 'Enter secret key';
    }

    function updateStorageStatus(config) {
      const statusEl = document.getElementById('storage-status');
      if (!config.enabled) {
        statusEl.className = 'status-badge disabled';
        statusEl.textContent = 'Disabled';
      } else if (config.configured) {
        statusEl.className = 'status-badge configured';
        statusEl.textContent = 'Configured';
      } else {
        statusEl.className = 'status-badge not-configured';
        statusEl.textContent = 'Not Configured';
      }
    }

    async function saveStorageSettings() {
      const btn = document.getElementById('save-storage-btn');
      btn.disabled = true;
      btn.textContent = 'Saving...';

      try {
        const data = {
          s3_enabled: document.getElementById('s3-enabled').checked,
          s3_endpoint: document.getElementById('s3-endpoint').value.trim(),
          s3_access_key: document.getElementById('s3-access-key').value.trim(),
          s3_secret_key: document.getElementById('s3-secret-key').value,
          s3_bucket: document.getElementById('s3-bucket').value.trim() || 'receipts',
          s3_region: document.getElementById('s3-region').value.trim() || 'garage',
          s3_use_ssl: document.getElementById('s3-use-ssl').checked
        };

        const response = await api.put('/admin/storage/config', data);
        if (response.success) {
          admin.toast('Storage settings saved successfully', 'success');
          await loadStorageSettings();
        } else {
          admin.toast(response.error || 'Failed to save storage settings', 'error');
        }
      } catch (err) {
        console.error('Failed to save storage settings:', err);
        admin.toast('Failed to save storage settings: ' + err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Save Storage Settings';
      }
    }

    async function testStorageConnection() {
      const btn = document.getElementById('test-storage-btn');
      btn.disabled = true;
      btn.textContent = 'Testing...';

      try {
        const response = await api.post('/admin/storage/test');
        if (response.success) {
          admin.toast(response.message || 'Storage connection successful!', 'success');
        } else {
          admin.toast(response.error || 'Storage connection failed', 'error');
        }
      } catch (err) {
        console.error('Storage test failed:', err);
        admin.toast('Storage test failed: ' + err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Test Connection';
      }
    }

    function switchTab(tabId) {
      // Hide all content
      document.querySelectorAll('.settings-content').forEach(el => el.classList.add('hidden'));
      // Deactivate all tabs
      document.querySelectorAll('.settings-tab').forEach(el => el.classList.remove('active'));
      // Show selected content
      document.getElementById('tab-' + tabId).classList.remove('hidden');
      // Activate selected tab
      document.querySelector(`.settings-tab[data-tab="${tabId}"]`).classList.add('active');
    }

    async function saveSettings(section) {
      const mapping = fieldMappings[section];
      if (!mapping) {
        admin.toast('Unknown settings section', 'error');
        return;
      }

      const backendCategory = getBackendCategory(section);

      // Find the save button in this section
      const tabEl = document.getElementById('tab-' + section);
      const btn = tabEl ? tabEl.querySelector('.btn-primary') : null;
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'Saving...';
      }

      try {
        // Collect form values
        const settings = {};
        for (const [elementId, dbKey] of Object.entries(mapping)) {
          const element = document.getElementById(elementId);
          if (!element) continue;

          if (element.type === 'checkbox') {
            settings[dbKey] = element.checked;
          } else if (element.type === 'number') {
            settings[dbKey] = parseInt(element.value) || 0;
          } else {
            settings[dbKey] = element.value.trim();
          }
        }

        const response = await api.put(`/admin/settings/${backendCategory}`, { settings });
        if (response.success) {
          admin.toast(`${section.charAt(0).toUpperCase() + section.slice(1)} settings saved successfully`, 'success');
        } else {
          admin.toast(response.error || `Failed to save ${section} settings`, 'error');
        }
      } catch (err) {
        console.error(`Failed to save ${section} settings:`, err);
        admin.toast(`Failed to save ${section} settings: ` + err.message, 'error');
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Save Changes';
        }
      }
    }

    async function regenerateSecret() {
      if (!await admin.confirm('Regenerating the JWT secret will invalidate all existing sessions. All users will need to login again. Continue?')) return;

      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'Generating...';

      try {
        const response = await api.post('/admin/settings/regenerate-jwt-secret');
        if (response.success) {
          admin.toast('JWT secret regenerated successfully. All users will need to login again.', 'success');
          // Update the display to show new masked secret
          document.getElementById('jwt-secret').value = '••••••••••••••••';
        } else {
          admin.toast(response.error || 'Failed to regenerate JWT secret', 'error');
        }
      } catch (err) {
        console.error('Failed to regenerate JWT secret:', err);
        admin.toast('Failed to regenerate JWT secret: ' + err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Regenerate';
      }
    }
  </script>
</body>
</html>
