<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Categories - Admin Panel</title>
  <link rel="stylesheet" href="/css/global.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/admin.css">
  <script src="/js/theme.js"></script>
</head>
<body>
  <div class="admin-layout">
    <aside class="admin-sidebar" id="admin-sidebar"></aside>

    <main class="admin-main">
      <header class="admin-header" id="admin-header"></header>

      <div class="admin-content">
        <div class="admin-page-header">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: var(--space-4);">
            <div>
              <h1 class="admin-page-title">Category Management</h1>
              <p class="admin-page-subtitle">Organize products into categories for better navigation</p>
            </div>
            <button class="btn btn-primary" onclick="openCreateModal()">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.5rem;">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              Add Category
            </button>
          </div>
        </div>

        <!-- Categories Grid -->
        <div id="categories-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: var(--space-4);">
          <div class="admin-card" style="padding: var(--space-8); text-align: center; color: var(--color-gray-500);">
            Loading categories...
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Create/Edit Modal -->
  <div id="category-modal" class="admin-modal-backdrop hidden" style="display: none;">
    <div class="admin-modal">
      <div class="admin-modal-header">
        <h3 class="admin-modal-title" id="modal-title">Add Category</h3>
        <button class="admin-modal-close" onclick="closeModal()">&times;</button>
      </div>
      <form id="category-form" onsubmit="handleSubmit(event)">
        <input type="hidden" name="id" id="category-id">
        <div class="admin-modal-body">
          <div class="admin-form-group">
            <label class="admin-form-label">Category Name *</label>
            <input type="text" name="name" id="category-name" class="admin-form-input" required placeholder="e.g., Dairy">
          </div>
          <div class="admin-form-group">
            <label class="admin-form-label">Icon (emoji)</label>
            <input type="text" name="icon" id="category-icon" class="admin-form-input" placeholder="e.g., milk glass emoji" maxlength="4">
          </div>
          <div class="admin-form-group">
            <label class="admin-form-label">Parent Category</label>
            <select name="parent_id" id="category-parent" class="admin-form-select">
              <option value="">None (Top Level)</option>
            </select>
          </div>
          <div class="admin-form-group">
            <label class="admin-form-label">Sort Order</label>
            <input type="number" name="sort_order" id="category-sort" class="admin-form-input" value="0" min="0">
          </div>
          <div class="admin-form-group">
            <label class="admin-form-label">Description</label>
            <textarea name="description" id="category-description" class="admin-form-input" rows="2" placeholder="Optional description..."></textarea>
          </div>
          <div class="admin-form-error" id="form-error"></div>
        </div>
        <div class="admin-modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" id="submit-btn">Add Category</button>
        </div>
      </form>
    </div>
  </div>

  <script src="/js/api.js"></script>
  <script src="/js/auth.js"></script>
  <script src="/js/admin-common.js"></script>
  <script src="/js/admin-sidebar.js"></script>
  <script>
    let categories = [];
    let editingId = null;

    document.addEventListener('DOMContentLoaded', async () => {
      if (!await admin.init()) return;

      initAdminSidebar('categories');
      document.getElementById('admin-header').innerHTML = renderAdminHeader([
        { label: 'Admin', href: '/admin/' },
        { label: 'Categories', href: '/admin/categories/' }
      ]);

      await loadCategories();
    });

    async function loadCategories() {
      categories = [
        { id: 1, name: 'Dairy', icon: 'ü•õ', parent_id: null, item_count: 156, sort_order: 1, description: 'Milk, cheese, yogurt, and eggs' },
        { id: 2, name: 'Produce', icon: 'ü•¨', parent_id: null, item_count: 234, sort_order: 2, description: 'Fresh fruits and vegetables' },
        { id: 3, name: 'Meat & Seafood', icon: 'ü•©', parent_id: null, item_count: 89, sort_order: 3, description: 'Fresh and frozen meats, fish, and poultry' },
        { id: 4, name: 'Bakery', icon: 'üçû', parent_id: null, item_count: 67, sort_order: 4, description: 'Bread, pastries, and baked goods' },
        { id: 5, name: 'Frozen', icon: 'üßä', parent_id: null, item_count: 123, sort_order: 5, description: 'Frozen meals, vegetables, and desserts' },
        { id: 6, name: 'Beverages', icon: 'ü•§', parent_id: null, item_count: 98, sort_order: 6, description: 'Drinks, juices, and sodas' },
        { id: 7, name: 'Snacks', icon: 'üçø', parent_id: null, item_count: 145, sort_order: 7, description: 'Chips, crackers, and cookies' },
        { id: 8, name: 'Pantry', icon: 'ü•´', parent_id: null, item_count: 189, sort_order: 8, description: 'Canned goods, pasta, and dry goods' },
      ];

      updateParentSelect();
      renderCategories();
    }

    function updateParentSelect() {
      const select = document.getElementById('category-parent');
      select.innerHTML = '<option value="">None (Top Level)</option>' +
        categories.filter(c => !c.parent_id).map(c =>
          `<option value="${c.id}">${c.icon} ${admin.escapeHtml(c.name)}</option>`
        ).join('');
    }

    function renderCategories() {
      const grid = document.getElementById('categories-grid');

      if (categories.length === 0) {
        grid.innerHTML = `
          <div class="admin-card" style="grid-column: 1 / -1;">
            <div class="admin-empty-state">
              <svg class="admin-empty-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
              </svg>
              <div class="admin-empty-title">No categories found</div>
              <div class="admin-empty-text">Add your first category to organize items</div>
              <button class="btn btn-primary" onclick="openCreateModal()">Add Category</button>
            </div>
          </div>
        `;
        return;
      }

      grid.innerHTML = categories.map(cat => `
        <div class="admin-card" style="cursor: pointer; transition: all var(--transition-fast);" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='none'">
          <div class="admin-card-body" style="display: flex; align-items: center; gap: var(--space-4);">
            <div style="width: 3rem; height: 3rem; background: var(--color-gray-100); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
              ${cat.icon || 'üì¶'}
            </div>
            <div style="flex: 1; min-width: 0;">
              <h3 style="font-weight: var(--font-semibold); margin-bottom: 2px;">${admin.escapeHtml(cat.name)}</h3>
              <p style="font-size: var(--text-xs); color: var(--color-gray-500); margin: 0;">${cat.item_count} items</p>
            </div>
            <div class="admin-table-actions">
              <button class="admin-table-btn" onclick="event.stopPropagation(); editCategory(${cat.id})" title="Edit">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
              </button>
              <button class="admin-table-btn danger" onclick="event.stopPropagation(); deleteCategory(${cat.id})" title="Delete">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
              </button>
            </div>
          </div>
          <div style="padding: 0 var(--space-5) var(--space-4);">
            <p style="font-size: var(--text-sm); color: var(--color-gray-500); margin: 0;">
              ${admin.escapeHtml(cat.description || 'No description')}
            </p>
          </div>
        </div>
      `).join('');
    }

    function openCreateModal() {
      editingId = null;
      document.getElementById('modal-title').textContent = 'Add Category';
      document.getElementById('submit-btn').textContent = 'Add Category';
      document.getElementById('category-form').reset();
      document.getElementById('form-error').textContent = '';
      modal.open('category-modal');
    }

    function editCategory(id) {
      const cat = categories.find(c => c.id === id);
      if (!cat) return;

      editingId = id;
      document.getElementById('modal-title').textContent = 'Edit Category';
      document.getElementById('submit-btn').textContent = 'Save Changes';
      document.getElementById('category-id').value = cat.id;
      document.getElementById('category-name').value = cat.name || '';
      document.getElementById('category-icon').value = cat.icon || '';
      document.getElementById('category-parent').value = cat.parent_id || '';
      document.getElementById('category-sort').value = cat.sort_order || 0;
      document.getElementById('category-description').value = cat.description || '';
      document.getElementById('form-error').textContent = '';
      modal.open('category-modal');
    }

    function closeModal() { modal.close('category-modal'); }

    async function handleSubmit(e) {
      e.preventDefault();
      admin.toast(editingId ? 'Category updated successfully' : 'Category created successfully', 'success');
      closeModal();
      loadCategories();
    }

    async function deleteCategory(id) {
      if (!await admin.confirm('Delete this category? Items will become uncategorized.')) return;
      admin.toast('Category deleted successfully', 'success');
      loadCategories();
    }
  </script>
</body>
</html>
