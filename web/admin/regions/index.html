<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Regions - Admin Panel</title>
  <link rel="stylesheet" href="/css/global.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/admin.css">
  <script src="/js/theme.js"></script>
</head>
<body>
  <div class="admin-layout">
    <aside class="admin-sidebar" id="admin-sidebar"></aside>

    <main class="admin-main">
      <header class="admin-header" id="admin-header"></header>

      <div class="admin-content">
        <div class="admin-page-header">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: var(--space-4);">
            <div>
              <h1 class="admin-page-title">Region Management</h1>
              <p class="admin-page-subtitle">Manage geographic regions for price tracking and store grouping</p>
            </div>
            <button class="btn btn-primary" onclick="openCreateModal()">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.5rem;">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              Add Region
            </button>
          </div>
        </div>

        <!-- Stats -->
        <div class="admin-stats-grid" style="grid-template-columns: repeat(4, 1fr);">
          <div class="admin-stat-card">
            <div class="admin-stat-header">
              <div class="admin-stat-icon primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="2" y1="12" x2="22" y2="12"></line>
                </svg>
              </div>
            </div>
            <div class="admin-stat-value" id="stat-total">-</div>
            <div class="admin-stat-label">Total Regions</div>
          </div>
          <div class="admin-stat-card">
            <div class="admin-stat-header">
              <div class="admin-stat-icon secondary">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="7" height="7"></rect>
                  <rect x="14" y="3" width="7" height="7"></rect>
                  <rect x="14" y="14" width="7" height="7"></rect>
                  <rect x="3" y="14" width="7" height="7"></rect>
                </svg>
              </div>
            </div>
            <div class="admin-stat-value" id="stat-states">-</div>
            <div class="admin-stat-label">States</div>
          </div>
          <div class="admin-stat-card">
            <div class="admin-stat-header">
              <div class="admin-stat-icon accent">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                  <circle cx="12" cy="10" r="3"></circle>
                </svg>
              </div>
            </div>
            <div class="admin-stat-value" id="stat-zips">-</div>
            <div class="admin-stat-label">ZIP Codes</div>
          </div>
          <div class="admin-stat-card">
            <div class="admin-stat-header">
              <div class="admin-stat-icon gray">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="11" cy="11" r="8"></circle>
                  <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
              </div>
            </div>
            <div class="admin-stat-value" id="stat-showing">-</div>
            <div class="admin-stat-label">Showing</div>
          </div>
        </div>

        <!-- Search and Filters -->
        <div class="admin-card" style="margin-bottom: var(--space-4);">
          <div class="admin-card-body" style="padding: var(--space-4);">
            <div style="display: flex; gap: var(--space-4); flex-wrap: wrap; align-items: center;">
              <div style="flex: 1; min-width: 250px;">
                <div style="position: relative;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--color-gray-400);">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                  </svg>
                  <input type="text" id="search-input" class="admin-form-input" placeholder="Search by city, state, or ZIP code..." style="padding-left: 40px;">
                </div>
              </div>
              <div style="min-width: 150px;">
                <select id="state-filter" class="admin-form-input">
                  <option value="">All States</option>
                </select>
              </div>
              <div style="min-width: 120px;">
                <select id="per-page" class="admin-form-input">
                  <option value="25">25 per page</option>
                  <option value="50" selected>50 per page</option>
                  <option value="100">100 per page</option>
                </select>
              </div>
              <button class="btn btn-secondary" onclick="resetFilters()">Reset</button>
            </div>
          </div>
        </div>

        <!-- Regions Table -->
        <div class="admin-card">
          <div class="admin-table-wrapper">
            <table class="admin-table">
              <thead>
                <tr>
                  <th style="width: 40%;">Region</th>
                  <th style="width: 10%;">State</th>
                  <th style="width: 15%;">ZIP Codes</th>
                  <th style="width: 10%;">Stores</th>
                  <th style="width: 10%;">Users</th>
                  <th style="width: 15%;">Actions</th>
                </tr>
              </thead>
              <tbody id="regions-tbody">
                <tr>
                  <td colspan="6" style="text-align: center; padding: var(--space-8); color: var(--color-gray-500);">Loading regions...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Pagination -->
        <div id="pagination" style="display: flex; justify-content: space-between; align-items: center; margin-top: var(--space-4); flex-wrap: wrap; gap: var(--space-4);">
          <div id="pagination-info" style="font-size: var(--text-sm); color: var(--color-gray-600);"></div>
          <div id="pagination-buttons" style="display: flex; gap: var(--space-2);"></div>
        </div>
      </div>
    </main>
  </div>

  <!-- Create/Edit Modal -->
  <div id="region-modal" class="admin-modal-backdrop hidden" style="display: none;">
    <div class="admin-modal" style="max-width: 600px;">
      <div class="admin-modal-header">
        <h3 class="admin-modal-title" id="modal-title">Add Region</h3>
        <button class="admin-modal-close" onclick="closeModal()">&times;</button>
      </div>
      <form id="region-form" onsubmit="handleSubmit(event)">
        <input type="hidden" name="id" id="region-id">
        <div class="admin-modal-body">
          <div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--space-4);">
            <div class="admin-form-group">
              <label class="admin-form-label">City/Region Name *</label>
              <input type="text" name="name" id="region-name" class="admin-form-input" required placeholder="e.g., Colorado Springs">
            </div>
            <div class="admin-form-group">
              <label class="admin-form-label">State *</label>
              <input type="text" name="state" id="region-state" class="admin-form-input" required placeholder="CO" maxlength="2" style="text-transform: uppercase;">
            </div>
          </div>
          <div class="admin-form-group">
            <label class="admin-form-label">ZIP Codes</label>
            <textarea name="zip_codes" id="region-zips" class="admin-form-input" rows="4" placeholder="Enter ZIP codes separated by commas or newlines...&#10;80903, 80904, 80905, 80906"></textarea>
            <small style="color: var(--color-gray-500); font-size: var(--text-xs);">Separate ZIP codes with commas, spaces, or newlines</small>
          </div>
          <div class="admin-form-error" id="form-error"></div>
        </div>
        <div class="admin-modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" id="submit-btn">Add Region</button>
        </div>
      </form>
    </div>
  </div>

  <!-- View Details Modal -->
  <div id="details-modal" class="admin-modal-backdrop hidden" style="display: none;">
    <div class="admin-modal" style="max-width: 700px;">
      <div class="admin-modal-header">
        <h3 class="admin-modal-title" id="details-title">Region Details</h3>
        <button class="admin-modal-close" onclick="closeDetailsModal()">&times;</button>
      </div>
      <div class="admin-modal-body" id="details-body">
        Loading...
      </div>
      <div class="admin-modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeDetailsModal()">Close</button>
        <button type="button" class="btn btn-primary" id="edit-from-details" onclick="editFromDetails()">Edit Region</button>
      </div>
    </div>
  </div>

  <script src="/js/api.js"></script>
  <script src="/js/auth.js"></script>
  <script src="/js/admin-common.js"></script>
  <script src="/js/admin-sidebar.js"></script>
  <script>
    // State
    let regions = [];
    let currentPage = 0;
    let totalRegions = 0;
    let perPage = 50;
    let searchQuery = '';
    let stateFilter = '';
    let editingId = null;
    let viewingRegion = null;

    // Debounced search
    const debouncedSearch = admin.debounce(() => {
      currentPage = 0;
      loadRegions();
    }, 300);

    document.addEventListener('DOMContentLoaded', async () => {
      if (!await admin.init()) return;

      initAdminSidebar('regions');
      document.getElementById('admin-header').innerHTML = renderAdminHeader([
        { label: 'Admin', href: '/admin/' },
        { label: 'Regions', href: '/admin/regions/' }
      ]);

      // Setup event listeners
      document.getElementById('search-input').addEventListener('input', (e) => {
        searchQuery = e.target.value;
        debouncedSearch();
      });

      document.getElementById('state-filter').addEventListener('change', (e) => {
        stateFilter = e.target.value;
        currentPage = 0;
        loadRegions();
      });

      document.getElementById('per-page').addEventListener('change', (e) => {
        perPage = parseInt(e.target.value);
        currentPage = 0;
        loadRegions();
      });

      // Initial load
      await Promise.all([
        loadStats(),
        loadStates(),
        loadRegions()
      ]);

      modal.setupBackdropClose();
    });

    async function loadStats() {
      try {
        const response = await regionsApi.getStats();
        const stats = response?.data || response;
        document.getElementById('stat-total').textContent = admin.formatNumber(stats.total_regions || 0);
        document.getElementById('stat-states').textContent = admin.formatNumber(stats.total_states || 0);
        document.getElementById('stat-zips').textContent = admin.formatNumber(stats.total_zips || 0);
      } catch (err) {
        console.error('Failed to load stats:', err);
      }
    }

    async function loadStates() {
      try {
        const response = await regionsApi.getStates();
        const states = response?.data || response || [];
        const select = document.getElementById('state-filter');
        states.forEach(state => {
          const option = document.createElement('option');
          option.value = state;
          option.textContent = state;
          select.appendChild(option);
        });
      } catch (err) {
        console.error('Failed to load states:', err);
      }
    }

    async function loadRegions() {
      const tbody = document.getElementById('regions-tbody');
      tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: var(--space-8); color: var(--color-gray-500);">Loading...</td></tr>';

      try {
        const response = await regionsApi.list({
          limit: perPage,
          offset: currentPage * perPage,
          search: searchQuery,
          state: stateFilter
        });

        regions = response?.data || response || [];
        totalRegions = response?.meta?.total || regions.length;

        // Update showing stat
        const start = currentPage * perPage + 1;
        const end = Math.min((currentPage + 1) * perPage, totalRegions);
        document.getElementById('stat-showing').textContent = totalRegions > 0 ? `${start}-${end}` : '0';

        renderRegions();
        renderPagination();
      } catch (err) {
        console.error('Failed to load regions:', err);
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: var(--space-8); color: var(--color-error);">Failed to load regions</td></tr>';
      }
    }

    function renderRegions() {
      const tbody = document.getElementById('regions-tbody');

      if (regions.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; padding: var(--space-8);">
              <div style="color: var(--color-gray-500);">
                ${searchQuery || stateFilter ? 'No regions match your search' : 'No regions found'}
              </div>
              ${!searchQuery && !stateFilter ? '<button class="btn btn-primary btn-sm" style="margin-top: var(--space-4);" onclick="openCreateModal()">Add First Region</button>' : ''}
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = regions.map(region => `
        <tr>
          <td>
            <div style="font-weight: var(--font-medium);">${admin.escapeHtml(region.name)}</div>
          </td>
          <td>
            <span class="badge badge-secondary">${admin.escapeHtml(region.state)}</span>
          </td>
          <td>
            <span style="color: var(--color-gray-600);">${region.zip_codes?.length || 0} codes</span>
          </td>
          <td>
            <span style="font-weight: var(--font-medium); color: var(--color-primary-600);">${region.store_count || 0}</span>
          </td>
          <td>
            <span style="font-weight: var(--font-medium); color: var(--color-secondary-600);">${region.user_count || 0}</span>
          </td>
          <td>
            <div class="admin-table-actions">
              <button class="admin-table-btn" onclick="viewRegion(${region.id})" title="View Details">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
              </button>
              <button class="admin-table-btn" onclick="editRegion(${region.id})" title="Edit">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
              </button>
              <button class="admin-table-btn danger" onclick="deleteRegion(${region.id}, '${admin.escapeHtml(region.name)}')" title="Delete">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function renderPagination() {
      const totalPages = Math.ceil(totalRegions / perPage);
      const info = document.getElementById('pagination-info');
      const buttons = document.getElementById('pagination-buttons');

      // Info text
      const start = currentPage * perPage + 1;
      const end = Math.min((currentPage + 1) * perPage, totalRegions);
      info.textContent = totalRegions > 0
        ? `Showing ${start} to ${end} of ${totalRegions.toLocaleString()} regions`
        : 'No regions found';

      // Pagination buttons
      if (totalPages <= 1) {
        buttons.innerHTML = '';
        return;
      }

      let html = '';

      // Previous button
      html += `<button class="btn btn-secondary btn-sm" ${currentPage === 0 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">Previous</button>`;

      // Page numbers (show max 5 pages around current)
      const startPage = Math.max(0, currentPage - 2);
      const endPage = Math.min(totalPages - 1, currentPage + 2);

      if (startPage > 0) {
        html += `<button class="btn btn-secondary btn-sm" onclick="goToPage(0)">1</button>`;
        if (startPage > 1) html += `<span style="padding: 0 8px; color: var(--color-gray-400);">...</span>`;
      }

      for (let i = startPage; i <= endPage; i++) {
        html += `<button class="btn ${i === currentPage ? 'btn-primary' : 'btn-secondary'} btn-sm" onclick="goToPage(${i})">${i + 1}</button>`;
      }

      if (endPage < totalPages - 1) {
        if (endPage < totalPages - 2) html += `<span style="padding: 0 8px; color: var(--color-gray-400);">...</span>`;
        html += `<button class="btn btn-secondary btn-sm" onclick="goToPage(${totalPages - 1})">${totalPages}</button>`;
      }

      // Next button
      html += `<button class="btn btn-secondary btn-sm" ${currentPage >= totalPages - 1 ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">Next</button>`;

      buttons.innerHTML = html;
    }

    function goToPage(page) {
      currentPage = page;
      loadRegions();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function resetFilters() {
      document.getElementById('search-input').value = '';
      document.getElementById('state-filter').value = '';
      searchQuery = '';
      stateFilter = '';
      currentPage = 0;
      loadRegions();
    }

    // Modal functions
    function openCreateModal() {
      editingId = null;
      document.getElementById('modal-title').textContent = 'Add Region';
      document.getElementById('submit-btn').textContent = 'Add Region';
      document.getElementById('region-form').reset();
      document.getElementById('form-error').textContent = '';
      modal.open('region-modal');
    }

    function editRegion(id) {
      const region = regions.find(r => r.id === id);
      if (!region) return;

      editingId = id;
      document.getElementById('modal-title').textContent = 'Edit Region';
      document.getElementById('submit-btn').textContent = 'Save Changes';
      document.getElementById('region-id').value = region.id;
      document.getElementById('region-name').value = region.name || '';
      document.getElementById('region-state').value = region.state || '';
      document.getElementById('region-zips').value = (region.zip_codes || []).join(', ');
      document.getElementById('form-error').textContent = '';
      modal.open('region-modal');
    }

    function closeModal() {
      modal.close('region-modal');
    }

    async function handleSubmit(e) {
      e.preventDefault();
      const errorEl = document.getElementById('form-error');
      const submitBtn = document.getElementById('submit-btn');
      errorEl.textContent = '';

      const name = document.getElementById('region-name').value.trim();
      const state = document.getElementById('region-state').value.trim().toUpperCase();
      const zipsRaw = document.getElementById('region-zips').value;

      // Parse zip codes
      const zipCodes = zipsRaw
        .split(/[\s,]+/)
        .map(z => z.trim())
        .filter(z => z.length > 0);

      const data = { name, state, zip_codes: zipCodes };

      submitBtn.disabled = true;
      submitBtn.textContent = editingId ? 'Saving...' : 'Creating...';

      try {
        if (editingId) {
          await regionsApi.update(editingId, data);
          admin.toast('Region updated successfully', 'success');
        } else {
          await regionsApi.create(data);
          admin.toast('Region created successfully', 'success');
        }
        closeModal();
        loadRegions();
        loadStats();
      } catch (err) {
        errorEl.textContent = err.message || 'Failed to save region';
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = editingId ? 'Save Changes' : 'Add Region';
      }
    }

    async function deleteRegion(id, name) {
      if (!await admin.confirm(`Delete "${name}"? This will unassign any stores and users from this region.`)) return;

      try {
        await regionsApi.delete(id);
        admin.toast('Region deleted successfully', 'success');
        loadRegions();
        loadStats();
      } catch (err) {
        admin.toast(err.message || 'Failed to delete region', 'error');
      }
    }

    // View details modal
    async function viewRegion(id) {
      viewingRegion = regions.find(r => r.id === id);
      if (!viewingRegion) return;

      document.getElementById('details-title').textContent = `${viewingRegion.name}, ${viewingRegion.state}`;

      const zips = viewingRegion.zip_codes || [];
      const zipDisplay = zips.length > 0
        ? `<div style="display: flex; flex-wrap: wrap; gap: 4px; max-height: 200px; overflow-y: auto;">${zips.map(z => `<span class="badge badge-secondary" style="font-family: monospace;">${admin.escapeHtml(z)}</span>`).join('')}</div>`
        : '<span style="color: var(--color-gray-500);">No ZIP codes assigned</span>';

      document.getElementById('details-body').innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-4); margin-bottom: var(--space-6);">
          <div style="padding: var(--space-4); background: var(--color-gray-50); border-radius: var(--radius-lg); text-align: center;">
            <div style="font-size: var(--text-2xl); font-weight: var(--font-bold); color: var(--color-primary-600);">${viewingRegion.store_count || 0}</div>
            <div style="font-size: var(--text-sm); color: var(--color-gray-500);">Stores</div>
          </div>
          <div style="padding: var(--space-4); background: var(--color-gray-50); border-radius: var(--radius-lg); text-align: center;">
            <div style="font-size: var(--text-2xl); font-weight: var(--font-bold); color: var(--color-secondary-600);">${viewingRegion.user_count || 0}</div>
            <div style="font-size: var(--text-sm); color: var(--color-gray-500);">Users</div>
          </div>
          <div style="padding: var(--space-4); background: var(--color-gray-50); border-radius: var(--radius-lg); text-align: center;">
            <div style="font-size: var(--text-2xl); font-weight: var(--font-bold); color: var(--color-accent-600);">${admin.formatNumber(viewingRegion.price_count || 0)}</div>
            <div style="font-size: var(--text-sm); color: var(--color-gray-500);">Prices</div>
          </div>
        </div>

        <div class="admin-form-group">
          <label class="admin-form-label">ZIP Codes (${zips.length})</label>
          ${zipDisplay}
        </div>

        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-4); margin-top: var(--space-4); font-size: var(--text-sm); color: var(--color-gray-500);">
          <div>
            <strong>Created:</strong> ${admin.formatDateFull(viewingRegion.created_at)}
          </div>
          <div>
            <strong>Updated:</strong> ${admin.formatDateFull(viewingRegion.updated_at)}
          </div>
        </div>
      `;

      modal.open('details-modal');
    }

    function closeDetailsModal() {
      modal.close('details-modal');
    }

    function editFromDetails() {
      if (viewingRegion) {
        closeDetailsModal();
        editRegion(viewingRegion.id);
      }
    }
  </script>
</body>
</html>
