<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verify Email - Price Feed</title>
  <link rel="stylesheet" href="/css/global.css">
  <link rel="stylesheet" href="/css/components.css">
  <style>
    .verify-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-4);
    }

    .verify-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: var(--space-8);
      max-width: 400px;
      width: 100%;
      text-align: center;
    }

    .verify-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto var(--space-4);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .verify-icon.loading {
      background: var(--muted);
      color: var(--muted-foreground);
    }

    .verify-icon.success {
      background: #dcfce7;
      color: #16a34a;
    }

    .verify-icon.error {
      background: #fee2e2;
      color: #dc2626;
    }

    .dark .verify-icon.success {
      background: rgba(22, 163, 74, 0.2);
    }

    .dark .verify-icon.error {
      background: rgba(220, 38, 38, 0.2);
    }

    .verify-title {
      font-size: var(--text-xl);
      font-weight: var(--font-semibold);
      margin-bottom: var(--space-2);
    }

    .verify-message {
      color: var(--muted-foreground);
      margin-bottom: var(--space-6);
    }

    .spinner {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="navbar-container"></div>

  <main class="verify-container">
    <div class="verify-card">
      <div id="verify-status">
        <div class="verify-icon loading">
          <svg class="spinner" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
          </svg>
        </div>
        <h1 class="verify-title">Verifying your email...</h1>
        <p class="verify-message">Please wait while we verify your email address.</p>
      </div>
    </div>
  </main>

  <div id="footer-container"></div>

  <script src="/js/api.js"></script>
  <script src="/js/auth.js"></script>
  <script src="/js/components.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');

      if (!token) {
        showResult('error', 'Missing Token', 'No verification token was provided. Please check your email for the correct verification link.');
        return;
      }

      try {
        const response = await api.get(`/auth/verify-email?token=${encodeURIComponent(token)}`);

        if (response.success) {
          showResult('success', 'Email Verified!', 'Your email has been successfully verified. You can now access all features of PriceFeed.');

          // If user is logged in, refresh their data
          if (authApi.isLoggedIn()) {
            try {
              const meResponse = await api.get('/auth/me');
              if (meResponse.success) {
                auth.user = meResponse.data;
                auth.updateUI();
              }
            } catch (e) {
              // Ignore error
            }
          }
        } else {
          showResult('error', 'Verification Failed', response.error || 'Unable to verify your email. The link may be invalid or expired.');
        }
      } catch (err) {
        showResult('error', 'Verification Failed', err.message || 'An error occurred while verifying your email.');
      }
    });

    function showResult(type, title, message) {
      const container = document.getElementById('verify-status');

      const icon = type === 'success'
        ? '<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>'
        : '<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>';

      const buttonHtml = type === 'success'
        ? '<a href="/user/" class="btn btn-primary btn-full">Go to Dashboard</a>'
        : '<a href="/login/" class="btn btn-primary btn-full">Back to Login</a>';

      container.innerHTML = `
        <div class="verify-icon ${type}">
          ${icon}
        </div>
        <h1 class="verify-title">${title}</h1>
        <p class="verify-message">${message}</p>
        ${buttonHtml}
      `;
    }
  </script>
</body>
</html>
