<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Import Shopping List - PriceFeed</title>
  <link rel="stylesheet" href="/css/global.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/user.css">
  <script src="/js/theme.js"></script>
  <style>
    /* Import textarea */
    .import-textarea {
      width: 100%;
      min-height: 200px;
      padding: var(--space-4);
      border: 2px dashed var(--border);
      border-radius: var(--radius-lg);
      font-family: var(--font-mono);
      font-size: var(--text-sm);
      line-height: 1.6;
      resize: vertical;
      transition: border-color 0.2s;
    }

    .import-textarea:focus {
      outline: none;
      border-color: var(--color-primary-500);
      border-style: solid;
    }

    .import-textarea::placeholder {
      color: var(--color-gray-400);
    }

    /* Stats bar */
    .stats-bar {
      display: flex;
      gap: var(--space-6);
      padding: var(--space-4);
      background: var(--color-gray-100);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-6);
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: var(--text-2xl);
      font-weight: var(--font-bold);
      color: var(--foreground);
    }

    .stat-value.success { color: var(--color-primary-600); }
    .stat-value.warning { color: var(--color-warning-600); }

    .stat-label {
      font-size: var(--text-xs);
      color: var(--color-gray-500);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Import item cards */
    .import-items {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }

    .import-item {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      transition: all 0.15s;
    }

    .import-item.matched {
      border-left: 4px solid var(--color-primary-500);
    }

    .import-item.unmatched {
      border-left: 4px solid var(--color-warning-500);
    }

    .import-item-header {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .import-item-checkbox {
      flex-shrink: 0;
    }

    .import-item-checkbox input {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .import-item-info {
      flex: 1;
      min-width: 0;
    }

    .import-item-name {
      font-weight: var(--font-semibold);
      color: var(--foreground);
      margin-bottom: 2px;
    }

    .import-item-raw {
      font-size: var(--text-sm);
      color: var(--color-gray-500);
      font-family: var(--font-mono);
    }

    .import-item-parsed {
      font-size: var(--text-sm);
      color: var(--color-gray-600);
      margin-top: 4px;
    }

    .import-item-parsed .notes {
      color: var(--color-gray-400);
      font-style: italic;
    }

    /* Confidence badge */
    .confidence-badge {
      padding: 4px 10px;
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: var(--font-semibold);
      white-space: nowrap;
    }

    .confidence-badge.confidence-high {
      background: #dcfce7;
      color: #166534;
    }

    .confidence-badge.confidence-medium {
      background: #fef3c7;
      color: #92400e;
    }

    .confidence-badge.confidence-low {
      background: #fee2e2;
      color: #991b1b;
    }

    /* Edit form for unmatched items */
    .import-item-form {
      margin-top: var(--space-3);
      padding-top: var(--space-3);
      border-top: 1px solid var(--border);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: var(--space-3);
      align-items: end;
    }

    @media (max-width: 600px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }

    /* Suggestions */
    .import-suggestions {
      margin-top: var(--space-2);
      padding: var(--space-2);
      background: var(--color-gray-100);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
    }

    .suggestions-label {
      color: var(--color-gray-500);
      margin-right: var(--space-2);
    }

    .suggestion-btn {
      display: inline-block;
      padding: 4px 10px;
      margin: 2px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: var(--text-xs);
      color: var(--foreground);
      cursor: pointer;
      transition: all 0.15s;
    }

    .suggestion-btn:hover {
      background: var(--color-primary-50);
      border-color: var(--color-primary-300);
      color: var(--color-primary-700);
    }

    /* Section headers */
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-4);
    }

    .section-title {
      font-size: var(--text-lg);
      font-weight: var(--font-semibold);
      color: var(--foreground);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .section-title svg {
      width: 20px;
      height: 20px;
    }

    .section-title .matched-icon { color: var(--color-primary-600); }
    .section-title .unmatched-icon { color: var(--color-warning-600); }

    /* Empty state */
    .empty-parse {
      text-align: center;
      padding: var(--space-8);
      color: var(--color-gray-500);
    }

    .empty-parse svg {
      width: 48px;
      height: 48px;
      margin-bottom: var(--space-3);
      color: var(--color-gray-300);
    }

    /* Actions footer */
    .actions-footer {
      display: flex;
      gap: var(--space-3);
      justify-content: flex-end;
      padding-top: var(--space-4);
      border-top: 1px solid var(--border);
      margin-top: var(--space-4);
    }

    /* Expand/collapse button */
    .btn-expand {
      padding: 4px 8px;
      border: 1px solid var(--border);
      background: var(--card);
      border-radius: var(--radius-md);
      font-size: var(--text-xs);
      color: var(--color-gray-600);
      cursor: pointer;
    }

    .btn-expand:hover {
      background: var(--color-gray-100);
    }

    /* Select all checkbox */
    .select-all-row {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-3);
      background: var(--color-gray-100);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-3);
    }

    .select-all-row label {
      font-size: var(--text-sm);
      color: var(--color-gray-600);
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="user-layout">
    <aside class="user-sidebar" id="user-sidebar"></aside>

    <main class="user-main">
      <header class="user-header" id="user-header"></header>

      <div class="user-content">
        <div class="user-page-header">
          <h1 class="user-page-title">Import Shopping List</h1>
          <p class="user-page-subtitle">Paste your Mealie shopping list to add items to your catalog.</p>
        </div>

        <!-- Input Section -->
        <div class="user-card" id="input-section">
          <h3 style="margin-bottom: var(--space-3);">Paste Shopping List</h3>
          <p style="color: var(--color-gray-500); font-size: var(--text-sm); margin-bottom: var(--space-4);">
            Copy your shopping list from Mealie (markdown format with checkboxes) and paste it below.
          </p>
          <textarea id="import-content" class="import-textarea" placeholder="- [ ] 1/2 cup butter, softened
- [ ] 2.5 - 3 lb salmon fillet
- [ ] 1 1/2 teaspoon Dijon mustard
- [ ] 1 cup strawberries (sliced)
- [ ] fresh basil, chopped"></textarea>
          <div style="margin-top: var(--space-4); display: flex; gap: var(--space-3);">
            <button class="btn btn-primary" onclick="parseList()" id="parse-btn">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
              </svg>
              Parse & Match Items
            </button>
            <button class="btn btn-secondary" onclick="clearInput()">Clear</button>
          </div>
        </div>

        <!-- Results Section (hidden until parsed) -->
        <div id="results-section" style="display: none;">
          <!-- Stats -->
          <div class="stats-bar">
            <div class="stat-item">
              <div class="stat-value" id="stat-total">0</div>
              <div class="stat-label">Total Items</div>
            </div>
            <div class="stat-item">
              <div class="stat-value success" id="stat-matched">0</div>
              <div class="stat-label">Matched</div>
            </div>
            <div class="stat-item">
              <div class="stat-value warning" id="stat-unmatched">0</div>
              <div class="stat-label">Need Review</div>
            </div>
          </div>

          <!-- Matched Items Section -->
          <div class="user-card" id="matched-section" style="display: none;">
            <div class="section-header">
              <div class="section-title">
                <svg class="matched-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                  <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
                Matched Items
              </div>
              <span style="font-size: var(--text-sm); color: var(--color-gray-500);">Already in your catalog</span>
            </div>
            <div id="matched-items" class="import-items"></div>
          </div>

          <!-- Unmatched Items Section -->
          <div class="user-card" id="unmatched-section" style="display: none;">
            <div class="section-header">
              <div class="section-title">
                <svg class="unmatched-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="8" x2="12" y2="12"></line>
                  <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
                Items to Review
              </div>
            </div>
            <p style="color: var(--color-gray-500); font-size: var(--text-sm); margin-bottom: var(--space-4);">
              These items weren't found in your catalog. Edit the details and select items to create.
            </p>

            <!-- Select All -->
            <div class="select-all-row">
              <input type="checkbox" id="select-all" onchange="toggleSelectAll()" checked>
              <label for="select-all">Select all items</label>
            </div>

            <div id="unmatched-items" class="import-items"></div>

            <!-- Bulk Create Button -->
            <div class="actions-footer">
              <button class="btn btn-secondary" onclick="window.location.href='/user/items/'">Cancel</button>
              <button class="btn btn-primary" onclick="createSelectedItems()" id="create-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Create Selected Items
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="/js/api.js"></script>
  <script src="/js/auth.js"></script>
  <script src="/js/components.js"></script>
  <script src="/js/user-common.js"></script>
  <script src="/js/user-sidebar.js"></script>
  <script>
    let parsedResults = null;
    let expandedForms = {};

    // Unit options for the select dropdown
    const UNIT_OPTIONS = [
      { value: '', label: 'None' },
      { group: 'Count', options: [
        { value: 'count', label: 'count' },
        { value: 'each', label: 'each' },
        { value: 'piece', label: 'piece' },
        { value: 'pack', label: 'pack' },
        { value: 'dozen', label: 'dozen' }
      ]},
      { group: 'Volume', options: [
        { value: 'teaspoon', label: 'teaspoon' },
        { value: 'tablespoon', label: 'tablespoon' },
        { value: 'cup', label: 'cup' },
        { value: 'pint', label: 'pint' },
        { value: 'quart', label: 'quart' },
        { value: 'gallon', label: 'gallon' },
        { value: 'fluid ounce', label: 'fluid ounce' },
        { value: 'milliliter', label: 'milliliter' },
        { value: 'liter', label: 'liter' }
      ]},
      { group: 'Weight', options: [
        { value: 'ounce', label: 'ounce' },
        { value: 'pound', label: 'pound' },
        { value: 'gram', label: 'gram' },
        { value: 'kilogram', label: 'kilogram' }
      ]},
      { group: 'Produce', options: [
        { value: 'head', label: 'head' },
        { value: 'bunch', label: 'bunch' },
        { value: 'stalk', label: 'stalk' },
        { value: 'clove', label: 'clove' },
        { value: 'sprig', label: 'sprig' }
      ]}
    ];

    document.addEventListener('DOMContentLoaded', async function() {
      if (!await user.init()) return;

      initUserSidebar('items');
      initUserHeader([
        { label: 'Dashboard', href: '/user/' },
        { label: 'Items', href: '/user/items/' },
        { label: 'Import', href: '/user/items/import.html' }
      ]);
    });

    async function parseList() {
      const content = document.getElementById('import-content').value.trim();
      if (!content) {
        user.toast('Please enter a shopping list', 'warning');
        return;
      }

      const parseBtn = document.getElementById('parse-btn');
      parseBtn.disabled = true;
      parseBtn.innerHTML = '<span>Parsing...</span>';

      try {
        const response = await importApi.parseShoppingList(content);
        parsedResults = response.data || response;
        renderResults();
        user.toast('Parsed ' + parsedResults.total_parsed + ' items', 'success');
      } catch (err) {
        user.toast('Failed to parse shopping list: ' + (err.message || 'Unknown error'), 'error');
      } finally {
        parseBtn.disabled = false;
        parseBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>Parse & Match Items';
      }
    }

    function clearInput() {
      document.getElementById('import-content').value = '';
      document.getElementById('results-section').style.display = 'none';
      parsedResults = null;
      expandedForms = {};
    }

    function renderResults() {
      const section = document.getElementById('results-section');
      section.style.display = 'block';

      // Update stats
      document.getElementById('stat-total').textContent = parsedResults.total_parsed;
      document.getElementById('stat-matched').textContent = parsedResults.matched_count;
      document.getElementById('stat-unmatched').textContent = parsedResults.unmatched_count;

      // Separate matched and unmatched
      const matched = parsedResults.items.filter(i => i.is_matched);
      const unmatched = parsedResults.items.filter(i => !i.is_matched);

      // Render matched items
      const matchedContainer = document.getElementById('matched-items');
      const matchedSection = document.getElementById('matched-section');
      if (matched.length > 0) {
        matchedSection.style.display = 'block';
        matchedContainer.innerHTML = matched.map(renderMatchedItem).join('');
      } else {
        matchedSection.style.display = 'none';
      }

      // Render unmatched items
      const unmatchedContainer = document.getElementById('unmatched-items');
      const unmatchedSection = document.getElementById('unmatched-section');
      if (unmatched.length > 0) {
        unmatchedSection.style.display = 'block';
        unmatchedContainer.innerHTML = unmatched.map(renderUnmatchedItem).join('');
      } else {
        unmatchedSection.style.display = 'none';
      }

      // Scroll to results
      section.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function getConfidenceLevel(confidence) {
      if (confidence >= 0.8) return 'high';
      if (confidence >= 0.6) return 'medium';
      return 'low';
    }

    function renderMatchedItem(item) {
      const match = item.best_match;
      const confidenceLevel = getConfidenceLevel(match.confidence);
      const confidencePercent = Math.round(match.confidence * 100);

      return '<div class="import-item matched">' +
        '<div class="import-item-header">' +
          '<div class="import-item-checkbox">' +
            '<input type="checkbox" checked disabled title="Already in catalog">' +
          '</div>' +
          '<div class="import-item-info">' +
            '<div class="import-item-name">' + user.escapeHtml(match.name) + '</div>' +
            '<div class="import-item-raw">' + user.escapeHtml(item.parsed_item.raw_text) + '</div>' +
          '</div>' +
          '<div class="confidence-badge confidence-' + confidenceLevel + '">' +
            confidencePercent + '% match' +
          '</div>' +
        '</div>' +
      '</div>';
    }

    function renderUnmatchedItem(item) {
      const parsed = item.parsed_item;
      const lineIdx = parsed.line_number;
      const isExpanded = expandedForms[lineIdx] || false;

      let html = '<div class="import-item unmatched" id="unmatched-' + lineIdx + '">';
      html += '<div class="import-item-header">';
      html += '<div class="import-item-checkbox">';
      html += '<input type="checkbox" id="select-' + lineIdx + '" checked onchange="updateSelectAll()">';
      html += '</div>';
      html += '<div class="import-item-info">';
      html += '<div class="import-item-raw">' + user.escapeHtml(parsed.raw_text) + '</div>';
      html += '<div class="import-item-parsed">';
      html += 'Parsed: ';
      if (parsed.quantity && parsed.quantity !== 1) {
        html += '<strong>' + parsed.quantity + '</strong> ';
      }
      if (parsed.unit) {
        html += parsed.unit + ' ';
      }
      html += '<strong>' + user.escapeHtml(parsed.name) + '</strong>';
      if (parsed.notes) {
        html += ' <span class="notes">(' + user.escapeHtml(parsed.notes) + ')</span>';
      }
      html += '</div>';
      html += '</div>';
      html += '<button class="btn-expand" onclick="toggleEditForm(' + lineIdx + ')">' + (isExpanded ? 'Collapse' : 'Edit') + '</button>';
      html += '</div>';

      // Edit form (expanded by default for first item, or if user expanded)
      html += '<div class="import-item-form" id="form-' + lineIdx + '" style="display: ' + (isExpanded ? 'block' : 'none') + ';">';
      html += '<div class="form-row">';
      html += '<div class="user-form-group" style="margin-bottom: 0;">';
      html += '<label class="user-form-label">Name</label>';
      html += '<input type="text" class="user-form-input" id="name-' + lineIdx + '" value="' + user.escapeHtml(parsed.name) + '">';
      html += '</div>';
      html += '<div class="user-form-group" style="margin-bottom: 0; width: 100px;">';
      html += '<label class="user-form-label">Size</label>';
      html += '<input type="number" step="0.01" class="user-form-input" id="size-' + lineIdx + '" value="' + (parsed.quantity || '') + '">';
      html += '</div>';
      html += '<div class="user-form-group" style="margin-bottom: 0; width: 150px;">';
      html += '<label class="user-form-label">Unit</label>';
      html += '<select class="user-form-select" id="unit-' + lineIdx + '">';
      html += generateUnitOptions(parsed.unit);
      html += '</select>';
      html += '</div>';
      html += '</div>';

      // Suggestions
      if (item.suggestions && item.suggestions.length > 0) {
        html += '<div class="import-suggestions">';
        html += '<span class="suggestions-label">Did you mean:</span>';
        const maxSuggestions = Math.min(item.suggestions.length, 3);
        for (let i = 0; i < maxSuggestions; i++) {
          const s = item.suggestions[i];
          const pct = Math.round(s.confidence * 100);
          html += '<button class="suggestion-btn" onclick="selectSuggestion(' + lineIdx + ', ' + s.item_id + ', \'' + user.escapeHtml(s.name).replace(/'/g, "\\'") + '\')">';
          html += user.escapeHtml(s.name) + ' (' + pct + '%)';
          html += '</button>';
        }
        html += '</div>';
      }

      html += '</div>';
      html += '</div>';

      return html;
    }

    function generateUnitOptions(selectedUnit) {
      let html = '';
      for (const group of UNIT_OPTIONS) {
        if (group.options) {
          html += '<optgroup label="' + group.group + '">';
          for (const opt of group.options) {
            const selected = (selectedUnit && selectedUnit.toLowerCase() === opt.value.toLowerCase()) ? ' selected' : '';
            html += '<option value="' + opt.value + '"' + selected + '>' + opt.label + '</option>';
          }
          html += '</optgroup>';
        } else {
          const selected = (!selectedUnit || selectedUnit === '') ? ' selected' : '';
          html += '<option value=""' + selected + '>' + group.label + '</option>';
        }
      }
      return html;
    }

    function toggleEditForm(lineIdx) {
      const form = document.getElementById('form-' + lineIdx);
      const btn = form.previousElementSibling.querySelector('.btn-expand');

      if (form.style.display === 'none') {
        form.style.display = 'block';
        btn.textContent = 'Collapse';
        expandedForms[lineIdx] = true;
      } else {
        form.style.display = 'none';
        btn.textContent = 'Edit';
        expandedForms[lineIdx] = false;
      }
    }

    function selectSuggestion(lineIdx, itemId, itemName) {
      // Update the name field with the suggestion
      const nameInput = document.getElementById('name-' + lineIdx);
      if (nameInput) {
        nameInput.value = itemName;
      }

      // Expand the form to show the change
      const form = document.getElementById('form-' + lineIdx);
      if (form.style.display === 'none') {
        toggleEditForm(lineIdx);
      }

      user.toast('Selected: ' + itemName, 'success');
    }

    function toggleSelectAll() {
      const selectAll = document.getElementById('select-all').checked;
      const unmatched = parsedResults.items.filter(i => !i.is_matched);

      for (const item of unmatched) {
        const checkbox = document.getElementById('select-' + item.parsed_item.line_number);
        if (checkbox) {
          checkbox.checked = selectAll;
        }
      }
    }

    function updateSelectAll() {
      const unmatched = parsedResults.items.filter(i => !i.is_matched);
      let allChecked = true;

      for (const item of unmatched) {
        const checkbox = document.getElementById('select-' + item.parsed_item.line_number);
        if (checkbox && !checkbox.checked) {
          allChecked = false;
          break;
        }
      }

      document.getElementById('select-all').checked = allChecked;
    }

    async function createSelectedItems() {
      const unmatched = parsedResults.items.filter(i => !i.is_matched);
      const itemsToCreate = [];

      for (const item of unmatched) {
        const lineIdx = item.parsed_item.line_number;
        const checkbox = document.getElementById('select-' + lineIdx);

        if (checkbox && checkbox.checked) {
          const nameEl = document.getElementById('name-' + lineIdx);
          const sizeEl = document.getElementById('size-' + lineIdx);
          const unitEl = document.getElementById('unit-' + lineIdx);

          const name = nameEl ? nameEl.value.trim() : item.parsed_item.name;
          const size = sizeEl && sizeEl.value ? parseFloat(sizeEl.value) : null;
          const unit = unitEl ? unitEl.value : null;

          if (name) {
            itemsToCreate.push({
              name: name,
              size: size,
              unit: unit || null,
              is_private: true
            });
          }
        }
      }

      if (itemsToCreate.length === 0) {
        user.toast('No items selected', 'warning');
        return;
      }

      const createBtn = document.getElementById('create-btn');
      createBtn.disabled = true;
      createBtn.innerHTML = '<span>Creating...</span>';

      try {
        const response = await importApi.bulkCreateItems(itemsToCreate);
        const result = response.data || response;

        if (result.created && result.created.length > 0) {
          user.toast('Created ' + result.created.length + ' item(s)', 'success');
        }

        if (result.errors && result.errors.length > 0) {
          console.warn('Some items failed to create:', result.errors);
          user.toast(result.errors.length + ' item(s) failed to create', 'warning');
        }

        // Redirect to items page after short delay
        setTimeout(function() {
          window.location.href = '/user/items/';
        }, 1000);

      } catch (err) {
        user.toast('Failed to create items: ' + (err.message || 'Unknown error'), 'error');
        createBtn.disabled = false;
        createBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>Create Selected Items';
      }
    }
  </script>
</body>
</html>
