<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Price Comparison - PriceFeed</title>
  <link rel="stylesheet" href="/css/global.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/user.css">
  <script src="/js/theme.js"></script>
  <style>
    /* View Toggle */
    .view-toggle {
      display: inline-flex;
      background: var(--color-gray-100);
      border-radius: var(--radius-lg);
      padding: 4px;
      gap: 4px;
    }

    .view-toggle-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border: none;
      background: transparent;
      color: var(--color-gray-500);
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.15s;
    }

    .view-toggle-btn:hover {
      color: var(--foreground);
    }

    .view-toggle-btn.active {
      background: var(--card);
      color: var(--foreground);
      box-shadow: var(--shadow-sm);
    }

    .view-toggle-btn svg {
      width: 16px;
      height: 16px;
    }

    /* Stats Bar */
    .stats-bar {
      display: flex;
      gap: var(--space-6);
      padding: var(--space-4);
      background: var(--color-gray-100);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-6);
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: var(--text-2xl);
      font-weight: var(--font-bold);
      color: var(--foreground);
    }

    .stat-label {
      font-size: var(--text-xs);
      color: var(--color-gray-500);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Card View Styles */
    .compare-cards {
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
    }

    .compare-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }

    .compare-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: var(--space-4);
      background: var(--color-gray-100);
      border-bottom: 1px solid var(--border);
    }

    .compare-card-title {
      font-size: var(--text-lg);
      font-weight: var(--font-semibold);
      color: var(--foreground);
    }

    .compare-card-meta {
      font-size: var(--text-sm);
      color: var(--color-gray-500);
    }

    .compare-card-badge {
      background: var(--color-primary-100);
      color: var(--color-primary-600);
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
    }

    .compare-card-body {
      padding: 0;
    }

    .compare-prices-list {
      display: flex;
      flex-direction: column;
    }

    .compare-price-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-3) var(--space-4);
      border-bottom: 1px solid var(--border);
      gap: var(--space-3);
    }

    .compare-price-row:last-child {
      border-bottom: none;
    }

    .compare-price-row.is-best {
      background: var(--color-primary-100);
    }

    .compare-price-store-info {
      flex: 1;
      min-width: 0;
    }

    .compare-price-store {
      font-weight: var(--font-medium);
      color: var(--foreground);
      font-size: var(--text-sm);
    }

    .compare-price-location {
      font-size: var(--text-xs);
      color: var(--color-gray-500);
    }

    .compare-price-input-row {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      flex-shrink: 0;
    }

    .compare-price-input {
      width: 90px;
      padding: var(--space-2);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: var(--text-base);
      font-weight: var(--font-semibold);
      text-align: right;
      background: var(--card);
      color: var(--foreground);
    }

    .compare-price-input:focus {
      outline: none;
      border-color: var(--color-primary-500);
      box-shadow: 0 0 0 3px var(--color-primary-100);
    }

    .compare-price-input::placeholder {
      color: var(--color-gray-400);
    }

    .compare-best-badge {
      background: var(--color-primary-600);
      color: white;
      padding: 2px 6px;
      border-radius: var(--radius-sm);
      font-size: 10px;
      font-weight: var(--font-bold);
      text-transform: uppercase;
      white-space: nowrap;
    }

    /* Table View Styles - CSS Grid for reliable layout */
    .compare-grid-wrapper {
      overflow-x: auto;
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      background: var(--card);
    }

    .compare-grid {
      display: grid;
      min-width: max-content;
    }

    .compare-grid-header,
    .compare-grid-row {
      display: contents;
    }

    .compare-grid-cell {
      padding: var(--space-2) var(--space-3);
      border-bottom: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .compare-grid-header .compare-grid-cell {
      background: var(--color-gray-100);
      font-weight: var(--font-semibold);
      font-size: var(--text-sm);
      color: var(--foreground);
    }

    .compare-grid-header .compare-grid-cell:first-child {
      text-align: left;
      min-width: 180px;
    }

    .compare-grid-header .compare-grid-cell:not(:first-child) {
      text-align: center;
      align-items: center;
      min-width: 100px;
    }

    .compare-grid-header .store-location {
      font-weight: normal;
      font-size: 10px;
      color: var(--color-gray-500);
    }

    .compare-grid-row:hover .compare-grid-cell {
      background: var(--color-gray-100);
    }

    .compare-grid-row .compare-grid-cell:first-child {
      text-align: left;
    }

    .compare-grid-row .compare-grid-cell:not(:first-child) {
      text-align: center;
      align-items: center;
    }

    .compare-grid-row .compare-grid-cell.best-cell {
      background: var(--color-primary-100);
    }

    .compare-grid-row .compare-grid-cell.best-cell:hover {
      background: var(--color-primary-200);
    }

    .compare-grid .item-name {
      font-weight: var(--font-medium);
      color: var(--foreground);
    }

    .compare-grid .item-meta {
      font-size: var(--text-xs);
      color: var(--color-gray-500);
      margin-top: 2px;
    }

    .compare-grid .grid-input {
      width: 75px;
      padding: var(--space-2);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      font-weight: var(--font-semibold);
      text-align: center;
      background: var(--card);
      color: var(--foreground);
    }

    .compare-grid .grid-input:focus {
      outline: none;
      border-color: var(--color-primary-500);
      box-shadow: 0 0 0 2px var(--color-primary-100);
    }

    .compare-grid .grid-input::placeholder {
      color: var(--color-gray-400);
    }

    .compare-grid .best-label {
      font-size: 9px;
      color: var(--color-primary-600);
      font-weight: var(--font-bold);
      text-transform: uppercase;
      margin-top: 2px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: var(--space-12);
      color: var(--color-gray-500);
    }

    .empty-state-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto var(--space-4);
      color: var(--color-gray-400);
    }

    .empty-state-title {
      font-size: var(--text-lg);
      font-weight: var(--font-semibold);
      color: var(--foreground);
      margin-bottom: var(--space-2);
    }

    /* Saving indicator */
    .saving-indicator {
      position: fixed;
      bottom: var(--space-4);
      right: var(--space-4);
      background: var(--color-gray-800);
      color: var(--color-gray-100);
      padding: var(--space-3) var(--space-4);
      border-radius: var(--radius-lg);
      font-size: var(--text-sm);
      display: none;
      align-items: center;
      gap: var(--space-2);
      box-shadow: var(--shadow-lg);
    }

    .saving-indicator.show {
      display: flex;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .saving-indicator .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    /* Toolbar */
    .toolbar {
      display: flex;
      align-items: center;
      gap: var(--space-4);
      margin-bottom: var(--space-4);
      flex-wrap: wrap;
    }

    .toolbar-search {
      flex: 1;
      min-width: 200px;
      max-width: 300px;
    }

    .toolbar-actions {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      margin-left: auto;
    }
  </style>
</head>
<body>
  <div class="user-layout">
    <aside class="user-sidebar" id="user-sidebar"></aside>

    <main class="user-main">
      <header class="user-header" id="user-header"></header>

      <div class="user-content">
        <div class="user-page-header">
          <h1 class="user-page-title">Price Comparison</h1>
          <p class="user-page-subtitle">Compare and update prices across all your stores.</p>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
          <input type="text" class="user-search-input toolbar-search" id="search-input" placeholder="Filter items...">
          <select class="user-form-select" id="category-filter" style="width: auto;">
            <option value="">All Categories</option>
          </select>

          <div class="toolbar-actions">
            <div class="view-toggle">
              <button class="view-toggle-btn active" data-view="cards" onclick="setView('cards')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="7" height="7"></rect>
                  <rect x="14" y="3" width="7" height="7"></rect>
                  <rect x="14" y="14" width="7" height="7"></rect>
                  <rect x="3" y="14" width="7" height="7"></rect>
                </svg>
                Cards
              </button>
              <button class="view-toggle-btn" data-view="table" onclick="setView('table')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="3" y1="6" x2="21" y2="6"></line>
                  <line x1="3" y1="12" x2="21" y2="12"></line>
                  <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
                Table
              </button>
            </div>
            <button class="btn btn-secondary" onclick="loadData()">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="23 4 23 10 17 10"></polyline>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
              </svg>
            </button>
          </div>
        </div>

        <!-- Stats Bar -->
        <div class="stats-bar" id="stats-bar" style="display: none;">
          <div class="stat-item">
            <div class="stat-value" id="stat-items">0</div>
            <div class="stat-label">Items</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="stat-stores">0</div>
            <div class="stat-label">Stores</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="stat-prices">0</div>
            <div class="stat-label">Prices</div>
          </div>
        </div>

        <!-- Content Area -->
        <div id="content-area">
          <div class="empty-state">
            <div class="empty-state-title">Loading...</div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Saving Indicator -->
  <div class="saving-indicator" id="saving-indicator">
    <div class="spinner"></div>
    <span>Saving...</span>
  </div>

  <script src="/js/api.js"></script>
  <script src="/js/auth.js"></script>
  <script src="/js/user-common.js"></script>
  <script src="/js/user-sidebar.js"></script>
  <script>
    let allStores = [];
    let allItems = [];
    let priceMatrix = {};
    let currentView = 'cards';
    let saveTimeout = null;

    document.addEventListener('DOMContentLoaded', async () => {
      if (!await user.init()) return;

      initUserSidebar('compare');
      initUserHeader([
        { label: 'Dashboard', href: '/user/' },
        { label: 'Price Comparison', href: '/user/compare/' }
      ]);

      currentView = localStorage.getItem('priceCompareView') || 'cards';
      updateViewToggle();

      document.getElementById('search-input').addEventListener('input', debounce(render, 300));
      document.getElementById('category-filter').addEventListener('change', render);

      await loadData();
    });

    function debounce(fn, ms) {
      let timer;
      return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => fn(...args), ms);
      };
    }

    function setView(view) {
      currentView = view;
      localStorage.setItem('priceCompareView', view);
      updateViewToggle();
      render();
    }

    function updateViewToggle() {
      document.querySelectorAll('.view-toggle-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === currentView);
      });
    }

    async function loadData() {
      const content = document.getElementById('content-area');
      content.innerHTML = '<div class="empty-state"><div class="empty-state-title">Loading...</div></div>';

      try {
        const [storesRes, itemsRes, tagsRes, pricesRes] = await Promise.all([
          storesApi.list({ limit: 100 }),
          itemsApi.list({ limit: 500 }),
          tagsApi.list(),
          pricesApi.list({ limit: 10000 })
        ]);

        allStores = Array.isArray(storesRes?.data) ? storesRes.data : (Array.isArray(storesRes) ? storesRes : []);
        allItems = Array.isArray(itemsRes?.data) ? itemsRes.data : (Array.isArray(itemsRes) ? itemsRes : []);
        const tags = Array.isArray(tagsRes?.data) ? tagsRes.data : (Array.isArray(tagsRes) ? tagsRes : []);
        const prices = Array.isArray(pricesRes?.data) ? pricesRes.data : (Array.isArray(pricesRes) ? pricesRes : []);

        const categoryFilter = document.getElementById('category-filter');
        categoryFilter.innerHTML = '<option value="">All Categories</option>';
        tags.forEach(tag => {
          categoryFilter.innerHTML += '<option value="' + user.escapeHtml(tag.name) + '">' + user.escapeHtml(tag.name) + '</option>';
        });

        priceMatrix = {};
        prices.forEach(p => {
          priceMatrix[p.item_id + '_' + p.store_id] = p;
        });

        document.getElementById('stat-items').textContent = allItems.length;
        document.getElementById('stat-stores').textContent = allStores.length;
        document.getElementById('stat-prices').textContent = prices.length;
        document.getElementById('stats-bar').style.display = 'flex';

        render();
      } catch (err) {
        console.error('Failed to load data:', err);
        content.innerHTML = '<div class="empty-state"><div class="empty-state-title" style="color: var(--destructive);">Failed to load data</div></div>';
      }
    }

    function getFilteredItems() {
      const searchTerm = document.getElementById('search-input').value.toLowerCase();
      const categoryFilter = document.getElementById('category-filter').value;

      return allItems.filter(item => {
        if (searchTerm && !item.name.toLowerCase().includes(searchTerm) &&
            !(item.brand && item.brand.toLowerCase().includes(searchTerm))) {
          return false;
        }
        if (categoryFilter && (!item.tags || !item.tags.includes(categoryFilter))) {
          return false;
        }
        return true;
      });
    }

    function findBestPrice(itemId) {
      let bestPrice = null;
      let bestStoreId = null;

      allStores.forEach(store => {
        const priceObj = priceMatrix[itemId + '_' + store.id];
        if (priceObj && priceObj.price > 0) {
          if (bestPrice === null || priceObj.price < bestPrice) {
            bestPrice = priceObj.price;
            bestStoreId = store.id;
          }
        }
      });

      return { bestPrice: bestPrice, bestStoreId: bestStoreId };
    }

    function render() {
      const content = document.getElementById('content-area');
      const filteredItems = getFilteredItems();

      if (allStores.length === 0) {
        content.innerHTML = '<div class="empty-state">' +
          '<div class="empty-state-title">No stores yet</div>' +
          '<p>Add stores first to start tracking prices.</p>' +
          '<a href="/user/stores/" class="btn btn-primary" style="margin-top: var(--space-4);">Add Stores</a>' +
          '</div>';
        return;
      }

      if (filteredItems.length === 0) {
        const searchTerm = document.getElementById('search-input').value;
        const categoryFilterVal = document.getElementById('category-filter').value;
        content.innerHTML = '<div class="empty-state">' +
          '<div class="empty-state-title">No items found</div>' +
          '<p>' + (searchTerm || categoryFilterVal ? 'Try adjusting your filters.' : 'Add items first to track prices.') + '</p>' +
          ((!searchTerm && !categoryFilterVal) ? '<a href="/user/items/" class="btn btn-primary" style="margin-top: var(--space-4);">Add Items</a>' : '') +
          '</div>';
        return;
      }

      if (currentView === 'cards') {
        renderCards(filteredItems);
      } else {
        renderTable(filteredItems);
      }
    }

    function renderCards(items) {
      const content = document.getElementById('content-area');
      let html = '<div class="compare-cards">';

      for (let i = 0; i < items.length; i++) {
        const item = items[i];
        const itemMeta = [];
        if (item.brand) itemMeta.push(item.brand);
        if (item.size) itemMeta.push(item.size + ' ' + (item.unit || ''));

        const bestInfo = findBestPrice(item.id);
        const hasManyStores = allStores.length > 1;

        html += '<div class="compare-card">';
        html += '<div class="compare-card-header">';
        html += '<div>';
        html += '<div class="compare-card-title">' + user.escapeHtml(item.name) + '</div>';
        html += '<div class="compare-card-meta">' + user.escapeHtml(itemMeta.join(' • ')) + '</div>';
        html += '</div>';
        if (item.tags && item.tags[0]) {
          html += '<span class="compare-card-badge">' + user.escapeHtml(item.tags[0]) + '</span>';
        }
        html += '</div>';
        html += '<div class="compare-card-body">';
        html += '<div class="compare-prices-list">';

        for (let j = 0; j < allStores.length; j++) {
          const store = allStores[j];
          const key = item.id + '_' + store.id;
          const priceObj = priceMatrix[key];
          const hasPrice = priceObj && priceObj.price > 0;
          const isBest = hasManyStores && hasPrice && store.id === bestInfo.bestStoreId;

          html += '<div class="compare-price-row' + (isBest ? ' is-best' : '') + '">';
          html += '<div class="compare-price-store-info">';
          html += '<div class="compare-price-store">' + user.escapeHtml(store.name) + '</div>';
          html += '<div class="compare-price-location">' + user.escapeHtml(store.city || '') + ', ' + (store.state || '') + '</div>';
          html += '</div>';
          html += '<div class="compare-price-input-row">';
          html += '<input type="number" class="compare-price-input"';
          html += ' value="' + (hasPrice ? priceObj.price : '') + '"';
          html += ' placeholder="—" step="0.01" min="0"';
          html += ' data-item-id="' + item.id + '"';
          html += ' data-store-id="' + store.id + '"';
          html += ' data-price-id="' + (priceObj ? priceObj.id : '') + '"';
          html += ' onchange="handlePriceChange(this)" onfocus="this.select()">';
          html += '</div>';
          html += '</div>';
        }

        html += '</div></div></div>';
      }

      html += '</div>';
      content.innerHTML = html;
    }

    function renderTable(items) {
      const content = document.getElementById('content-area');
      const stores = allStores;
      const numStores = stores.length;
      const numCols = numStores + 1; // Item column + store columns

      // Build grid columns: first column wider, rest equal
      const gridCols = '180px ' + 'minmax(100px, 1fr) '.repeat(numStores);

      let html = '<div class="compare-grid-wrapper">';
      html += '<div class="compare-grid" style="grid-template-columns: ' + gridCols + '">';

      // Header row
      html += '<div class="compare-grid-header">';
      html += '<div class="compare-grid-cell">Item</div>';
      for (let s = 0; s < numStores; s++) {
        html += '<div class="compare-grid-cell">';
        html += '<span>' + user.escapeHtml(stores[s].name) + '</span>';
        html += '<span class="store-location">' + user.escapeHtml(stores[s].city || '') + ', ' + (stores[s].state || '') + '</span>';
        html += '</div>';
      }
      html += '</div>';

      // Data rows
      for (let i = 0; i < items.length; i++) {
        const item = items[i];
        const meta = [];
        if (item.brand) meta.push(item.brand);
        if (item.size) meta.push(item.size + ' ' + (item.unit || ''));

        const bestInfo = findBestPrice(item.id);

        html += '<div class="compare-grid-row">';

        // Item cell
        html += '<div class="compare-grid-cell">';
        html += '<span class="item-name">' + user.escapeHtml(item.name) + '</span>';
        if (meta.length > 0) {
          html += '<span class="item-meta">' + user.escapeHtml(meta.join(' • ')) + '</span>';
        }
        html += '</div>';

        // Price cells
        for (let s = 0; s < numStores; s++) {
          const store = stores[s];
          const priceKey = item.id + '_' + store.id;
          const priceObj = priceMatrix[priceKey];
          const hasPrice = priceObj && priceObj.price > 0;
          const isBest = numStores > 1 && hasPrice && store.id === bestInfo.bestStoreId;

          html += '<div class="compare-grid-cell' + (isBest ? ' best-cell' : '') + '">';
          html += '<input type="number" class="grid-input"';
          html += ' value="' + (hasPrice ? priceObj.price : '') + '"';
          html += ' placeholder="—" step="0.01" min="0"';
          html += ' data-item-id="' + item.id + '"';
          html += ' data-store-id="' + store.id + '"';
          html += ' data-price-id="' + (priceObj ? priceObj.id : '') + '"';
          html += ' onchange="handlePriceChange(this)" onfocus="this.select()">';
          html += '</div>';
        }

        html += '</div>';
      }

      html += '</div></div>';
      content.innerHTML = html;
    }

    async function handlePriceChange(input) {
      const itemId = parseInt(input.dataset.itemId);
      const storeId = parseInt(input.dataset.storeId);
      const priceId = input.dataset.priceId;
      const newPrice = parseFloat(input.value);
      const key = itemId + '_' + storeId;

      // If clearing the value or setting to 0, delete the price if it exists
      if (!newPrice || newPrice <= 0 || isNaN(newPrice)) {
        if (priceId) {
          // Delete existing price
          showSaving(true);
          try {
            await pricesApi.delete(parseInt(priceId));
            delete priceMatrix[key];
            input.dataset.priceId = '';
            input.value = '';
            document.getElementById('stat-prices').textContent = Object.keys(priceMatrix).length;
            user.toast('Price deleted', 'success');
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(function() {
              render();
              showSaving(false);
            }, 500);
          } catch (err) {
            console.error('Failed to delete price:', err);
            user.toast('Failed to delete price: ' + (err.message || 'Unknown error'), 'error');
            showSaving(false);
          }
        }
        return;
      }

      showSaving(true);

      try {
        let updatedPrice;
        if (priceId) {
          const response = await pricesApi.userUpdate(parseInt(priceId), { price: newPrice });
          updatedPrice = response && response.data ? response.data : response;
        } else {
          const response = await pricesApi.create({
            item_id: itemId,
            store_id: storeId,
            price: newPrice
          });
          updatedPrice = response && response.data ? response.data : response;
          input.dataset.priceId = updatedPrice.id;
        }

        priceMatrix[key] = updatedPrice;
        document.getElementById('stat-prices').textContent = Object.keys(priceMatrix).length;

        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(function() {
          render();
          showSaving(false);
        }, 500);

      } catch (err) {
        console.error('Failed to save price:', err);
        user.toast('Failed to save price: ' + (err.message || 'Unknown error'), 'error');
        showSaving(false);
      }
    }

    function showSaving(show) {
      const el = document.getElementById('saving-indicator');
      if (show) {
        el.classList.add('show');
      } else {
        el.classList.remove('show');
      }
    }
  </script>
</body>
</html>
