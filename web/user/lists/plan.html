<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shopping Plan - PriceFeed</title>
  <link rel="stylesheet" href="/css/global.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/user.css">
  <script src="/js/theme.js"></script>
  <style>
    /* Plan Page Layout */
    .plan-layout {
      display: grid;
      grid-template-columns: 1fr 350px;
      gap: var(--space-6);
    }

    @media (max-width: 1024px) {
      .plan-layout {
        grid-template-columns: 1fr;
      }
    }

    /* Strategy Toggle */
    .strategy-toggle {
      display: flex;
      background: var(--muted);
      border-radius: var(--radius-lg);
      padding: var(--space-1);
      margin-bottom: var(--space-6);
    }

    .strategy-btn {
      flex: 1;
      padding: var(--space-3) var(--space-4);
      background: transparent;
      border: none;
      border-radius: var(--radius-md);
      font-weight: var(--font-medium);
      color: var(--muted-foreground);
      cursor: pointer;
      transition: all 0.2s;
    }

    .strategy-btn.active {
      background: var(--card);
      color: var(--foreground);
      box-shadow: var(--shadow-sm);
    }

    .strategy-btn:hover:not(.active) {
      color: var(--foreground);
    }

    /* Summary Card */
    .plan-summary-card {
      background: linear-gradient(135deg, var(--color-primary-600) 0%, var(--color-primary-700) 100%);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      color: white;
      margin-bottom: var(--space-6);
    }

    .plan-summary-label {
      font-size: var(--text-sm);
      opacity: 0.9;
      margin-bottom: var(--space-1);
    }

    .plan-summary-value {
      font-size: var(--text-4xl);
      font-weight: var(--font-bold);
      line-height: 1;
      margin-bottom: var(--space-4);
    }

    .plan-summary-stats {
      display: flex;
      gap: var(--space-6);
    }

    .plan-summary-stat {
      text-align: center;
    }

    .plan-summary-stat-value {
      font-size: var(--text-xl);
      font-weight: var(--font-bold);
    }

    .plan-summary-stat-label {
      font-size: var(--text-xs);
      opacity: 0.8;
    }

    /* Savings Badge */
    .savings-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      background: rgba(255,255,255,0.2);
      padding: var(--space-2) var(--space-3);
      border-radius: var(--radius-full);
      font-size: var(--text-sm);
      font-weight: var(--font-semibold);
    }

    /* Store Cards */
    .store-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      overflow: hidden;
      margin-bottom: var(--space-4);
    }

    .store-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-4);
      background: var(--muted);
      border-bottom: 1px solid var(--border);
    }

    .store-card-info {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .store-card-number {
      width: 32px;
      height: 32px;
      background: var(--primary);
      color: var(--primary-foreground);
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: var(--font-bold);
      font-size: var(--text-sm);
    }

    .store-card-name {
      font-weight: var(--font-semibold);
      color: var(--foreground);
    }

    .store-card-address {
      font-size: var(--text-xs);
      color: var(--muted-foreground);
    }

    .store-card-total {
      font-size: var(--text-xl);
      font-weight: var(--font-bold);
      color: var(--color-primary-600);
    }

    .store-card-body {
      padding: var(--space-4);
    }

    .store-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-3) 0;
      border-bottom: 1px solid var(--border);
    }

    .store-item:last-child {
      border-bottom: none;
    }

    .store-item-info {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .store-item-qty {
      background: var(--muted);
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-md);
      font-size: var(--text-xs);
      font-weight: var(--font-semibold);
      color: var(--muted-foreground);
    }

    .store-item-name {
      color: var(--foreground);
    }

    .store-item-price {
      font-weight: var(--font-semibold);
      color: var(--foreground);
    }

    /* Missing Items Alert */
    .missing-items-alert {
      background: var(--color-warning-50);
      border: 1px solid var(--color-warning-200);
      border-radius: var(--radius-xl);
      padding: var(--space-4);
      margin-bottom: var(--space-6);
    }

    .dark .missing-items-alert {
      background: rgba(234, 179, 8, 0.1);
      border-color: var(--color-warning-800);
    }

    .missing-items-title {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-weight: var(--font-semibold);
      color: var(--color-warning-800);
      margin-bottom: var(--space-2);
    }

    .dark .missing-items-title {
      color: var(--color-warning-400);
    }

    .missing-items-list {
      font-size: var(--text-sm);
      color: var(--color-warning-700);
    }

    .dark .missing-items-list {
      color: var(--color-warning-300);
    }

    /* Sidebar Panel */
    .plan-sidebar {
      position: sticky;
      top: 100px;
    }

    .plan-sidebar-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      padding: var(--space-5);
      margin-bottom: var(--space-4);
    }

    .plan-sidebar-title {
      font-weight: var(--font-semibold);
      color: var(--foreground);
      margin-bottom: var(--space-4);
    }

    .plan-action-btn {
      width: 100%;
      margin-bottom: var(--space-3);
    }

    .plan-action-btn:last-child {
      margin-bottom: 0;
    }

    /* Print-specific button group */
    .export-buttons {
      display: flex;
      gap: var(--space-2);
      margin-bottom: var(--space-4);
    }

    .export-buttons .btn {
      flex: 1;
    }

    /* Loading/Empty States */
    .plan-loading {
      text-align: center;
      padding: var(--space-12);
      color: var(--muted-foreground);
    }

    .plan-empty {
      text-align: center;
      padding: var(--space-12);
    }

    .plan-empty-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto var(--space-4);
      color: var(--color-gray-300);
    }

    .plan-empty-title {
      font-size: var(--text-lg);
      font-weight: var(--font-semibold);
      color: var(--foreground);
      margin-bottom: var(--space-2);
    }

    .plan-empty-text {
      color: var(--muted-foreground);
      margin-bottom: var(--space-4);
    }

    /* Compare View */
    .compare-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: var(--space-4);
    }

    .single-store-option {
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: var(--radius-xl);
      padding: var(--space-4);
      cursor: pointer;
      transition: all 0.2s;
    }

    .single-store-option:hover {
      border-color: var(--primary);
    }

    .single-store-option.best {
      border-color: var(--primary);
      background: var(--color-primary-50);
    }

    .dark .single-store-option.best {
      background: rgba(34, 197, 94, 0.1);
    }

    .single-store-name {
      font-weight: var(--font-semibold);
      color: var(--foreground);
      margin-bottom: var(--space-2);
    }

    .single-store-stats {
      display: flex;
      justify-content: space-between;
      font-size: var(--text-sm);
      color: var(--muted-foreground);
    }

    .single-store-total {
      font-size: var(--text-xl);
      font-weight: var(--font-bold);
      color: var(--color-primary-600);
    }

    /* Print Styles */
    @media print {
      .user-sidebar, .user-header, .plan-sidebar, .strategy-toggle {
        display: none !important;
      }

      .user-main {
        margin-left: 0 !important;
      }

      .plan-layout {
        grid-template-columns: 1fr !important;
      }

      .store-card {
        break-inside: avoid;
      }
    }
  </style>
</head>
<body>
  <div class="user-layout">
    <aside class="user-sidebar" id="user-sidebar"></aside>

    <main class="user-main">
      <header class="user-header" id="user-header"></header>

      <div class="user-content">
        <div class="user-page-header">
          <div style="display: flex; align-items: center; gap: var(--space-3);">
            <a href="#" id="back-link" class="btn btn-secondary btn-sm">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
              </svg>
            </a>
            <div>
              <h1 class="user-page-title" id="page-title">Shopping Plan</h1>
              <p class="user-page-subtitle">Optimized shopping route to save you money</p>
            </div>
          </div>
        </div>

        <!-- Strategy Toggle -->
        <div class="strategy-toggle" id="strategy-toggle">
          <button class="strategy-btn active" data-strategy="multi" onclick="showStrategy('multi')">
            Best Prices (Multi-Store)
          </button>
          <button class="strategy-btn" data-strategy="single" onclick="showStrategy('single')">
            Single Store Options
          </button>
        </div>

        <!-- Loading State -->
        <div id="plan-loading" class="plan-loading">
          <div class="spinner" style="margin-bottom: var(--space-4);"></div>
          <div>Building your optimized shopping plan...</div>
        </div>

        <!-- Empty State -->
        <div id="plan-empty" class="plan-empty" style="display: none;">
          <div class="plan-empty-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M12 16v-4M12 8h.01"></path>
            </svg>
          </div>
          <div class="plan-empty-title">No Price Data Available</div>
          <div class="plan-empty-text">
            We couldn't find prices for the items in your list.<br>
            Add prices in the Prices section or ask the community for help.
          </div>
          <a href="/user/prices/" class="btn btn-primary">Go to Prices</a>
        </div>

        <!-- Plan Content -->
        <div id="plan-content" style="display: none;">
          <div class="plan-layout">
            <!-- Main Content -->
            <div id="plan-main">
              <!-- Multi-store view (default) -->
              <div id="multi-store-view"></div>

              <!-- Single-store view -->
              <div id="single-store-view" style="display: none;"></div>
            </div>

            <!-- Sidebar -->
            <div class="plan-sidebar">
              <div class="plan-sidebar-card">
                <div class="plan-sidebar-title">Actions</div>
                <div class="export-buttons">
                  <button class="btn btn-secondary" onclick="printPlan()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <polyline points="6 9 6 2 18 2 18 9"></polyline>
                      <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                      <rect x="6" y="14" width="12" height="8"></rect>
                    </svg>
                    Print
                  </button>
                  <button class="btn btn-secondary" onclick="copyToClipboard()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                      <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                    Copy
                  </button>
                  <button class="btn btn-secondary" onclick="emailList()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                      <polyline points="22,6 12,13 2,6"></polyline>
                    </svg>
                    Email Me
                  </button>
                </div>
                <button class="btn btn-primary plan-action-btn" onclick="completeShopping()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                    <path d="M9 11l3 3L22 4"></path>
                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                  </svg>
                  Complete Shopping
                </button>
                <a href="#" id="edit-list-link" class="btn btn-secondary plan-action-btn">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                  </svg>
                  Edit List
                </a>
              </div>

              <div class="plan-sidebar-card" id="comparison-card" style="display: none;">
                <div class="plan-sidebar-title">Quick Comparison</div>
                <div id="comparison-summary"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Complete Shopping Modal -->
  <div class="user-modal-backdrop hidden" id="complete-modal">
    <div class="user-modal user-modal-lg">
      <div class="user-modal-header">
        <h3 class="user-modal-title">Complete Shopping</h3>
        <button class="user-modal-close" onclick="userModal.close('complete-modal')">&times;</button>
      </div>
      <div class="user-modal-body">
        <p style="margin-bottom: var(--space-4); color: var(--muted-foreground);">
          Did the prices match what you expected? Help the community by confirming or updating prices.
        </p>
        <div id="complete-content">
          <div style="text-align: center; padding: var(--space-8); color: var(--muted-foreground);">Loading...</div>
        </div>
      </div>
      <div class="user-modal-footer">
        <button type="button" class="btn btn-secondary" onclick="userModal.close('complete-modal')">Cancel</button>
        <button type="button" class="btn btn-secondary" onclick="completeWithoutConfirmation()">Skip & Complete</button>
        <button type="button" class="btn btn-primary" onclick="completeWithConfirmations()">Submit & Complete</button>
      </div>
    </div>
  </div>

  <script src="/js/api.js"></script>
  <script src="/js/auth.js"></script>
  <script src="/js/user-common.js"></script>
  <script src="/js/user-sidebar.js"></script>
  <script>
    let listId = null;
    let listData = null;
    let planData = null;
    let currentStrategy = 'multi';

    document.addEventListener('DOMContentLoaded', async () => {
      if (!await user.init()) return;

      initUserSidebar('lists');
      initUserHeader([
        { label: 'Dashboard', href: '/user/' },
        { label: 'Shopping Lists', href: '/user/lists/' },
        { label: 'Shopping Plan', href: '#' }
      ]);

      userModal.setupBackdropClose();

      // Get list ID from URL
      const params = new URLSearchParams(window.location.search);
      listId = params.get('id');

      if (!listId) {
        user.toast('No list specified', 'error');
        window.location.href = '/user/lists/';
        return;
      }

      // Setup navigation links
      document.getElementById('back-link').href = `/user/lists/edit.html?id=${listId}`;
      document.getElementById('edit-list-link').href = `/user/lists/edit.html?id=${listId}`;

      // Load list and build plan
      await loadListAndPlan();
    });

    async function loadListAndPlan() {
      try {
        // Load list details first
        const listResponse = await listsApi.getById(parseInt(listId));
        listData = listResponse?.data || listResponse;

        document.getElementById('page-title').textContent = `Plan: ${listData.name}`;

        // Build the plan
        const planResponse = await listsApi.buildPlan(parseInt(listId));
        planData = planResponse?.data || planResponse;

        console.log('Plan data received:', planData);

        // Check if we have valid plan data
        if (!planData || (!planData.multi_store?.stores?.length && !planData.single_store)) {
          showEmptyState();
          return;
        }

        // Render the plan
        renderPlan();
      } catch (err) {
        console.error('Failed to build plan:', err);
        document.getElementById('plan-loading').innerHTML = `
          <div style="color: var(--color-error);">
            Failed to build plan: ${err.message || 'Unknown error'}
          </div>
          <a href="/user/lists/" class="btn btn-secondary" style="margin-top: var(--space-4);">Back to Lists</a>
        `;
      }
    }

    function showEmptyState() {
      document.getElementById('plan-loading').style.display = 'none';
      document.getElementById('plan-empty').style.display = 'block';
      document.getElementById('strategy-toggle').style.display = 'none';

      // Show which items are missing prices
      if (listData && listData.items) {
        const itemsList = listData.items.map(item => 
          `<div style="padding: 4px 0; border-bottom: 1px solid var(--border); color: var(--muted-foreground);">
             ${user.escapeHtml(item.item_name)} - <span style="color: var(--color-error);">No price found</span>
           </div>`
        ).join('');
        
        const container = document.querySelector('.plan-empty-text');
        container.innerHTML = `
          <div style="margin-bottom: 1rem;">We couldn't find prices for the items in your list:</div>
          <div style="text-align: left; max-width: 400px; margin: 0 auto 1rem auto; max-height: 200px; overflow-y: auto;">
            ${itemsList}
          </div>
          <div>Add prices in the Prices section or ask the community for help.</div>
        `;
      }
    }

    function renderPlan() {
      document.getElementById('plan-loading').style.display = 'none';
      document.getElementById('plan-content').style.display = 'block';

      renderMultiStoreView();
      renderSingleStoreView();
      renderComparisonSummary();
    }

    function renderMultiStoreView() {
      const container = document.getElementById('multi-store-view');
      const multiStore = planData.multi_store;

      if (!multiStore || !multiStore.stores?.length) {
        container.innerHTML = `
          <div class="plan-empty">
            <div class="plan-empty-title">No multi-store plan available</div>
            <div class="plan-empty-text">Try the single store options instead.</div>
          </div>
        `;
        return;
      }

      const savings = multiStore.total_savings || 0;

      let html = `
        <!-- Summary Card -->
        <div class="plan-summary-card">
          <div class="plan-summary-label">Optimized Total</div>
          <div class="plan-summary-value">${user.formatCurrency(multiStore.total_cost)}</div>
          <div class="plan-summary-stats">
            <div class="plan-summary-stat">
              <div class="plan-summary-stat-value">${multiStore.trip_count || multiStore.stores.length}</div>
              <div class="plan-summary-stat-label">Stores to visit</div>
            </div>
            ${savings > 0 ? `
              <div class="plan-summary-stat">
                <div class="plan-summary-stat-value">${user.formatCurrency(savings)}</div>
                <div class="plan-summary-stat-label">Potential savings</div>
              </div>
            ` : ''}
          </div>
        </div>
      `;

      // Missing items alert
      const missingItems = getMissingItems();
      if (missingItems.length > 0) {
        html += `
          <div class="missing-items-alert">
            <div class="missing-items-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                <line x1="12" y1="9" x2="12" y2="13"></line>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
              </svg>
              ${missingItems.length} item(s) without prices
            </div>
            <div class="missing-items-list">${missingItems.join(', ')}</div>
          </div>
        `;
      }

      // Store cards
      html += '<h3 style="margin-bottom: var(--space-4); font-weight: var(--font-semibold); color: var(--foreground);">Your Shopping Route</h3>';

      multiStore.stores.forEach((store, index) => {
        html += `
          <div class="store-card">
            <div class="store-card-header">
              <div class="store-card-info">
                <div class="store-card-number">${index + 1}</div>
                <div>
                  <div class="store-card-name">${user.escapeHtml(store.store_name)}</div>
                  ${store.store_address ? `<div class="store-card-address">${user.escapeHtml(store.store_address)}</div>` : ''}
                </div>
              </div>
              <div class="store-card-total">${user.formatCurrency(store.subtotal)}</div>
            </div>
            <div class="store-card-body">
              ${store.items.map(item => `
                <div class="store-item">
                  <div class="store-item-info">
                    <span class="store-item-qty">${item.quantity}x</span>
                    <span class="store-item-name">${user.escapeHtml(item.item_name)}</span>
                  </div>
                  <span class="store-item-price">${user.formatCurrency(item.price * item.quantity)}</span>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function renderSingleStoreView() {
      const container = document.getElementById('single-store-view');
      const singleStore = planData.single_store;

      // For single store view, we'll show all single-store options
      // The API returns the best single store option, but we can compute others
      if (!singleStore) {
        container.innerHTML = `
          <div class="plan-empty">
            <div class="plan-empty-title">No single-store option available</div>
            <div class="plan-empty-text">No store has all your items.</div>
          </div>
        `;
        return;
      }

      let html = `
        <div class="plan-summary-card" style="background: var(--card); border: 1px solid var(--border); color: var(--foreground);">
          <div class="plan-summary-label" style="color: var(--muted-foreground);">Best Single Store</div>
          <div class="plan-summary-value" style="color: var(--color-primary-600);">${user.formatCurrency(singleStore.total_cost)}</div>
          <div style="font-weight: var(--font-semibold); margin-bottom: var(--space-2);">${user.escapeHtml(singleStore.store_name)}</div>
          <div style="font-size: var(--text-sm); color: var(--muted-foreground);">
            ${singleStore.items_found} items available
            ${singleStore.items_missing?.length ? `, ${singleStore.items_missing.length} missing` : ''}
          </div>
        </div>
      `;

      if (singleStore.items_missing?.length) {
        html += `
          <div class="missing-items-alert">
            <div class="missing-items-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                <line x1="12" y1="9" x2="12" y2="13"></line>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
              </svg>
              Items not available at this store
            </div>
            <div class="missing-items-list">${singleStore.items_missing.join(', ')}</div>
          </div>
        `;
      }

      html += `
        <p style="color: var(--muted-foreground); margin-bottom: var(--space-4);">
          Shopping at a single store is more convenient but may cost more.
          The multi-store option could save you ${user.formatCurrency(singleStore.total_cost - (planData.multi_store?.total_cost || 0))}.
        </p>
      `;

      container.innerHTML = html;
    }

    function renderComparisonSummary() {
      const container = document.getElementById('comparison-summary');
      const card = document.getElementById('comparison-card');

      const multiTotal = planData.multi_store?.total_cost || 0;
      const singleTotal = planData.single_store?.total_cost || 0;

      if (multiTotal > 0 && singleTotal > 0) {
        card.style.display = 'block';
        const savings = singleTotal - multiTotal;

        container.innerHTML = `
          <div style="margin-bottom: var(--space-3);">
            <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-2);">
              <span style="color: var(--muted-foreground);">Multi-store</span>
              <span style="font-weight: var(--font-semibold); color: var(--color-primary-600);">${user.formatCurrency(multiTotal)}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: var(--muted-foreground);">Single store</span>
              <span style="font-weight: var(--font-semibold);">${user.formatCurrency(singleTotal)}</span>
            </div>
          </div>
          ${savings > 0 ? `
            <div style="padding: var(--space-2); background: var(--color-primary-50); border-radius: var(--radius-md); text-align: center; color: var(--color-primary-700); font-weight: var(--font-semibold);">
              Save ${user.formatCurrency(savings)} with multi-store
            </div>
          ` : ''}
        `;
      }
    }

    function getMissingItems() {
      // Get items that aren't in any store
      const listItems = listData?.items || [];
      const foundItemIds = new Set();

      if (planData.multi_store?.stores) {
        planData.multi_store.stores.forEach(store => {
          store.items.forEach(item => {
            foundItemIds.add(item.item_id);
          });
        });
      }

      return listItems
        .filter(item => !foundItemIds.has(item.item_id))
        .map(item => item.item_name);
    }

    function showStrategy(strategy) {
      currentStrategy = strategy;

      // Update toggle buttons
      document.querySelectorAll('.strategy-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.strategy === strategy);
      });

      // Show/hide views
      document.getElementById('multi-store-view').style.display = strategy === 'multi' ? 'block' : 'none';
      document.getElementById('single-store-view').style.display = strategy === 'single' ? 'block' : 'none';
    }

    function generatePlanText() {
      if (!planData?.multi_store) return '';

      const listName = listData?.name || 'Shopping List';
      const multiStore = planData.multi_store;
      let text = `${listName}\n`;
      text += `${'='.repeat(listName.length)}\n\n`;
      text += `Total: ${user.formatCurrency(multiStore.total_cost)}\n`;
      if (multiStore.total_savings > 0) {
        text += `Savings: ${user.formatCurrency(multiStore.total_savings)}\n`;
      }
      text += `\n`;

      for (const store of multiStore.stores || []) {
        text += `${store.store_name}\n`;
        text += `${'-'.repeat(store.store_name.length)}\n`;
        for (const item of store.items || []) {
          text += `  ${item.quantity}x ${item.item_name} - ${user.formatCurrency(item.price * item.quantity)}\n`;
        }
        text += `  Subtotal: ${user.formatCurrency(store.subtotal)}\n\n`;
      }

      return text;
    }

    function printPlan() {
      window.print();
    }

    async function copyToClipboard() {
      const text = generatePlanText();
      if (!text) {
        user.toast('No plan to copy', 'error');
        return;
      }

      try {
        await navigator.clipboard.writeText(text);
        user.toast('Plan copied to clipboard', 'success');
      } catch (err) {
        user.toast('Failed to copy', 'error');
      }
    }

    async function emailList() {
      if (!listId) {
        user.toast('No list to email', 'error');
        return;
      }

      try {
        user.toast('Sending email...', 'info');
        const response = await api.post(`/lists/${listId}/email`);
        
        if (response.success) {
          user.toast('Shopping list emailed! Check your inbox.', 'success');
        } else {
          throw new Error(response.error || 'Failed to send email');
        }
      } catch (err) {
        if (err.message.includes('not configured')) {
          user.toast('Email service is not configured. Contact admin.', 'error');
        } else {
          user.toast(err.message || 'Failed to email list', 'error');
        }
      }
    }

    function completeShopping() {
      renderCompleteContent();
      userModal.open('complete-modal');
    }

    function renderCompleteContent() {
      const content = document.getElementById('complete-content');

      if (!planData?.multi_store?.stores?.length) {
        content.innerHTML = `
          <p style="text-align: center; color: var(--muted-foreground);">
            No items to confirm. Click "Skip & Complete" to finish.
          </p>
        `;
        return;
      }

      const stores = planData.multi_store.stores;
      let html = '<div class="complete-items">';

      for (const store of stores) {
        html += `<div style="margin-bottom: var(--space-4);">`;
        html += `<h4 style="font-weight: var(--font-semibold); margin-bottom: var(--space-2);">${user.escapeHtml(store.store_name)}</h4>`;

        for (const item of store.items || []) {
          const inputId = `price-${store.store_id}-${item.item_id}`;
          html += `
            <div style="display: flex; align-items: center; gap: var(--space-3); padding: var(--space-2) 0; border-bottom: 1px solid var(--border);">
              <div style="flex: 1;">
                <span style="font-weight: var(--font-medium);">${item.quantity}x ${user.escapeHtml(item.item_name)}</span>
                <span style="color: var(--muted-foreground); margin-left: var(--space-2);">Expected: ${user.formatCurrency(item.price)}</span>
              </div>
              <div style="display: flex; align-items: center; gap: var(--space-2);">
                <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                  <input type="radio" name="${inputId}" value="accurate" checked
                    data-item-id="${item.item_id}" data-store-id="${store.store_id}">
                  <span style="font-size: var(--text-sm);">Correct</span>
                </label>
                <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                  <input type="radio" name="${inputId}" value="different"
                    data-item-id="${item.item_id}" data-store-id="${store.store_id}">
                  <span style="font-size: var(--text-sm);">Different</span>
                </label>
                <input type="number" step="0.01" min="0" placeholder="New price"
                  id="${inputId}-new" data-item-id="${item.item_id}" data-store-id="${store.store_id}"
                  style="width: 80px; padding: 4px 8px; display: none;" class="user-form-input">
              </div>
            </div>
          `;
        }
        html += `</div>`;
      }

      html += '</div>';
      content.innerHTML = html;

      // Add event listeners
      content.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          const name = e.target.name;
          const newPriceInput = document.getElementById(name + '-new');
          newPriceInput.style.display = e.target.value === 'different' ? 'block' : 'none';
        });
      });
    }

    async function completeWithoutConfirmation() {
      try {
        await listsApi.complete(parseInt(listId), null);
        user.toast('Shopping list completed!', 'success');
        userModal.close('complete-modal');
        window.location.href = '/user/lists/';
      } catch (err) {
        user.toast('Failed to complete: ' + (err.message || 'Unknown error'), 'error');
      }
    }

    async function completeWithConfirmations() {
      const confirmations = [];
      const content = document.getElementById('complete-content');

      content.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
        const itemId = parseInt(radio.dataset.itemId);
        const storeId = parseInt(radio.dataset.storeId);
        const isAccurate = radio.value === 'accurate';

        const confirmation = {
          item_id: itemId,
          store_id: storeId,
          is_accurate: isAccurate
        };

        if (!isAccurate) {
          const newPriceInput = document.getElementById(`price-${storeId}-${itemId}-new`);
          if (newPriceInput?.value) {
            confirmation.new_price = parseFloat(newPriceInput.value);
          }
        }

        confirmations.push(confirmation);
      });

      try {
        await listsApi.complete(parseInt(listId), confirmations);
        user.toast('Shopping list completed with price updates!', 'success');
        userModal.close('complete-modal');
        window.location.href = '/user/lists/';
      } catch (err) {
        user.toast('Failed to complete: ' + (err.message || 'Unknown error'), 'error');
      }
    }
  </script>
</body>
</html>
