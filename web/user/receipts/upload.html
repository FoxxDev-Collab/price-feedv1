<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload Receipt - PriceFeed</title>
  <link rel="stylesheet" href="/css/global.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/user.css">
  <script src="/js/theme.js"></script>
  <style>
    .upload-dropzone {
      border: 2px dashed var(--color-gray-300);
      border-radius: var(--radius-lg);
      padding: var(--space-8);
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--color-gray-50);
    }
    .upload-dropzone:hover, .upload-dropzone.dragover {
      border-color: var(--color-primary-500);
      background: var(--color-primary-50);
    }
    .upload-dropzone.has-file {
      border-color: var(--color-success-500);
      background: var(--color-success-50);
    }
    .upload-preview {
      max-width: 100%;
      max-height: 400px;
      border-radius: var(--radius-md);
      margin-top: var(--space-4);
    }
    .upload-progress {
      margin-top: var(--space-4);
      padding: var(--space-4);
      background: var(--color-gray-50);
      border-radius: var(--radius-lg);
    }
    .upload-progress-bar {
      height: 8px;
      background: var(--color-gray-200);
      border-radius: 4px;
      overflow: hidden;
    }
    .upload-progress-fill {
      height: 100%;
      background: var(--color-primary-500);
      transition: width 0.3s;
    }
  </style>
</head>
<body>
  <div class="user-layout">
    <aside class="user-sidebar" id="user-sidebar"></aside>

    <main class="user-main">
      <header class="user-header" id="user-header"></header>

      <div class="user-content">
        <div class="user-page-header">
          <h1 class="user-page-title">Upload Receipt</h1>
          <p class="user-page-subtitle">Take a photo of your receipt or upload an image to extract items and prices.</p>
        </div>

        <div class="user-card" style="max-width: 600px;">
          <form id="upload-form">
            <!-- Dropzone -->
            <div class="upload-dropzone" id="dropzone" onclick="document.getElementById('file-input').click()">
              <input type="file" id="file-input" accept="image/jpeg,image/png,image/webp" style="display: none;">
              <div id="dropzone-content">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto var(--space-4); color: var(--color-gray-400);">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <circle cx="8.5" cy="8.5" r="1.5"></circle>
                  <polyline points="21 15 16 10 5 21"></polyline>
                </svg>
                <div style="font-weight: var(--font-semibold); margin-bottom: var(--space-2);">Drop your receipt image here</div>
                <div style="color: var(--color-gray-500); font-size: var(--text-sm);">or click to browse</div>
                <div style="color: var(--color-gray-400); font-size: var(--text-xs); margin-top: var(--space-2);">Supports JPEG, PNG, WebP (max 10MB)</div>
              </div>
              <img id="preview" class="upload-preview" style="display: none;">
            </div>

            <!-- Optional Store Selection -->
            <div class="user-form-group" style="margin-top: var(--space-4);">
              <label class="user-form-label">Store (optional)</label>
              <select class="user-form-input" id="store-select">
                <option value="">Auto-detect or select later</option>
              </select>
              <div class="user-form-help">If you know the store, select it to help with item matching</div>
            </div>

            <!-- Progress -->
            <div class="upload-progress" id="upload-progress" style="display: none;">
              <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-2);">
                <span id="progress-status">Uploading...</span>
                <span id="progress-percent">0%</span>
              </div>
              <div class="upload-progress-bar">
                <div class="upload-progress-fill" id="progress-fill" style="width: 0%;"></div>
              </div>
            </div>

            <!-- Error -->
            <div class="user-form-error" id="upload-error" style="display: none;"></div>

            <!-- Actions -->
            <div style="display: flex; gap: var(--space-3); margin-top: var(--space-4);">
              <a href="/user/receipts/" class="btn btn-secondary">Cancel</a>
              <button type="submit" class="btn btn-primary" id="upload-btn" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.5rem;">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="17 8 12 3 7 8"></polyline>
                  <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                Upload & Process
              </button>
            </div>
          </form>
        </div>

        <!-- Tips -->
        <div class="user-card" style="max-width: 600px; margin-top: var(--space-4);">
          <h3 style="font-weight: var(--font-semibold); margin-bottom: var(--space-3);">Tips for best results</h3>
          <ul style="color: var(--color-gray-600); font-size: var(--text-sm); list-style: disc; padding-left: var(--space-5); display: flex; flex-direction: column; gap: var(--space-2);">
            <li>Take photos in good lighting</li>
            <li>Make sure the entire receipt is visible</li>
            <li>Avoid shadows and glare</li>
            <li>Keep the receipt flat and straight</li>
            <li>Higher resolution images work better</li>
          </ul>
        </div>
      </div>
    </main>
  </div>

  <script src="/js/api.js"></script>
  <script src="/js/auth.js"></script>
  <script src="/js/user-common.js"></script>
  <script src="/js/user-sidebar.js"></script>
  <script>
    let selectedFile = null;

    document.addEventListener('DOMContentLoaded', async () => {
      if (!await user.init()) return;

      initUserSidebar('receipts');
      initUserHeader([
        { label: 'Dashboard', href: '/user/' },
        { label: 'Receipts', href: '/user/receipts/' },
        { label: 'Upload', href: '/user/receipts/upload.html' }
      ]);

      setupDropzone();
      loadStores();
    });

    function setupDropzone() {
      const dropzone = document.getElementById('dropzone');
      const fileInput = document.getElementById('file-input');

      // Drag and drop events
      ['dragenter', 'dragover'].forEach(event => {
        dropzone.addEventListener(event, (e) => {
          e.preventDefault();
          dropzone.classList.add('dragover');
        });
      });

      ['dragleave', 'drop'].forEach(event => {
        dropzone.addEventListener(event, (e) => {
          e.preventDefault();
          dropzone.classList.remove('dragover');
        });
      });

      dropzone.addEventListener('drop', (e) => {
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFile(files[0]);
        }
      });

      // File input change
      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleFile(e.target.files[0]);
        }
      });

      // Form submit
      document.getElementById('upload-form').addEventListener('submit', handleUpload);
    }

    function handleFile(file) {
      const errorEl = document.getElementById('upload-error');
      errorEl.style.display = 'none';

      // Validate file type
      const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
      if (!validTypes.includes(file.type)) {
        errorEl.textContent = 'Please upload a JPEG, PNG, or WebP image';
        errorEl.style.display = 'block';
        return;
      }

      // Validate file size (10MB)
      if (file.size > 10 * 1024 * 1024) {
        errorEl.textContent = 'File too large. Maximum size is 10MB';
        errorEl.style.display = 'block';
        return;
      }

      selectedFile = file;

      // Show preview
      const reader = new FileReader();
      reader.onload = (e) => {
        const preview = document.getElementById('preview');
        const content = document.getElementById('dropzone-content');
        const dropzone = document.getElementById('dropzone');

        preview.src = e.target.result;
        preview.style.display = 'block';
        content.style.display = 'none';
        dropzone.classList.add('has-file');
      };
      reader.readAsDataURL(file);

      // Enable upload button
      document.getElementById('upload-btn').disabled = false;
    }

    async function loadStores() {
      try {
        const response = await storesApi.list({ limit: 100 });
        const stores = response?.data || response || [];
        const select = document.getElementById('store-select');

        stores.forEach(store => {
          const option = document.createElement('option');
          option.value = store.id;
          option.textContent = `${store.name} - ${store.city}, ${store.state}`;
          select.appendChild(option);
        });
      } catch (err) {
        console.error('Failed to load stores:', err);
      }
    }

    async function handleUpload(e) {
      e.preventDefault();

      if (!selectedFile) {
        const errorEl = document.getElementById('upload-error');
        errorEl.textContent = 'Please select a file to upload';
        errorEl.style.display = 'block';
        return;
      }

      const uploadBtn = document.getElementById('upload-btn');
      const progressEl = document.getElementById('upload-progress');
      const errorEl = document.getElementById('upload-error');

      uploadBtn.disabled = true;
      errorEl.style.display = 'none';
      progressEl.style.display = 'block';

      // Simulate progress (actual upload doesn't give real progress)
      let progress = 0;
      const progressFill = document.getElementById('progress-fill');
      const progressPercent = document.getElementById('progress-percent');
      const progressStatus = document.getElementById('progress-status');

      const progressInterval = setInterval(() => {
        if (progress < 30) {
          progress += 5;
        } else if (progress < 60) {
          progress += 2;
        } else if (progress < 90) {
          progress += 1;
        }
        progressFill.style.width = progress + '%';
        progressPercent.textContent = progress + '%';
      }, 200);

      try {
        const storeId = document.getElementById('store-select').value || null;

        progressStatus.textContent = 'Uploading image...';

        const response = await receiptsApi.upload(selectedFile, storeId);

        clearInterval(progressInterval);
        progressFill.style.width = '100%';
        progressPercent.textContent = '100%';
        progressStatus.textContent = 'Processing complete!';

        // Redirect to review page
        const receipt = response?.data || response;
        setTimeout(() => {
          window.location.href = `/user/receipts/review.html?id=${receipt.id}`;
        }, 500);

      } catch (err) {
        clearInterval(progressInterval);
        progressEl.style.display = 'none';
        errorEl.textContent = err.message || 'Failed to upload receipt';
        errorEl.style.display = 'block';
        uploadBtn.disabled = false;
      }
    }
  </script>
</body>
</html>
