<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prices - PriceFeed</title>
  <link rel="stylesheet" href="/css/global.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/user.css">
  <script src="/js/theme.js"></script>
</head>
<body>
  <div class="user-layout">
    <aside class="user-sidebar" id="user-sidebar"></aside>

    <main class="user-main">
      <header class="user-header" id="user-header"></header>

      <div class="user-content">
        <div class="user-page-header">
          <h1 class="user-page-title">Prices</h1>
          <p class="user-page-subtitle">Track prices for your items at different stores.</p>
          <div class="user-page-header-actions">
            <button class="btn btn-primary" onclick="openAddPriceModal()">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.5rem;">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              Add Price
            </button>
          </div>
        </div>

        <!-- Search and Filters -->
        <div class="user-search-bar">
          <input type="text" class="user-search-input" id="search-input" placeholder="Search by item or store...">
          <select class="user-form-select" id="store-filter" style="width: auto;">
            <option value="">All Stores</option>
          </select>
          <select class="user-form-select" id="item-filter" style="width: auto;">
            <option value="">All Items</option>
          </select>
        </div>

        <!-- Prices Table -->
        <div class="user-card">
          <div class="user-card-body" style="padding: 0;">
            <table class="user-table" id="prices-table">
              <thead>
                <tr>
                  <th>Item</th>
                  <th>Store</th>
                  <th>Price</th>
                  <th>Updated</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="prices-body">
                <tr>
                  <td colspan="5" style="text-align: center; padding: var(--space-8); color: var(--color-gray-500);">Loading...</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div id="prices-pagination" class="user-pagination" style="display: none;">
            <div class="user-pagination-info" id="prices-pagination-info"></div>
            <div class="user-pagination-buttons">
              <button class="user-pagination-btn" id="prices-prev-btn" onclick="loadPrices(currentPage - 1)">Previous</button>
              <button class="user-pagination-btn" id="prices-next-btn" onclick="loadPrices(currentPage + 1)">Next</button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Add/Edit Price Modal -->
  <div class="user-modal-backdrop hidden" id="price-modal">
    <div class="user-modal">
      <div class="user-modal-header">
        <h3 class="user-modal-title" id="price-modal-title">Add Price</h3>
        <button class="user-modal-close" onclick="userModal.close('price-modal')">&times;</button>
      </div>
      <div class="user-modal-body">
        <form id="price-form">
          <input type="hidden" id="price-id">

          <div class="user-form-group">
            <label class="user-form-label">Item *</label>
            <select class="user-form-select" id="price-item" required>
              <option value="">Select an item...</option>
            </select>
            <div class="user-form-help">
              Don't see your item? <a href="/user/items/" style="color: var(--color-primary-600);">Add it first</a>
            </div>
          </div>

          <div class="user-form-group">
            <label class="user-form-label">Store *</label>
            <select class="user-form-select" id="price-store" required>
              <option value="">Select a store...</option>
            </select>
            <div class="user-form-help">
              Don't see your store? <a href="/user/stores/" style="color: var(--color-primary-600);">Add it first</a>
            </div>
          </div>

          <div class="user-form-group">
            <label class="user-form-label">Price *</label>
            <div style="position: relative;">
              <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--color-gray-500);">$</span>
              <input type="number" class="user-form-input" id="price-value" required step="0.01" min="0.01" placeholder="0.00" style="padding-left: 24px;">
            </div>
          </div>

          <div class="user-form-error" id="price-error" style="display: none;"></div>
        </form>
      </div>
      <div class="user-modal-footer">
        <button type="button" class="btn btn-secondary" onclick="userModal.close('price-modal')">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="savePrice()">Save Price</button>
      </div>
    </div>
  </div>

  <script src="/js/api.js"></script>
  <script src="/js/auth.js"></script>
  <script src="/js/user-common.js"></script>
  <script src="/js/user-sidebar.js"></script>
  <script>
    const PAGE_SIZE = 25;
    let currentPage = 1;
    let totalPrices = 0;
    let allItems = [];
    let allStores = [];
    let searchTimeout = null;

    document.addEventListener('DOMContentLoaded', async () => {
      if (!await user.init()) return;

      initUserSidebar('prices');
      initUserHeader([
        { label: 'Dashboard', href: '/user/' },
        { label: 'Prices', href: '/user/prices/' }
      ]);

      userModal.setupBackdropClose();

      // Load items and stores for dropdowns
      await Promise.all([
        loadAllItems(),
        loadAllStores()
      ]);

      // Setup search
      const searchInput = document.getElementById('search-input');
      searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => loadPrices(1), 300);
      });

      document.getElementById('store-filter').addEventListener('change', () => loadPrices(1));
      document.getElementById('item-filter').addEventListener('change', () => loadPrices(1));

      await loadPrices(1);
    });

    async function loadAllItems() {
      try {
        const response = await itemsApi.list({ limit: 1000 });
        allItems = Array.isArray(response?.data) ? response.data : (Array.isArray(response) ? response : []);
        populateItemsDropdowns();
      } catch (err) {
        console.error('Failed to load items:', err);
      }
    }

    async function loadAllStores() {
      try {
        const response = await storesApi.list({ limit: 1000 });
        allStores = Array.isArray(response?.data) ? response.data : (Array.isArray(response) ? response : []);
        populateStoresDropdowns();
      } catch (err) {
        console.error('Failed to load stores:', err);
      }
    }

    function populateItemsDropdowns() {
      const priceSelect = document.getElementById('price-item');
      const filterSelect = document.getElementById('item-filter');

      priceSelect.innerHTML = '<option value="">Select an item...</option>';
      filterSelect.innerHTML = '<option value="">All Items</option>';

      allItems.forEach(item => {
        const label = item.brand ? `${item.name} (${item.brand})` : item.name;
        priceSelect.innerHTML += `<option value="${item.id}">${user.escapeHtml(label)}</option>`;
        filterSelect.innerHTML += `<option value="${item.id}">${user.escapeHtml(label)}</option>`;
      });
    }

    function populateStoresDropdowns() {
      const priceSelect = document.getElementById('price-store');
      const filterSelect = document.getElementById('store-filter');

      priceSelect.innerHTML = '<option value="">Select a store...</option>';
      filterSelect.innerHTML = '<option value="">All Stores</option>';

      allStores.forEach(store => {
        const label = `${store.name} - ${store.city}, ${store.state}`;
        priceSelect.innerHTML += `<option value="${store.id}">${user.escapeHtml(label)}</option>`;
        filterSelect.innerHTML += `<option value="${store.id}">${user.escapeHtml(label)}</option>`;
      });
    }

    async function loadPrices(page) {
      const tbody = document.getElementById('prices-body');
      tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: var(--space-8); color: var(--color-gray-500);">Loading...</td></tr>';

      try {
        const params = {
          limit: PAGE_SIZE,
          offset: (page - 1) * PAGE_SIZE,
          search: document.getElementById('search-input').value,
          store_id: document.getElementById('store-filter').value,
          item_id: document.getElementById('item-filter').value,
        };

        const response = await pricesApi.list(params);
        const prices = Array.isArray(response?.data) ? response.data : (Array.isArray(response) ? response : []);
        totalPrices = response?.meta?.total || response?.total || prices.length;
        currentPage = page;

        if (prices.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5">
                <div class="user-empty-state" style="padding: var(--space-8);">
                  <div class="user-empty-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                      <line x1="12" y1="1" x2="12" y2="23"></line>
                      <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                    </svg>
                  </div>
                  <div class="user-empty-title">No prices yet</div>
                  <div class="user-empty-text">Start tracking prices for your items</div>
                  <button class="btn btn-primary" onclick="openAddPriceModal()">Add Your First Price</button>
                </div>
              </td>
            </tr>
          `;
          document.getElementById('prices-pagination').style.display = 'none';
          return;
        }

        tbody.innerHTML = prices.map(price => renderPriceRow(price)).join('');
        updatePagination(page, totalPrices);
      } catch (err) {
        console.error('Failed to load prices:', err);
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: var(--space-8); color: var(--color-error);">Failed to load prices</td></tr>';
      }
    }

    function renderPriceRow(price) {
      return `
        <tr>
          <td>
            <div style="font-weight: var(--font-medium);">${user.escapeHtml(price.item_name)}</div>
            <div style="font-size: var(--text-xs); color: var(--color-gray-500);">${user.escapeHtml(price.item_brand || '')}</div>
          </td>
          <td>
            <div>${user.escapeHtml(price.store_name)}</div>
            <div style="font-size: var(--text-xs); color: var(--color-gray-500);">${user.escapeHtml(price.store_city || '')}, ${price.store_state || ''}</div>
          </td>
          <td>
            <span style="font-weight: var(--font-bold); color: var(--color-primary-600); font-size: var(--text-lg);">${user.formatCurrency(price.price)}</span>
          </td>
          <td>${user.formatDate(price.updated_at)}</td>
          <td>
            <div class="user-table-actions">
              <a href="/user/prices/history/?item_id=${price.item_id}&store_id=${price.store_id}" class="user-table-btn" title="View Price History">History</a>
              <button class="user-table-btn" onclick="editPrice(${price.id})">Edit</button>
              <button class="user-table-btn danger" onclick="deletePrice(${price.id})">Delete</button>
            </div>
          </td>
        </tr>
      `;
    }

    function updatePagination(page, total) {
      const pagination = document.getElementById('prices-pagination');
      const info = document.getElementById('prices-pagination-info');
      const prevBtn = document.getElementById('prices-prev-btn');
      const nextBtn = document.getElementById('prices-next-btn');

      if (total <= PAGE_SIZE) {
        pagination.style.display = 'none';
        return;
      }

      pagination.style.display = 'flex';
      const start = (page - 1) * PAGE_SIZE + 1;
      const end = Math.min(page * PAGE_SIZE, total);
      info.textContent = `Showing ${start}-${end} of ${total}`;

      prevBtn.disabled = page <= 1;
      nextBtn.disabled = end >= total;
    }

    function openAddPriceModal() {
      document.getElementById('price-modal-title').textContent = 'Add Price';
      document.getElementById('price-form').reset();
      document.getElementById('price-id').value = '';
      document.getElementById('price-error').style.display = 'none';

      // Enable item and store selects for new prices
      const itemSelect = document.getElementById('price-item');
      const storeSelect = document.getElementById('price-store');
      itemSelect.disabled = false;
      storeSelect.disabled = false;

      // Clear any edit data attributes
      delete itemSelect.dataset.editId;
      delete storeSelect.dataset.editId;

      userModal.open('price-modal');
    }

    async function editPrice(priceId) {
      try {
        const response = await pricesApi.getById(priceId);
        const price = response?.data || response;

        document.getElementById('price-modal-title').textContent = 'Edit Price';
        document.getElementById('price-id').value = price.id;

        // Store the item_id and store_id as data attributes since selects will be disabled
        const itemSelect = document.getElementById('price-item');
        const storeSelect = document.getElementById('price-store');

        itemSelect.value = price.item_id;
        storeSelect.value = price.store_id;

        // Store the IDs as data attributes in case the select doesn't work when disabled
        itemSelect.dataset.editId = price.item_id;
        storeSelect.dataset.editId = price.store_id;

        document.getElementById('price-value').value = price.price;
        document.getElementById('price-error').style.display = 'none';

        // Disable item and store for editing - only allow price change
        itemSelect.disabled = true;
        storeSelect.disabled = true;

        userModal.open('price-modal');

        // Focus on the price input so user can start typing immediately
        setTimeout(() => {
          document.getElementById('price-value').focus();
          document.getElementById('price-value').select();
        }, 100);
      } catch (err) {
        console.error('Failed to load price:', err);
        user.toast('Failed to load price details', 'error');
      }
    }

    async function savePrice() {
      const priceId = document.getElementById('price-id').value;
      const errorEl = document.getElementById('price-error');

      const itemSelect = document.getElementById('price-item');
      const storeSelect = document.getElementById('price-store');

      // When editing, use data attributes as fallback since selects are disabled
      let itemId, storeId;
      if (priceId) {
        // Editing mode - use stored data attributes
        itemId = parseInt(itemSelect.dataset.editId || itemSelect.value);
        storeId = parseInt(storeSelect.dataset.editId || storeSelect.value);
      } else {
        // Adding mode - use select values
        itemId = parseInt(itemSelect.value);
        storeId = parseInt(storeSelect.value);
      }

      const price = parseFloat(document.getElementById('price-value').value);

      if (!itemId || !storeId || isNaN(price) || price <= 0) {
        errorEl.textContent = 'Please fill in all fields with valid values.';
        errorEl.style.display = 'block';
        return;
      }

      try {
        if (priceId) {
          // Only update the price value, not item/store
          await pricesApi.userUpdate(parseInt(priceId), { price: price });
          user.toast('Price updated successfully', 'success');
        } else {
          // Create new price
          await pricesApi.create({
            item_id: itemId,
            store_id: storeId,
            price: price,
          });
          user.toast('Price added successfully', 'success');
        }

        userModal.close('price-modal');
        loadPrices(currentPage);
      } catch (err) {
        errorEl.textContent = err.message || 'Failed to save price';
        errorEl.style.display = 'block';
      }
    }

    async function deletePrice(priceId) {
      if (!await user.confirm('Are you sure you want to delete this price?')) {
        return;
      }

      try {
        await pricesApi.delete(priceId);
        user.toast('Price deleted successfully', 'success');
        loadPrices(currentPage);
      } catch (err) {
        user.toast('Failed to delete price: ' + (err.message || 'Unknown error'), 'error');
      }
    }
  </script>
</body>
</html>
