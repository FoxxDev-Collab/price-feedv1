<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stores - PriceFeed</title>
  <link rel="stylesheet" href="/css/global.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/user.css">
  <script src="/js/theme.js"></script>
  <style>
    /* Stores Page Styles - Theme Aware */
    .stores-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
    }

    .stores-search {
      flex: 1;
      min-width: 200px;
      padding: 0.5rem 1rem;
      border: 1px solid var(--border);
      border-radius: 0.375rem;
      background: var(--card);
      color: var(--foreground);
      font-size: 0.875rem;
    }

    .stores-search:focus {
      outline: none;
      border-color: var(--color-primary-500);
    }

    .stores-filter {
      padding: 0.5rem 1rem;
      border: 1px solid var(--border);
      border-radius: 0.375rem;
      background: var(--card);
      color: var(--foreground);
      font-size: 0.875rem;
      min-width: 120px;
    }

    .stores-view-toggle {
      display: flex;
      border: 1px solid var(--border);
      border-radius: 0.375rem;
      overflow: hidden;
    }

    .stores-view-btn {
      padding: 0.5rem 1rem;
      border: none;
      background: var(--card);
      color: var(--foreground);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.875rem;
      transition: background-color 0.2s;
    }

    .stores-view-btn:not(:last-child) {
      border-right: 1px solid var(--border);
    }

    .stores-view-btn:hover {
      background: var(--color-gray-100);
    }

    .dark .stores-view-btn:hover {
      background: var(--color-gray-700);
    }

    .stores-view-btn.active {
      background: var(--color-primary-500);
      color: white;
    }

    /* Stats Bar */
    .stores-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .stores-stat-card {
      padding: 1rem;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      text-align: center;
    }

    .stores-stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--color-primary-600);
    }

    .stores-stat-label {
      font-size: 0.75rem;
      color: var(--color-gray-500);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: 0.25rem;
    }

    /* Cards View */
    .stores-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 1rem;
    }

    .store-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      overflow: hidden;
      transition: box-shadow 0.2s, transform 0.2s;
    }

    .store-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
    }

    .store-card-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .store-card-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--foreground);
      margin: 0;
    }

    .store-card-subtitle {
      font-size: 0.75rem;
      color: var(--color-gray-500);
      margin-top: 0.25rem;
    }

    .store-card-badge {
      padding: 0.25rem 0.5rem;
      font-size: 0.625rem;
      font-weight: 600;
      text-transform: uppercase;
      border-radius: 9999px;
      background: var(--color-primary-100);
      color: var(--color-primary-700);
    }

    .store-card-body {
      padding: 1rem;
    }

    .store-card-address {
      font-size: 0.875rem;
      color: var(--foreground);
      margin-bottom: 0.5rem;
    }

    .store-card-location {
      font-size: 0.75rem;
      color: var(--color-gray-500);
    }

    .store-card-meta {
      display: flex;
      gap: 1rem;
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid var(--border);
    }

    .store-card-meta-item {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.75rem;
      color: var(--color-gray-500);
    }

    .store-card-meta-item svg {
      width: 14px;
      height: 14px;
    }

    .store-card-footer {
      padding: 0.75rem 1rem;
      background: var(--muted);
      border-top: 1px solid var(--border);
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .store-card-btn {
      padding: 0.375rem 0.75rem;
      font-size: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 0.25rem;
      background: var(--card);
      color: var(--foreground);
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .store-card-btn:hover {
      background: var(--color-gray-100);
    }

    .dark .store-card-btn:hover {
      background: var(--color-gray-700);
    }

    .store-card-btn.danger {
      color: var(--destructive);
      border-color: var(--destructive);
    }

    .store-card-btn.danger:hover {
      background: var(--destructive);
      color: white;
    }

    /* Table View */
    .stores-table-wrapper {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      overflow: hidden;
    }

    .stores-table {
      width: 100%;
      border-collapse: collapse;
    }

    .stores-table th {
      padding: 0.75rem 1rem;
      text-align: left;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-gray-500);
      background: var(--color-gray-50);
      border-bottom: 1px solid var(--border);
    }

    .dark .stores-table th {
      background: var(--color-gray-800);
    }

    .stores-table td {
      padding: 0.75rem 1rem;
      font-size: 0.875rem;
      color: var(--foreground);
      border-bottom: 1px solid var(--border);
    }

    .stores-table tbody tr:hover {
      background: var(--color-gray-50);
    }

    .dark .stores-table tbody tr:hover {
      background: var(--color-gray-800);
    }

    .stores-table tbody tr:last-child td {
      border-bottom: none;
    }

    .store-table-name {
      font-weight: 500;
    }

    .store-table-chain {
      font-size: 0.75rem;
      color: var(--color-gray-500);
    }

    .store-table-prices {
      font-weight: 600;
      color: var(--color-primary-600);
    }

    .store-table-actions {
      display: flex;
      gap: 0.5rem;
    }

    .store-table-btn {
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 0.25rem;
      background: var(--card);
      color: var(--foreground);
      cursor: pointer;
    }

    .store-table-btn:hover {
      background: var(--color-gray-100);
    }

    .dark .store-table-btn:hover {
      background: var(--color-gray-700);
    }

    .store-table-btn.danger {
      color: var(--destructive);
    }

    /* Empty State */
    .stores-empty {
      text-align: center;
      padding: 3rem;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
    }

    .stores-empty-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 1rem;
      color: var(--color-gray-400);
    }

    .stores-empty-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--foreground);
      margin-bottom: 0.5rem;
    }

    .stores-empty-text {
      font-size: 0.875rem;
      color: var(--color-gray-500);
      margin-bottom: 1rem;
    }

    /* Pagination */
    .stores-pagination {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 1rem;
      padding: 1rem;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
    }

    .stores-pagination-info {
      font-size: 0.875rem;
      color: var(--color-gray-500);
    }

    .stores-pagination-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .stores-pagination-btn {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      border: 1px solid var(--border);
      border-radius: 0.375rem;
      background: var(--card);
      color: var(--foreground);
      cursor: pointer;
    }

    .stores-pagination-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .stores-pagination-btn:not(:disabled):hover {
      background: var(--color-gray-100);
    }

    .dark .stores-pagination-btn:not(:disabled):hover {
      background: var(--color-gray-700);
    }

    /* Discover Modal Styles */
    .discover-prompt {
      text-align: center;
      padding: 2rem;
    }

    .discover-prompt-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 1rem;
      color: var(--color-primary-500);
    }

    .discover-prompt h4 {
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
      color: var(--foreground);
    }

    .discover-prompt p {
      color: var(--color-gray-500);
      margin-bottom: 1.5rem;
    }

    .discover-prompt-actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    .discover-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      min-height: 400px;
    }

    @media (max-width: 768px) {
      .discover-layout {
        grid-template-columns: 1fr;
      }
    }

    .discover-map-panel {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .discover-map {
      flex: 1;
      min-height: 300px;
      border-radius: 0.5rem;
      background: var(--color-gray-100);
    }

    .discover-controls {
      display: flex;
      gap: 0.5rem;
    }

    .discover-results-panel {
      display: flex;
      flex-direction: column;
    }

    .discover-results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--border);
      margin-bottom: 0.75rem;
    }

    .discover-results-header h4 {
      margin: 0;
      color: var(--foreground);
    }

    .discover-results-count {
      font-size: 0.875rem;
      color: var(--color-gray-500);
    }

    .discover-results-list {
      flex: 1;
      overflow-y: auto;
      max-height: 350px;
    }

    .discover-store-card {
      display: flex;
      gap: 0.75rem;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .discover-store-card:hover,
    .discover-store-card.active {
      background: #f9fafb;
    }

    html.dark .discover-store-card:hover {
      background: #444444;
    }

    html.dark .discover-store-card.active {
      background: #1a4d2e;
      border-color: #34a85a;
    }

    html.dark .discover-store-card.active .discover-store-name {
      color: #ffffff;
    }

    html.dark .discover-store-card.active .discover-store-address,
    html.dark .discover-store-card.active .discover-store-rating {
      color: #d1d5db;
    }

    .discover-store-card.existing {
      opacity: 0.6;
    }

    .discover-store-number {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--color-primary-500);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 600;
      flex-shrink: 0;
    }

    .discover-store-info {
      flex: 1;
      min-width: 0;
    }

    .discover-store-name {
      font-weight: 500;
      color: var(--foreground);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .discover-store-address {
      font-size: 0.75rem;
      color: var(--color-gray-500);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .discover-store-rating {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.75rem;
      color: var(--color-gray-500);
      margin-top: 0.25rem;
    }

    .discover-store-rating svg {
      color: #fbbf24;
    }

    .discover-store-actions {
      flex-shrink: 0;
    }

    .discover-badge {
      padding: 0.25rem 0.5rem;
      font-size: 0.625rem;
      font-weight: 600;
      border-radius: 9999px;
    }

    .discover-badge-exists {
      background: var(--color-gray-200);
      color: var(--color-gray-600);
    }

    .dark .discover-badge-exists {
      background: var(--color-gray-700);
      color: var(--color-gray-400);
    }

    .discover-loading,
    .discover-empty,
    .discover-error {
      text-align: center;
      padding: 2rem;
      color: var(--color-gray-500);
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 2px solid var(--border);
      border-top-color: var(--color-primary-500);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 0.5rem;
    }

    .spinner-sm {
      width: 16px;
      height: 16px;
      border-width: 2px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="user-layout">
    <aside class="user-sidebar" id="user-sidebar"></aside>

    <main class="user-main">
      <header class="user-header" id="user-header"></header>

      <div class="user-content">
        <div class="user-page-header">
          <h1 class="user-page-title">Stores</h1>
          <p class="user-page-subtitle">Find and add stores to track prices.</p>
          <div class="user-page-header-actions">
            <button class="btn btn-secondary" onclick="openDiscoverModal()">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.5rem;">
                <circle cx="12" cy="12" r="10"></circle>
                <polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"></polygon>
              </svg>
              Discover Nearby
            </button>
            <button class="btn btn-primary" onclick="openAddStoreModal()">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.5rem;">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              Add Store
            </button>
          </div>
        </div>

        <!-- Toolbar -->
        <div class="stores-toolbar">
          <input type="text" class="stores-search" id="search-input" placeholder="Search stores by name, address, or chain...">
          <select class="stores-filter" id="state-filter">
            <option value="">All States</option>
          </select>
          <div class="stores-view-toggle">
            <button class="stores-view-btn active" id="view-cards-btn" onclick="setView('cards')">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="7" height="7"></rect>
                <rect x="14" y="3" width="7" height="7"></rect>
                <rect x="3" y="14" width="7" height="7"></rect>
                <rect x="14" y="14" width="7" height="7"></rect>
              </svg>
              Cards
            </button>
            <button class="stores-view-btn" id="view-table-btn" onclick="setView('table')">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
              </svg>
              Table
            </button>
          </div>
        </div>

        <!-- Stats Bar -->
        <div class="stores-stats" id="stores-stats">
          <div class="stores-stat-card">
            <div class="stores-stat-value" id="stat-total">0</div>
            <div class="stores-stat-label">Total Stores</div>
          </div>
          <div class="stores-stat-card">
            <div class="stores-stat-value" id="stat-chains">0</div>
            <div class="stores-stat-label">Chains</div>
          </div>
          <div class="stores-stat-card">
            <div class="stores-stat-value" id="stat-prices">0</div>
            <div class="stores-stat-label">Total Prices</div>
          </div>
          <div class="stores-stat-card">
            <div class="stores-stat-value" id="stat-states">0</div>
            <div class="stores-stat-label">States</div>
          </div>
        </div>

        <!-- Content Area -->
        <div id="stores-content">
          <div class="stores-empty">
            <div class="spinner"></div>
            <div class="stores-empty-text">Loading stores...</div>
          </div>
        </div>

        <!-- Pagination -->
        <div id="stores-pagination" class="stores-pagination" style="display: none;">
          <div class="stores-pagination-info" id="stores-pagination-info"></div>
          <div class="stores-pagination-buttons">
            <button class="stores-pagination-btn" id="stores-prev-btn" onclick="loadStores(currentPage - 1)">Previous</button>
            <button class="stores-pagination-btn" id="stores-next-btn" onclick="loadStores(currentPage + 1)">Next</button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Add/Edit Store Modal -->
  <div class="user-modal-backdrop hidden" id="store-modal">
    <div class="user-modal user-modal-lg">
      <div class="user-modal-header">
        <h3 class="user-modal-title" id="store-modal-title">Add Store</h3>
        <button class="user-modal-close" onclick="userModal.close('store-modal')">&times;</button>
      </div>
      <div class="user-modal-body">
        <form id="store-form">
          <input type="hidden" id="store-id">

          <div class="user-form-group">
            <label class="user-form-label">Store Name *</label>
            <input type="text" class="user-form-input" id="store-name" required placeholder="e.g., King Soopers">
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4);">
            <div class="user-form-group">
              <label class="user-form-label">Chain (optional)</label>
              <input type="text" class="user-form-input" id="store-chain" placeholder="e.g., Kroger">
            </div>
            <div class="user-form-group">
              <label class="user-form-label">Store Type</label>
              <select class="user-form-select" id="store-type">
                <option value="grocery">Grocery</option>
                <option value="supermarket">Supermarket</option>
                <option value="warehouse">Warehouse Club</option>
                <option value="convenience">Convenience</option>
                <option value="specialty">Specialty</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>

          <div class="user-form-group">
            <label class="user-form-label">Street Address *</label>
            <input type="text" class="user-form-input" id="store-address" required placeholder="123 Main St">
          </div>

          <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: var(--space-4);">
            <div class="user-form-group">
              <label class="user-form-label">City *</label>
              <input type="text" class="user-form-input" id="store-city" required>
            </div>
            <div class="user-form-group">
              <label class="user-form-label">State *</label>
              <input type="text" class="user-form-input" id="store-state" required maxlength="2" placeholder="CO">
            </div>
            <div class="user-form-group">
              <label class="user-form-label">ZIP *</label>
              <input type="text" class="user-form-input" id="store-zip" required maxlength="10" placeholder="80202">
            </div>
          </div>

          <div class="user-form-error" id="store-error" style="display: none;"></div>
        </form>
      </div>
      <div class="user-modal-footer">
        <button type="button" class="btn btn-secondary" onclick="userModal.close('store-modal')">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveStore()">Save Store</button>
      </div>
    </div>
  </div>

  <!-- View Store Prices Modal -->
  <div class="user-modal-backdrop hidden" id="store-prices-modal">
    <div class="user-modal user-modal-lg">
      <div class="user-modal-header">
        <h3 class="user-modal-title" id="store-prices-title">Store Prices</h3>
        <button class="user-modal-close" onclick="userModal.close('store-prices-modal')">&times;</button>
      </div>
      <div class="user-modal-body">
        <div id="store-prices-content">
          <div style="text-align: center; padding: var(--space-8); color: var(--color-gray-500);">Loading...</div>
        </div>
      </div>
      <div class="user-modal-footer">
        <button type="button" class="btn btn-secondary" onclick="userModal.close('store-prices-modal')">Close</button>
      </div>
    </div>
  </div>

  <!-- Discover Nearby Stores Modal -->
  <div class="user-modal-backdrop hidden" id="discover-modal">
    <div class="user-modal user-modal-xl">
      <div class="user-modal-header">
        <h3 class="user-modal-title">Discover Nearby Stores</h3>
        <button class="user-modal-close" onclick="closeDiscoverModal()">&times;</button>
      </div>

      <div class="user-modal-body">
        <!-- Location Prompt -->
        <div id="discover-location-prompt" class="discover-prompt">
          <div class="discover-prompt-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg>
          </div>
          <h4>Set Your Location</h4>
          <p>To discover nearby stores, we need your location.</p>
          <div class="discover-prompt-actions">
            <button class="btn btn-primary" onclick="detectLocationForDiscover()">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.5rem;">
                <circle cx="12" cy="12" r="10"></circle>
                <circle cx="12" cy="12" r="3"></circle>
                <line x1="12" y1="2" x2="12" y2="4"></line>
                <line x1="12" y1="20" x2="12" y2="22"></line>
                <line x1="2" y1="12" x2="4" y2="12"></line>
                <line x1="20" y1="12" x2="22" y2="12"></line>
              </svg>
              Use Current Location
            </button>
            <button class="btn btn-secondary" onclick="window.location.href='/user/profile/'">
              Set Address in Profile
            </button>
          </div>
        </div>

        <!-- Discovery Content -->
        <div id="discover-content" class="discover-layout hidden">
          <!-- Left: Map Panel -->
          <div class="discover-map-panel">
            <div id="discover-map" class="discover-map"></div>
            <div class="discover-controls">
              <select id="discover-radius" class="stores-filter" onchange="refreshDiscoverSearch()">
                <option value="1000">Within 1 km</option>
                <option value="2000">Within 2 km</option>
                <option value="5000" selected>Within 5 km</option>
                <option value="10000">Within 10 km</option>
                <option value="20000">Within 20 km</option>
              </select>
              <button class="btn btn-secondary btn-sm" onclick="refreshDiscoverSearch()">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.25rem;">
                  <polyline points="23 4 23 10 17 10"></polyline>
                  <polyline points="1 20 1 14 7 14"></polyline>
                  <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                </svg>
                Refresh
              </button>
            </div>
          </div>

          <!-- Right: Results Panel -->
          <div class="discover-results-panel">
            <div class="discover-results-header">
              <h4>Found Stores</h4>
              <span class="discover-results-count" id="discover-count">0 stores</span>
            </div>
            <div class="discover-results-list" id="discover-results">
            </div>
          </div>
        </div>
      </div>

      <div class="user-modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeDiscoverModal()">Close</button>
      </div>
    </div>
  </div>

  <script src="/js/api.js"></script>
  <script src="/js/maps.js"></script>
  <script src="/js/auth.js"></script>
  <script src="/js/user-common.js"></script>
  <script src="/js/user-sidebar.js"></script>
  <script>
    var PAGE_SIZE = 12;
    var currentPage = 1;
    var totalStores = 0;
    var searchTimeout = null;
    var currentView = 'cards';
    var allStores = [];

    // Discovery state
    var discoverMap = null;
    var discoverMarkers = [];
    var userLocationMarker = null;
    var discoveredStores = [];
    var currentDiscoverLocation = null;
    var existingStoreIds = new Set();

    document.addEventListener('DOMContentLoaded', async function() {
      if (!await user.init()) return;

      initUserSidebar('stores');
      initUserHeader([
        { label: 'Dashboard', href: '/user/' },
        { label: 'Stores', href: '/user/stores/' }
      ]);

      userModal.setupBackdropClose();

      // Restore view preference
      var savedView = localStorage.getItem('stores-view');
      if (savedView === 'cards' || savedView === 'table') {
        currentView = savedView;
        updateViewButtons();
      }

      // Load states for filter
      await loadStates();

      // Setup search
      var searchInput = document.getElementById('search-input');
      searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() { loadStores(1); }, 300);
      });

      document.getElementById('state-filter').addEventListener('change', function() { loadStores(1); });

      await loadStores(1);
    });

    function setView(view) {
      currentView = view;
      localStorage.setItem('stores-view', view);
      updateViewButtons();
      renderStores();
    }

    function updateViewButtons() {
      var cardsBtn = document.getElementById('view-cards-btn');
      var tableBtn = document.getElementById('view-table-btn');
      cardsBtn.classList.toggle('active', currentView === 'cards');
      tableBtn.classList.toggle('active', currentView === 'table');
    }

    async function loadStates() {
      try {
        var response = await regionsApi.getStates();
        var states = response && response.data ? response.data : (response || []);
        var select = document.getElementById('state-filter');
        for (var i = 0; i < states.length; i++) {
          var option = document.createElement('option');
          option.value = states[i];
          option.textContent = states[i];
          select.appendChild(option);
        }
      } catch (err) {
        console.error('Failed to load states:', err);
      }
    }

    async function loadStores(page) {
      var content = document.getElementById('stores-content');
      content.innerHTML = '<div class="stores-empty"><div class="spinner"></div><div class="stores-empty-text">Loading stores...</div></div>';

      try {
        var params = {
          limit: PAGE_SIZE,
          offset: (page - 1) * PAGE_SIZE,
          search: document.getElementById('search-input').value,
          state: document.getElementById('state-filter').value
        };

        var response = await storesApi.list(params);
        allStores = Array.isArray(response && response.data) ? response.data : (Array.isArray(response) ? response : []);
        totalStores = (response && response.meta && response.meta.total) ? response.meta.total : ((response && response.total) ? response.total : allStores.length);
        currentPage = page;

        updateStats();
        renderStores();
        updatePagination(page, totalStores);
      } catch (err) {
        console.error('Failed to load stores:', err);
        content.innerHTML = '<div class="stores-empty"><div class="stores-empty-title">Failed to load stores</div><div class="stores-empty-text">Please try again later.</div></div>';
      }
    }

    function updateStats() {
      document.getElementById('stat-total').textContent = totalStores;

      // Count unique chains
      var chains = {};
      var states = {};
      var totalPrices = 0;

      for (var i = 0; i < allStores.length; i++) {
        var store = allStores[i];
        if (store.chain) chains[store.chain] = true;
        if (store.state) states[store.state] = true;
        totalPrices += store.price_count || 0;
      }

      document.getElementById('stat-chains').textContent = Object.keys(chains).length;
      document.getElementById('stat-prices').textContent = totalPrices;
      document.getElementById('stat-states').textContent = Object.keys(states).length;
    }

    function renderStores() {
      var content = document.getElementById('stores-content');

      if (allStores.length === 0) {
        content.innerHTML = '<div class="stores-empty">' +
          '<svg class="stores-empty-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">' +
            '<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>' +
            '<polyline points="9 22 9 12 15 12 15 22"></polyline>' +
          '</svg>' +
          '<div class="stores-empty-title">No stores found</div>' +
          '<div class="stores-empty-text">Add a store or discover nearby stores</div>' +
          '<button class="btn btn-primary" onclick="openDiscoverModal()">Discover Nearby</button>' +
        '</div>';
        return;
      }

      if (currentView === 'cards') {
        renderCards();
      } else {
        renderTable();
      }
    }

    function renderCards() {
      var content = document.getElementById('stores-content');
      var html = '<div class="stores-grid">';

      for (var i = 0; i < allStores.length; i++) {
        var store = allStores[i];
        var canEdit = store.created_by === user.getUserId();
        var escapedName = user.escapeHtml(store.name);

        html += '<div class="store-card">';
        html += '<div class="store-card-header">';
        html += '<div>';
        html += '<div class="store-card-title">' + escapedName + '</div>';
        html += '<div class="store-card-subtitle">' + user.escapeHtml(store.chain || store.store_type || '') + '</div>';
        html += '</div>';
        if (store.verified) {
          html += '<span class="store-card-badge">Verified</span>';
        }
        html += '</div>';

        html += '<div class="store-card-body">';
        html += '<div class="store-card-address">' + user.escapeHtml(store.street_address) + '</div>';
        html += '<div class="store-card-location">' + user.escapeHtml(store.city) + ', ' + store.state + ' ' + store.zip_code + '</div>';
        html += '<div class="store-card-meta">';
        html += '<div class="store-card-meta-item">';
        html += '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>';
        html += (store.price_count || 0) + ' prices';
        html += '</div>';
        html += '</div>';
        html += '</div>';

        html += '<div class="store-card-footer">';
        html += '<button class="store-card-btn" onclick="viewStorePrices(' + store.id + ', \'' + escapedName.replace(/'/g, "\\'") + '\')">View Prices</button>';
        if (canEdit) {
          html += '<button class="store-card-btn" onclick="editStore(' + store.id + ')">Edit</button>';
          html += '<button class="store-card-btn danger" onclick="deleteStore(' + store.id + ', \'' + escapedName.replace(/'/g, "\\'") + '\')">Delete</button>';
        }
        html += '</div>';
        html += '</div>';
      }

      html += '</div>';
      content.innerHTML = html;
    }

    function renderTable() {
      var content = document.getElementById('stores-content');
      var html = '<div class="stores-table-wrapper">';
      html += '<table class="stores-table">';
      html += '<thead><tr>';
      html += '<th>Store</th>';
      html += '<th>Address</th>';
      html += '<th>City</th>';
      html += '<th>State</th>';
      html += '<th>Prices</th>';
      html += '<th>Actions</th>';
      html += '</tr></thead>';
      html += '<tbody>';

      for (var i = 0; i < allStores.length; i++) {
        var store = allStores[i];
        var canEdit = store.created_by === user.getUserId();
        var escapedName = user.escapeHtml(store.name);

        html += '<tr>';
        html += '<td>';
        html += '<div class="store-table-name">' + escapedName + '</div>';
        if (store.chain) {
          html += '<div class="store-table-chain">' + user.escapeHtml(store.chain) + '</div>';
        }
        html += '</td>';
        html += '<td>' + user.escapeHtml(store.street_address) + '</td>';
        html += '<td>' + user.escapeHtml(store.city) + '</td>';
        html += '<td>' + store.state + '</td>';
        html += '<td class="store-table-prices">' + (store.price_count || 0) + '</td>';
        html += '<td>';
        html += '<div class="store-table-actions">';
        html += '<button class="store-table-btn" onclick="viewStorePrices(' + store.id + ', \'' + escapedName.replace(/'/g, "\\'") + '\')">Prices</button>';
        if (canEdit) {
          html += '<button class="store-table-btn" onclick="editStore(' + store.id + ')">Edit</button>';
          html += '<button class="store-table-btn danger" onclick="deleteStore(' + store.id + ', \'' + escapedName.replace(/'/g, "\\'") + '\')">Delete</button>';
        }
        html += '</div>';
        html += '</td>';
        html += '</tr>';
      }

      html += '</tbody></table></div>';
      content.innerHTML = html;
    }

    function updatePagination(page, total) {
      var pagination = document.getElementById('stores-pagination');
      var info = document.getElementById('stores-pagination-info');
      var prevBtn = document.getElementById('stores-prev-btn');
      var nextBtn = document.getElementById('stores-next-btn');

      if (total <= PAGE_SIZE) {
        pagination.style.display = 'none';
        return;
      }

      pagination.style.display = 'flex';
      var start = (page - 1) * PAGE_SIZE + 1;
      var end = Math.min(page * PAGE_SIZE, total);
      info.textContent = 'Showing ' + start + '-' + end + ' of ' + total;

      prevBtn.disabled = page <= 1;
      nextBtn.disabled = end >= total;
    }

    function openAddStoreModal() {
      document.getElementById('store-modal-title').textContent = 'Add Store';
      document.getElementById('store-form').reset();
      document.getElementById('store-id').value = '';
      document.getElementById('store-error').style.display = 'none';
      userModal.open('store-modal');
    }

    async function editStore(storeId) {
      try {
        var store = await storesApi.getById(storeId);
        var data = store && store.data ? store.data : store;

        document.getElementById('store-modal-title').textContent = 'Edit Store';
        document.getElementById('store-id').value = data.id;
        document.getElementById('store-name').value = data.name;
        document.getElementById('store-chain').value = data.chain || '';
        document.getElementById('store-type').value = data.store_type || 'grocery';
        document.getElementById('store-address').value = data.street_address;
        document.getElementById('store-city').value = data.city;
        document.getElementById('store-state').value = data.state;
        document.getElementById('store-zip').value = data.zip_code;
        document.getElementById('store-error').style.display = 'none';

        userModal.open('store-modal');
      } catch (err) {
        user.toast('Failed to load store details', 'error');
      }
    }

    async function saveStore() {
      var storeId = document.getElementById('store-id').value;
      var errorEl = document.getElementById('store-error');

      var data = {
        name: document.getElementById('store-name').value.trim(),
        chain: document.getElementById('store-chain').value.trim() || null,
        store_type: document.getElementById('store-type').value,
        street_address: document.getElementById('store-address').value.trim(),
        city: document.getElementById('store-city').value.trim(),
        state: document.getElementById('store-state').value.trim().toUpperCase(),
        zip_code: document.getElementById('store-zip').value.trim()
      };

      if (!data.name || !data.street_address || !data.city || !data.state || !data.zip_code) {
        errorEl.textContent = 'Please fill in all required fields.';
        errorEl.style.display = 'block';
        return;
      }

      try {
        if (storeId) {
          await storesApi.update(parseInt(storeId), data);
          user.toast('Store updated successfully', 'success');
        } else {
          await storesApi.create(data);
          user.toast('Store added successfully', 'success');
        }

        userModal.close('store-modal');
        loadStores(currentPage);
      } catch (err) {
        errorEl.textContent = err.message || 'Failed to save store';
        errorEl.style.display = 'block';
      }
    }

    async function deleteStore(storeId, storeName) {
      if (!await user.confirm('Are you sure you want to delete "' + storeName + '"? This will also delete all prices for this store.')) {
        return;
      }

      try {
        await storesApi.delete(storeId);
        user.toast('Store deleted successfully', 'success');
        loadStores(currentPage);
      } catch (err) {
        user.toast('Failed to delete store: ' + (err.message || 'Unknown error'), 'error');
      }
    }

    async function viewStorePrices(storeId, storeName) {
      document.getElementById('store-prices-title').textContent = 'Prices at ' + storeName;
      var content = document.getElementById('store-prices-content');
      content.innerHTML = '<div style="text-align: center; padding: var(--space-8); color: var(--color-gray-500);">Loading...</div>';
      userModal.open('store-prices-modal');

      try {
        var response = await pricesApi.getByStore(storeId);
        var prices = response && response.data ? response.data : (response || []);

        if (prices.length === 0) {
          content.innerHTML = '<div class="user-empty-state">' +
            '<div class="user-empty-title">No prices yet</div>' +
            '<div class="user-empty-text">Be the first to add prices at this store!</div>' +
          '</div>';
          return;
        }

        var html = '<table class="stores-table">';
        html += '<thead><tr><th>Item</th><th>Price</th><th>Updated</th></tr></thead>';
        html += '<tbody>';

        for (var i = 0; i < prices.length; i++) {
          var p = prices[i];
          html += '<tr>';
          html += '<td>';
          html += '<div style="font-weight: 500;">' + user.escapeHtml(p.item_name) + '</div>';
          if (p.item_brand) {
            html += '<div style="font-size: 0.75rem; color: var(--color-gray-500);">' + user.escapeHtml(p.item_brand) + '</div>';
          }
          html += '</td>';
          html += '<td style="font-weight: 600; color: var(--color-primary-600);">' + user.formatCurrency(p.price) + '</td>';
          html += '<td>' + user.formatDate(p.updated_at) + '</td>';
          html += '</tr>';
        }

        html += '</tbody></table>';
        content.innerHTML = html;
      } catch (err) {
        content.innerHTML = '<div style="text-align: center; padding: var(--space-8); color: var(--destructive);">Failed to load prices</div>';
      }
    }

    // ==========================================
    // Discover Nearby Stores Functions
    // ==========================================

    async function openDiscoverModal() {
      document.getElementById('discover-modal').classList.remove('hidden');

      if (user.currentUser && user.currentUser.latitude && user.currentUser.longitude) {
        currentDiscoverLocation = {
          lat: user.currentUser.latitude,
          lng: user.currentUser.longitude
        };
        document.getElementById('discover-location-prompt').classList.add('hidden');
        document.getElementById('discover-content').classList.remove('hidden');
        await initDiscoverMap();
        await searchNearbyStores();
      } else {
        document.getElementById('discover-location-prompt').classList.remove('hidden');
        document.getElementById('discover-content').classList.add('hidden');
      }
    }

    function closeDiscoverModal() {
      document.getElementById('discover-modal').classList.add('hidden');
      clearDiscoverMarkers();
    }

    async function detectLocationForDiscover() {
      var btn = event.target.closest('button');
      var originalContent = btn.innerHTML;

      try {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-sm"></span> Detecting...';

        currentDiscoverLocation = await mapsApi.getCurrentLocation();

        document.getElementById('discover-location-prompt').classList.add('hidden');
        document.getElementById('discover-content').classList.remove('hidden');

        await initDiscoverMap();
        await searchNearbyStores();

      } catch (err) {
        console.error('Location detection failed:', err);
        user.toast('Could not detect location. Please set your address in Profile.', 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalContent;
      }
    }

    async function initDiscoverMap() {
      if (!mapsApi.isLoaded) {
        await mapsApi.init();
      }

      if (!discoverMap) {
        discoverMap = mapsApi.createMap('discover-map', {
          center: currentDiscoverLocation,
          zoom: 13
        });
      } else {
        discoverMap.setCenter(currentDiscoverLocation);
      }

      if (userLocationMarker) userLocationMarker.setMap(null);
      userLocationMarker = mapsApi.addMarker(discoverMap, currentDiscoverLocation, {
        icon: mapsApi.createIcon('user'),
        title: 'Your location'
      });

      await loadExistingStoreIds();
    }

    async function loadExistingStoreIds() {
      try {
        var response = await storesApi.list({ limit: 100 });
        existingStoreIds.clear();
        var stores = Array.isArray(response && response.data) ? response.data : (Array.isArray(response) ? response : []);
        for (var i = 0; i < stores.length; i++) {
          var store = stores[i];
          if (store.google_place_id) {
            existingStoreIds.add(store.google_place_id);
          }
          if (store.name && store.zip_code) {
            existingStoreIds.add(store.name.toLowerCase() + '_' + store.zip_code);
          }
        }
      } catch (err) {
        console.error('Failed to load existing stores:', err);
      }
    }

    async function searchNearbyStores() {
      var resultsContainer = document.getElementById('discover-results');
      resultsContainer.innerHTML = '<div class="discover-loading"><div class="spinner"></div> Searching for stores...</div>';

      var radius = parseInt(document.getElementById('discover-radius').value);

      try {
        var response = await mapsApi.findNearbyStores(
          currentDiscoverLocation.lat,
          currentDiscoverLocation.lng,
          radius
        );

        discoveredStores = Array.isArray(response && response.data) ? response.data : (response && response.stores ? response.stores : (response && response.results ? response.results : []));
        clearDiscoverMarkers();

        for (var i = 0; i < discoveredStores.length; i++) {
          var store = discoveredStores[i];
          var lat = store.latitude || (store.geometry && store.geometry.location && store.geometry.location.lat);
          var lng = store.longitude || (store.geometry && store.geometry.location && store.geometry.location.lng);

          if (lat && lng) {
            var marker = mapsApi.addMarker(discoverMap,
              { lat: lat, lng: lng },
              {
                icon: mapsApi.createIcon(checkIfStoreExists(store) ? 'store-selected' : 'store'),
                title: store.name
              }
            );

            (function(index) {
              marker.addListener('click', function() { highlightStore(index); });
            })(i);
            discoverMarkers.push(marker);
          }
        }

        if (discoveredStores.length > 0) {
          var positions = [currentDiscoverLocation];
          for (var j = 0; j < discoveredStores.length; j++) {
            var s = discoveredStores[j];
            var sLat = s.latitude || (s.geometry && s.geometry.location && s.geometry.location.lat);
            var sLng = s.longitude || (s.geometry && s.geometry.location && s.geometry.location.lng);
            if (sLat && sLng) {
              positions.push({ lat: sLat, lng: sLng });
            }
          }
          mapsApi.fitBounds(discoverMap, positions);
        }

        renderDiscoverResults();

      } catch (err) {
        console.error('Store search failed:', err);
        resultsContainer.innerHTML = '<div class="discover-error">' +
          '<p>Failed to search for stores.</p>' +
          '<button class="btn btn-secondary btn-sm" onclick="searchNearbyStores()">Try Again</button>' +
        '</div>';
      }
    }

    function renderDiscoverResults() {
      var container = document.getElementById('discover-results');
      document.getElementById('discover-count').textContent = discoveredStores.length + ' stores found';

      if (discoveredStores.length === 0) {
        container.innerHTML = '<div class="discover-empty">' +
          '<p>No grocery stores found in this area.</p>' +
          '<p>Try increasing the search radius.</p>' +
        '</div>';
        return;
      }

      var html = '';
      for (var i = 0; i < discoveredStores.length; i++) {
        var store = discoveredStores[i];
        var isExisting = checkIfStoreExists(store);

        html += '<div class="discover-store-card' + (isExisting ? ' existing' : '') + '" data-index="' + i + '" onclick="highlightStore(' + i + ')">';
        html += '<div class="discover-store-number">' + (i + 1) + '</div>';
        html += '<div class="discover-store-info">';
        html += '<div class="discover-store-name">' + escapeHtml(store.name) + '</div>';
        html += '<div class="discover-store-address">' + escapeHtml(store.formatted_address || store.address || store.vicinity || '') + '</div>';
        if (store.rating) {
          html += '<div class="discover-store-rating">';
          html += '<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>';
          html += store.rating.toFixed(1);
          html += '</div>';
        }
        html += '</div>';
        html += '<div class="discover-store-actions">';
        if (isExisting) {
          html += '<span class="discover-badge discover-badge-exists">Already Added</span>';
        } else {
          html += '<button class="btn btn-primary btn-sm" onclick="addDiscoveredStore(' + i + ', event)">Add Store</button>';
        }
        html += '</div>';
        html += '</div>';
      }

      container.innerHTML = html;
    }

    function highlightStore(index) {
      if (discoverMarkers[index]) {
        discoverMarkers[index].setAnimation(google.maps.Animation.BOUNCE);
        setTimeout(function() { discoverMarkers[index].setAnimation(null); }, 1500);
      }

      var cards = document.querySelectorAll('.discover-store-card');
      for (var i = 0; i < cards.length; i++) {
        cards[i].classList.toggle('active', i === index);
      }

      var store = discoveredStores[index];
      var lat = store.latitude || (store.geometry && store.geometry.location && store.geometry.location.lat);
      var lng = store.longitude || (store.geometry && store.geometry.location && store.geometry.location.lng);
      if (lat && lng) {
        discoverMap.panTo({ lat: lat, lng: lng });
      }

      var activeCard = document.querySelector('.discover-store-card.active');
      if (activeCard) {
        activeCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    }

    async function addDiscoveredStore(index, event) {
      event.stopPropagation();

      var store = discoveredStores[index];
      var btn = event.target;
      var originalText = btn.textContent;

      try {
        btn.disabled = true;
        btn.textContent = 'Adding...';

        var details = store;
        if (store.place_id) {
          try {
            var response = await mapsApi.getPlaceDetails(store.place_id);
            details = response && response.data ? response.data : (response || store);
          } catch (err) {
            console.warn('Could not fetch place details, using basic info');
          }
        }

        await storesApi.create({
          name: details.name || store.name,
          street_address: details.street_address || store.address || store.vicinity || '',
          city: details.city || '',
          state: details.state || '',
          zip_code: details.zip_code || '',
          latitude: details.latitude || store.latitude || (store.geometry && store.geometry.location && store.geometry.location.lat),
          longitude: details.longitude || store.longitude || (store.geometry && store.geometry.location && store.geometry.location.lng),
          store_type: determineStoreType(store.types || []),
          chain: extractChainName(store.name),
          google_place_id: store.place_id || null
        });

        user.toast(store.name + ' added successfully!', 'success');

        btn.textContent = 'Added!';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-success');
        btn.disabled = true;

        if (store.place_id) existingStoreIds.add(store.place_id);

        var card = btn.closest('.discover-store-card');
        if (card) card.classList.add('existing');

        if (discoverMarkers[index]) {
          discoverMarkers[index].setIcon(mapsApi.createIcon('store-selected'));
        }

        loadStores(1);

      } catch (err) {
        console.error('Failed to add store:', err);
        user.toast('Failed to add store: ' + (err.message || 'Unknown error'), 'error');
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    function checkIfStoreExists(googleStore) {
      if (googleStore.place_id && existingStoreIds.has(googleStore.place_id)) {
        return true;
      }
      var name = googleStore.name ? googleStore.name.toLowerCase() : null;
      var zip = googleStore.zip_code;
      if (name && zip && existingStoreIds.has(name + '_' + zip)) {
        return true;
      }
      return false;
    }

    function determineStoreType(types) {
      if (!types || !Array.isArray(types)) return 'grocery';
      if (types.indexOf('supermarket') >= 0) return 'supermarket';
      if (types.indexOf('grocery_or_supermarket') >= 0) return 'grocery';
      if (types.indexOf('convenience_store') >= 0) return 'convenience';
      if (types.indexOf('department_store') >= 0) return 'department';
      return 'grocery';
    }

    function extractChainName(storeName) {
      if (!storeName) return null;
      var chains = [
        'Walmart', 'Target', 'Kroger', 'Safeway', 'Albertsons',
        'King Soopers', 'Publix', 'H-E-B', 'Whole Foods', "Trader Joe's",
        'Costco', "Sam's Club", 'Aldi', 'Lidl', 'Sprouts', 'Natural Grocers',
        'Save-A-Lot', 'Food Lion', 'Giant', 'Stop & Shop', 'Wegmans', 'WinCo'
      ];

      var lowerName = storeName.toLowerCase();
      for (var i = 0; i < chains.length; i++) {
        if (lowerName.indexOf(chains[i].toLowerCase()) >= 0) {
          return chains[i];
        }
      }
      return null;
    }

    function clearDiscoverMarkers() {
      for (var i = 0; i < discoverMarkers.length; i++) {
        discoverMarkers[i].setMap(null);
      }
      discoverMarkers = [];
    }

    function refreshDiscoverSearch() {
      searchNearbyStores();
    }

    function escapeHtml(text) {
      if (!text) return '';
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
